{"url":"https://api.github.com/repos/redis/redis/issues/607","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/607/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/607/comments","events_url":"https://api.github.com/repos/redis/redis/issues/607/events","html_url":"https://github.com/redis/redis/issues/607","id":5902267,"node_id":"MDU6SXNzdWU1OTAyMjY3","number":607,"title":"Node of redis-cluster dies with certain sequences of commands","user":{"login":"nrk","id":17923,"node_id":"MDQ6VXNlcjE3OTIz","avatar_url":"https://avatars.githubusercontent.com/u/17923?v=4","gravatar_id":"","url":"https://api.github.com/users/nrk","html_url":"https://github.com/nrk","followers_url":"https://api.github.com/users/nrk/followers","following_url":"https://api.github.com/users/nrk/following{/other_user}","gists_url":"https://api.github.com/users/nrk/gists{/gist_id}","starred_url":"https://api.github.com/users/nrk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nrk/subscriptions","organizations_url":"https://api.github.com/users/nrk/orgs","repos_url":"https://api.github.com/users/nrk/repos","events_url":"https://api.github.com/users/nrk/events{/privacy}","received_events_url":"https://api.github.com/users/nrk/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null},{"id":1198954,"node_id":"MDU6TGFiZWwxMTk4OTU0","url":"https://api.github.com/repos/redis/redis/labels/crash%20report","name":"crash report","color":"e10c02","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2012-07-29T09:06:09Z","updated_at":"2013-02-15T11:01:51Z","closed_at":"2013-02-15T11:01:51Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\n\nWhile playing with redis-cluster today I noticed that certain sequences of commands can make a node of the cluster die. The OS is a Linux 32bit VM (full details are in the dump at the end of this ticket) and the cluster is composed of three nodes configured as follow:\n\n```\n./redis-trib.rb create 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381\n```\n\nThis is the sequence of commands that always make the node fail (the key `foobar` is in the slot covered by node `127.0.0.1:6379`):\n\n```\nredis 127.0.0.1:6379> SET foobar test\nOK\nredis 127.0.0.1:6379> MGET foo foobar\n(error) ERR Multi keys request invalid in cluster\nredis 127.0.0.1:6379> GETRANGE foobar 0 1\n(error) MOVED 1650 127.0.0.1:6380\nredis 127.0.0.1:6379> GETRANGE foobar 0 1\n(error) ERR unknown command ''\nredis 127.0.0.1:6379> GETRANGE foobar 0 1\nCould not connect to Redis at 127.0.0.1:6379: Connection refused\n```\n\nThe thing I noticed is that the node starts acting strange only after issuing `MGET` with multiple keys, which returns a `-ERR` as one would expect, but only certain commands make the node fail after that one: for example it crashes with `GETRANGE` or `SETRANGE`, but `GET` or `EXISTS` seem to work normally returning the expected results. In the majority of cases the node crashed at the third `GETRANGE` request, but there were times when the node crashed instantly.\n\nThis is the dump generated by the failing node when issuing `GETRANGE` three times:\n\n```\n[12830] 29 Jul 10:17:04.321 #     Redis 2.9.7 crashed by signal: 11\n[12830] 29 Jul 10:17:04.321 #     Failed assertion: <no assertion failed> (<no file>:0)\n[12830] 29 Jul 10:17:04.321 # --- STACK TRACE\n./redis-server(logStackTrace+0x71)[0x8083ad1]\n/lib/i386-linux-gnu/libc.so.6(+0x11c2cb)[0xf8f2cb]\n[0x63740c]\n/lib/i386-linux-gnu/libc.so.6(+0x11c2cb)[0xf8f2cb]\n./redis-server(sdscatlen+0x45)[0x805f085]\n./redis-server(sdscat+0x24)[0x805f0d4]\n./redis-server(sdscatvprintf+0x90)[0x805f250]\n./redis-server(sdscatprintf+0x1f)[0x805f28f]\n./redis-server(processCommand+0x16e)[0x805dcee]\n./redis-server(processInputBuffer+0x47)[0x8066077]\n./redis-server(readQueryFromClient+0x9d)[0x806618d]\n./redis-server(aeProcessEvents+0x140)[0x8057ac0]\n./redis-server(aeMain+0x2c)[0x8057dbc]\n./redis-server(main+0x299)[0x8056c99]\n/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0xe8c113]\n./redis-server[0x8056e09]\n[12830] 29 Jul 10:17:04.323 # --- INFO OUTPUT\n[12830] 29 Jul 10:17:04.324 # # Server\nredis_version:2.9.7\nredis_git_sha1:7f5bdba4\nredis_git_dirty:0\nos:Linux 3.0.0-23-generic i686\narch_bits:32\nmultiplexing_api:epoll\ngcc_version:4.6.1\n\nprocess_id:12830\nrun_id:98a0dab99bb6b8ae9e52b789093a3813845c9fca\ntcp_port:6379\nuptime_in_seconds:24\nuptime_in_days:0\nlru_clock:137254\n\n# Clients\nconnected_clients:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\n\n# Memory\nused_memory:450480\nused_memory_human:439.92K\nused_memory_rss:1855488\nused_memory_peak:449536\nused_memory_peak_human:439.00K\nused_memory_lua:20480\nmem_fragmentation_ratio:4.12\nmem_allocator:jemalloc-2.2.5\n\n# Persistence\nloading:0\nrdb_changes_since_last_save:3\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1343549800\nrdb_last_bgsave_status:ok\nrdb_last_bgsave_time_sec:-1\nrdb_current_bgsave_time_sec:-1\naof_enabled:0\naof_rewrite_in_progress:0\naof_rewrite_scheduled:0\naof_last_rewrite_time_sec:-1\naof_current_rewrite_time_sec:-1\naof_last_bgrewrite_status:ok\n\n# Stats\ntotal_connections_received:1\ntotal_commands_processed:2\ninstantaneous_ops_per_sec:0\nrejected_connections:0\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:0\nkeyspace_misses:0\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:0\n\n# Replication\nrole:master\nconnected_slaves:0\n\n# CPU\nused_cpu_sys:0.06\nused_cpu_user:0.09\nused_cpu_sys_children:0.00\nused_cpu_user_children:0.00\n\n# Commandstats\ncmdstat_set:calls=1,usec=22,usec_per_call=22.00\ncmdstat_flushall:calls=1,usec=11,usec_per_call=11.00\n\n# Cluster\ncluster_enabled:1\n\n# Keyspace\ndb0:keys=1,expires=0\nhash_init_value: 1343233146\n\n[12830] 29 Jul 10:17:04.324 # --- CLIENT LIST OUTPUT\n[12830] 29 Jul 10:17:04.324 # addr=127.0.0.1:54910 fd=11 age=20 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 ob\nl=0 oll=0 omem=0 events=r cmd=getrange\n\n[12830] 29 Jul 10:17:04.324 # --- CURRENT CLIENT INFO\n\n[12830] 29 Jul 10:17:04.325 # client: addr=127.0.0.1:54910 fd=11 age=20 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=\n32768 obl=0 oll=0 omem=0 events=r cmd=getrange\n[12830] 29 Jul 10:17:04.325 # argv[0]: 'GETRANGE'\n[12830] 29 Jul 10:17:04.325 # argv[1]: '1'\n[12830] 29 Jul 10:17:04.325 # argv[2]: ''\n[12830] 29 Jul 10:17:04.325 # argv[3]: '1'\n[12830] 29 Jul 10:17:04.325 # --- REGISTERS\n[12830] 29 Jul 10:17:04.325 # \nEAX:b684f200 EBX:00f8f2c8 ECX:0a0d3038 EDX:0cd42f45\nEDI:564f4d49 ESI:0000001c EBP:bfea2548 ESP:bfea2498\nSS :0000007b EFL:bfea2498 EIP:00f8f2cb CS:00000073\nDS :0000007b ES :ffff007b FS :c1530000 GS:00000033\n[12830] 29 Jul 10:17:04.325 # (bfea24d4) -> b684f21e\n[12830] 29 Jul 10:17:04.325 # (bfea24d0) -> 00000020\n[12830] 29 Jul 10:17:04.325 # (bfea24cc) -> b684f200\n[12830] 29 Jul 10:17:04.325 # (bfea24c8) -> 0000001c\n[12830] 29 Jul 10:17:04.325 # (bfea24c4) -> b684f200\n[12830] 29 Jul 10:17:04.325 # (bfea24c0) -> b684e218\n[12830] 29 Jul 10:17:04.325 # (bfea24bc) -> 0805f0d4\n[12830] 29 Jul 10:17:04.325 # (bfea24b8) -> b684f21e\n[12830] 29 Jul 10:17:04.325 # (bfea24b4) -> 00000020\n[12830] 29 Jul 10:17:04.325 # (bfea24b0) -> b684f200\n[12830] 29 Jul 10:17:04.325 # (bfea24ac) -> b688a000\n[12830] 29 Jul 10:17:04.325 # (bfea24a8) -> 0000001c\n[12830] 29 Jul 10:17:04.325 # (bfea24a4) -> b684f200\n[12830] 29 Jul 10:17:04.325 # (bfea24a0) -> 0cd42f45\n[12830] 29 Jul 10:17:04.325 # (bfea249c) -> 0805f085\n[12830] 29 Jul 10:17:04.325 # (bfea2498) -> b684e218\n[12830] 29 Jul 10:17:04.325 # \n```\n\nAnd this is the dump generated when just the first `GETRANGE` made the node crash (note that the stack trace is different and the generated dump is incomplete):\n\n```\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\n[21541] 29 Jul 10:52:23.419 #     Redis 2.9.7 crashed by signal: 11\n[21541] 29 Jul 10:52:23.419 #     Failed assertion: <no assertion failed> (<no file>:0)\n[21541] 29 Jul 10:52:23.419 # --- STACK TRACE\n./redis-server(logStackTrace+0x71)[0x8083ad1]\n./redis-server(decrRefCount+0x8)[0x8067e38]\n[0x52440c]\n./redis-server(decrRefCount+0x8)[0x8067e38]\n./redis-server[0x8064121]\n./redis-server(resetClient+0xf)[0x8064cff]\n./redis-server(processInputBuffer+0x53)[0x8066083]\n./redis-server(readQueryFromClient+0x9d)[0x806618d]\n./redis-server(aeProcessEvents+0x140)[0x8057ac0]\n./redis-server(aeMain+0x2c)[0x8057dbc]\n./redis-server(main+0x299)[0x8056c99]\n/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0x129113]\n./redis-server[0x8056e09]\n[21541] 29 Jul 10:52:23.420 # --- INFO OUTPUT\n[21541] 29 Jul 10:52:23.421 # # Server\nredis_version:2.9.7\nredis_git_sha1:7f5bdba4\nredis_git_dirty:0\nos:Linux 3.0.0-23-generic i686\narch_bits:32\nmultiplexing_api:epoll\ngcc_version:4.6.1\nprocess_id:21541\nrun_id:941c7e3e94b8f568179fecd9e15b0703ad162564\ntcp_port:6379\nuptime_in_seconds:105\nuptime_in_days:0\nlru_clock:137466\n# Clients\nconnected_clients:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\n\n# Memory\nused_memory:450368\nused_memory_human:439.81K\nused_memory_rss:1859584\nused_memory_peak:449536\nused_memory_peak_human:439.00K\nused_memory_lua:20480\nmem_fragmentation_ratio:4.13\nmem_allocator:jemalloc-2.2.5\n\n# Persistence\nloading:0\nrdb_changes_since_last_save:8\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1343551838\nrdb_last_bgsave_status:ok\nrdb_last_bgsave_time_sec:-1\nrdb_current_bgsave_time_sec:-1\naof_enabled:0\naof_rewrite_in_progress:0\naof_rewrite_scheduled:0\naof_last_rewrite_time_sec:-1\naof_current_rewrite_time_sec:-1\naof_last_bgrewrite_status:ok\n\n# Stats\ntotal_connections_received:2\ntotal_commands_processed:10\ninstantaneous_ops_per_sec:0\nrejected_connections:0\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:3\nkeyspace_misses:0\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:0\n\n# Replication\nrole:master\nconnected_slaves:0\n\n# CPU\nused_cpu_sys:0.26\nused_cpu_user:0.17\nused_cpu_sys_children:0.00\nused_cpu_user_children:0.00\n\n# Commandstats\ncmdstat_set:calls=2,usec=27,usec_per_call=13.50\ncmdstat_append:calls=4,usec=23,usec_per_call=5.75\ncmdstat_strlen:calls=1,usec=11,usec_per_call=11.00\ncmdstat_getrange:calls=2,usec=18,usec_per_call=9.00\ncmdstat_flushall:calls=1,usec=10,usec_per_call=10.00\n\n# Cluster\ncluster_enabled:1\n\n# Keyspace\ndb0:keys=1,expires=0\nhash_init_value: 1343988010\n\n[21541] 29 Jul 10:52:23.421 # --- CLIENT LIST OUTPUT\n[21541] 29 Jul 10:52:23.421 # addr=127.0.0.1:56831 fd=11 age=19 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 ob\nl=32 oll=0 omem=0 events=rw cmd=NULL\n\n[21541] 29 Jul 10:52:23.421 # --- CURRENT CLIENT INFO\n[21541] 29 Jul 10:52:23.421 # client: addr=127.0.0.1:56831 fd=11 age=19 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=\n32768 obl=32 oll=0 omem=0 events=rw cmd=NULL\n[1]    21541 segmentation fault  ./redis-server nrk01.conf\n```\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/607/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/607/timeline","performed_via_github_app":null,"state_reason":"completed"}