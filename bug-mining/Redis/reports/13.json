{"url":"https://api.github.com/repos/redis/redis/issues/480","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/480/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/480/comments","events_url":"https://api.github.com/repos/redis/redis/issues/480/events","html_url":"https://github.com/redis/redis/issues/480","id":4283141,"node_id":"MDU6SXNzdWU0MjgzMTQx","number":480,"title":"Bug report, slowlog - EVAL","user":{"login":"a-zb","id":130595,"node_id":"MDQ6VXNlcjEzMDU5NQ==","avatar_url":"https://avatars.githubusercontent.com/u/130595?v=4","gravatar_id":"","url":"https://api.github.com/users/a-zb","html_url":"https://github.com/a-zb","followers_url":"https://api.github.com/users/a-zb/followers","following_url":"https://api.github.com/users/a-zb/following{/other_user}","gists_url":"https://api.github.com/users/a-zb/gists{/gist_id}","starred_url":"https://api.github.com/users/a-zb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/a-zb/subscriptions","organizations_url":"https://api.github.com/users/a-zb/orgs","repos_url":"https://api.github.com/users/a-zb/repos","events_url":"https://api.github.com/users/a-zb/events{/privacy}","received_events_url":"https://api.github.com/users/a-zb/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null},{"id":1198954,"node_id":"MDU6TGFiZWwxMTk4OTU0","url":"https://api.github.com/repos/redis/redis/labels/crash%20report","name":"crash report","color":"e10c02","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/redis/redis/milestones/1","html_url":"https://github.com/redis/redis/milestone/1","labels_url":"https://api.github.com/repos/redis/redis/milestones/1/labels","id":38963,"node_id":"MDk6TWlsZXN0b25lMzg5NjM=","number":1,"title":"Redis 2.6","description":"Redis 2.6, first version of Redis with scripting support.","creator":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":75,"state":"closed","created_at":"2011-09-20T12:59:46Z","updated_at":"2014-12-11T14:54:39Z","due_on":null,"closed_at":"2012-10-05T09:21:16Z"},"comments":7,"created_at":"2012-04-25T15:24:48Z","updated_at":"2012-04-27T14:33:14Z","closed_at":"2012-04-27T14:33:14Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Bug report output: http://pastebin.com/DBFuHzWg\nTo reproduce: use latest github version, run with default options, system is 32 bit\n\nRun: eval \"local a; for b = 1,100000 do redis.call('sadd','set1',b) end return a\" 0\nRun: eval \"local a; for b = 50000,100000 do redis.call('sadd','set2',b) end return a\" 0\n\nSecond command always triggers a crash.\n\nUpdate 1: Changed title from \"Bug report, EVAL\" to include slowlog. It appears it happens during a slow logging of a command. Since above operations are slow, they will hit this code path pretty much every single time. I took the time to compile redis with jemalloc and lib c malloc and it happens just the same. Here is output of  a gdb session:\n\n```\nsudo gdb ./bin/redis-server 9683\nGNU gdb (Ubuntu/Linaro 7.3-0ubuntu2) 7.3-2011.08\nCopyright (C) 2011 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i686-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://bugs.launchpad.net/gdb-linaro/>...\nReading symbols from /home/arek/tools/redis/bin-libc/bin/redis-server...done.\nAttaching to program: /home/arek/tools/redis/bin-libc/bin/redis-server, process 9683\nCannot access memory at address 0x1\nA program is being debugged already.  Kill it? (y or n) n\nProgram not killed.\n(gdb) continue\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x0807d9ab in slowlogCommand (c=0x7eccc399) at slowlog.c:118\n118         listRewind(server.slowlog,&li);\n(gdb) continue\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\n0xb780b424 in ?? ()\n```\n\nUpdate 2: I've seen it crash with this gdb output as well\n\n```\nsudo gdb ../bin/bin-libc/bin/redis-server 10689\nGNU gdb (Ubuntu/Linaro 7.3-0ubuntu2) 7.3-2011.08\nCopyright (C) 2011 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.  Type \"show copying\"\nand \"show warranty\" for details.\nThis GDB was configured as \"i686-linux-gnu\".\nFor bug reporting instructions, please see:\n<http://bugs.launchpad.net/gdb-linaro/>...\nReading symbols from /home/arek/tools/redis/bin/bin-libc/bin/redis-server...done.\nAttaching to program: /home/arek/tools/redis/bin/bin-libc/bin/redis-server, process 10689\nReading symbols from /lib/i386-linux-gnu/libm.so.6...(no debugging symbols found)...done.\nLoaded symbols for /lib/i386-linux-gnu/libm.so.6\nReading symbols from /lib/i386-linux-gnu/libpthread.so.0...(no debugging symbols found)...done.\n[Thread debugging using libthread_db enabled]\n[New Thread 0xb6cfcb70 (LWP 10691)]\n[New Thread 0xb74fdb70 (LWP 10690)]\nLoaded symbols for /lib/i386-linux-gnu/libpthread.so.0\nReading symbols from /lib/i386-linux-gnu/libc.so.6...(no debugging symbols found)...done.\nLoaded symbols for /lib/i386-linux-gnu/libc.so.6\nReading symbols from /lib/ld-linux.so.2...(no debugging symbols found)...done.\nLoaded symbols for /lib/ld-linux.so.2\n0xb770e424 in __kernel_vsyscall ()\n(gdb) continue\nContinuing.\n\nProgram received signal SIGSEGV, Segmentation fault.\nluaMaskCountHook (lua=0x9f81888, ar=0xbfe9e358) at scripting.c:378\n378          aeDeleteFileEvent(server.el, server.lua_caller->fd, AE_READABLE);\n\nbt\n#0  luaMaskCountHook (lua=0x9f81888, ar=0xbfe9e358) at scripting.c:378\n#1  0x08084121 in luaD_callhook ()\n#2  0x0808d826 in luaV_execute ()\n#3  0x080848c8 in luaD_call ()\n#4  0x0808bac4 in callTMres ()\n#5  0x08081ca3 in lua_getfield ()\n#6  0x0807f3a0 in evalGenericCommand (c=0x9f8c274, evalsha=0) at scripting.c:761\n#7  0x0807f7c7 in evalCommand (c=0x9f8c274) at scripting.c:844\n#8  0x0804f4b1 in call (c=0x9f8c274, flags=7) at redis.c:1432\n#9  0x08051880 in processCommand (c=0x9f8c274) at redis.c:1621\n#10 0x08059707 in processInputBuffer (c=0x9f8c274) at networking.c:973\n#11 0x0805981d in readQueryFromClient (el=0x9f4ab2c, fd=5, privdata=0x9f8c274, mask=1) at networking.c:1036\n#12 0x0804b768 in aeProcessEvents (eventLoop=0x9f4ab2c, flags=3) at ae.c:354\n#13 0x0804ba4c in aeMain (eventLoop=0x9f4ab2c) at ae.c:395\n#14 0x0804a934 in main (argc=1, argv=0xbfe9e834) at redis.c:2469\n\n(gdb) info registers\neax            0x0  0\necx            0xb76a6398   -1217764456\nedx            0x0  0\nebx            0x9f81888    167254152\nesp            0xbfe9e310   0xbfe9e310\nebp            0xffffffff   0xffffffff\nesi            0x807d8f0    134732016\nedi            0x60 96\neip            0x807d9cb    0x807d9cb <luaMaskCountHook+219>\neflags         0x10286  [ PF SF IF RF ]\ncs             0x73 115\nss             0x7b 123\nds             0x7b 123\nes             0x7b 123\nfs             0x0  0\ngs             0x33 51\n```\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/480/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/480/timeline","performed_via_github_app":null,"state_reason":"completed"}