{"url":"https://api.github.com/repos/redis/redis/issues/145","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/145/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/145/comments","events_url":"https://api.github.com/repos/redis/redis/issues/145/events","html_url":"https://github.com/redis/redis/issues/145","id":1931203,"node_id":"MDU6SXNzdWUxOTMxMjAz","number":145,"title":"Server crash on failed master/slave sync (refused connection)","user":{"login":"janoberst","id":19206,"node_id":"MDQ6VXNlcjE5MjA2","avatar_url":"https://avatars.githubusercontent.com/u/19206?v=4","gravatar_id":"","url":"https://api.github.com/users/janoberst","html_url":"https://github.com/janoberst","followers_url":"https://api.github.com/users/janoberst/followers","following_url":"https://api.github.com/users/janoberst/following{/other_user}","gists_url":"https://api.github.com/users/janoberst/gists{/gist_id}","starred_url":"https://api.github.com/users/janoberst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janoberst/subscriptions","organizations_url":"https://api.github.com/users/janoberst/orgs","repos_url":"https://api.github.com/users/janoberst/repos","events_url":"https://api.github.com/users/janoberst/events{/privacy}","received_events_url":"https://api.github.com/users/janoberst/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null},{"id":155763,"node_id":"MDU6TGFiZWwxNTU3NjM=","url":"https://api.github.com/repos/redis/redis/labels/WAITING-OP-REPLY","name":"WAITING-OP-REPLY","color":"02d7e1","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2011-10-17T17:30:26Z","updated_at":"2014-05-30T23:10:15Z","closed_at":"2011-10-18T17:59:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Three of my instances (on server 1 and 2) just crashed when I restarted server 3. Instance A was a master to an instance on server 3. Instances B and C were slaves of two instances on server 3.\n\nI'm sorry that I have to be so vague about this. I just found these stackdumps in my logfiles a few minutes after it happened. I believe, instances A,B,C were trying to do some kind of syncing with server 3, which was being restarted at the time. I assume server 3 refused the connections when the instances were in a state where these exceptions weren't handled.\n\nI'm using the fresh 2.4.1 from this morning on Ubuntu Oneiric. Let me know if you need more input.\n\ninstance 1:\n\n```\n[2710] 17 Oct 16:56:25 * MASTER MODE enabled (user request)\n[2710] 17 Oct 16:56:25 * Slave ask for synchronization\n[2710] 17 Oct 16:56:25 * Starting BGSAVE for SYNC\n[2710] 17 Oct 16:56:25 * Background saving started by pid 4019\n[2710] 17 Oct 16:56:27 - DB 0: 91 keys (0 volatile) in 128 slots HT.\n[2710] 17 Oct 16:56:27 - 0 clients connected (1 slaves), 92076368 bytes in use\n[2710] 17 Oct 16:56:30 * Non blocking connect for SYNC fired the event.\n[2710] 17 Oct 16:56:30 # I/O error writing to MASTER: Connection refused\n[2710] 17 Oct 16:56:30 * Connecting to MASTER...\n[2710] 17 Oct 16:56:30 # ======= Ooops! Redis 2.4.1 got signal: -11- =======\n[2710] 17 Oct 16:56:30 # redis_version:2.4.1\nredis_git_sha1:ab648d97\nredis_git_dirty:0\narch_bits:64\nmultiplexing_api:epoll\nprocess_id:2710\nuptime_in_seconds:4920\nuptime_in_days:0\nlru_clock:1863635\nused_cpu_sys:16.91\nused_cpu_user:6.16\nused_cpu_sys_children:0.00\nused_cpu_user_children:0.00\nconnected_clients:0\nconnected_slaves:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\nused_memory:92076368\nused_memory_human:87.81M\nused_memory_rss:96280576\nused_memory_peak:1022465704\nused_memory_peak_human:975.10M\nmem_fragmentation_ratio:1.05\nmem_allocator:jemalloc-2.2.1\nloading:0\naof_enabled:1\nchanges_since_last_save:16060\nbgsave_in_progress:1\nlast_save_time:1318865670\nbgrewriteaof_in_progress:0\ntotal_connections_received:2475\ntotal_commands_processed:13985\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:1204\nkeyspace_misses:9139\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:28578\nvm_enabled:0\nrole:master\naof_current_size:91031534\naof_base_size:0\naof_pending_rewrite:0\ndb0\n[2710] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7f3fc4b64215]\n[2710] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7f3fc4b64215]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server() [0x40ca99]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(connectWithMaster+0x1a) [0x41c14a]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(replicationCron+0xe6) [0x41c416]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(serverCron+0x1c8) [0x40fa78]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(aeProcessEvents+0x1db) [0x40c45b]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(aeMain+0x2e) [0x40c70e]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server(main+0x106) [0x40b606]\n[2710] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xed) [0x7f3fc4a9530d]\n[2710] 17 Oct 16:56:30 # /usr/local/bin/redis-server() [0x40b72d]\n[4019] 17 Oct 16:56:32 * DB saved on disk\n```\n\ninstance 2:\n\n```\n[2698] 17 Oct 16:56:30 * Non blocking connect for SYNC fired the event.\n[2698] 17 Oct 16:56:30 # I/O error writing to MASTER: Connection refused\n[2698] 17 Oct 16:56:30 * Connecting to MASTER...\n[2698] 17 Oct 16:56:30 # ======= Ooops! Redis 2.4.1 got signal: -11- =======\n[2698] 17 Oct 16:56:30 # redis_version:2.4.1\nredis_git_sha1:ab648d97\nredis_git_dirty:0\narch_bits:64\nmultiplexing_api:epoll\nprocess_id:2698\nuptime_in_seconds:4920\nuptime_in_days:0\nlru_clock:1863635\nused_cpu_sys:17.05\nused_cpu_user:6.90\nused_cpu_sys_children:0.14\nused_cpu_user_children:0.62\nconnected_clients:0\nconnected_slaves:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\nused_memory:87061824\nused_memory_human:83.03M\nused_memory_rss:92336128\nused_memory_peak:1018799560\nused_memory_peak_human:971.60M\nmem_fragmentation_ratio:1.06\nmem_allocator:jemalloc-2.2.1\nloading:0\naof_enabled:1\nchanges_since_last_save:0\nbgsave_in_progress:0\nlast_save_time:1318870572\nbgrewriteaof_in_progress:0\ntotal_connections_received:2565\ntotal_commands_processed:13986\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:1034\nkeyspace_misses:8965\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:26442\nvm_enabled:0\nrole:master\naof_current_size:86031167\naof_base_size:0\naof_pending_rewrite:0\ndb0:key\n[2698] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7f402ca77215]\n[2698] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7f402ca77215]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server() [0x40ca99]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(connectWithMaster+0x1a) [0x41c14a]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(replicationCron+0xe6) [0x41c416]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(serverCron+0x1c8) [0x40fa78]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(aeProcessEvents+0x1db) [0x40c45b]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(aeMain+0x2e) [0x40c70e]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server(main+0x106) [0x40b606]\n[2698] 17 Oct 16:56:30 # /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xed) [0x7f402c9a830d]\n[2698] 17 Oct 16:56:30 # /usr/local/bin/redis-server() [0x40b72d]\n```\n\ninstance 3:\n\n```\n[2684] 17 Oct 16:56:31 * Non blocking connect for SYNC fired the event.\n[2684] 17 Oct 16:56:31 # I/O error writing to MASTER: Connection refused\n[2684] 17 Oct 16:56:31 * Connecting to MASTER...\n[2684] 17 Oct 16:56:31 # ======= Ooops! Redis 2.4.1 got signal: -11- =======\n[2684] 17 Oct 16:56:31 # redis_version:2.4.1\nredis_git_sha1:ab648d97\nredis_git_dirty:0\narch_bits:64\nmultiplexing_api:epoll\nprocess_id:2684\nuptime_in_seconds:4916\nuptime_in_days:0\nlru_clock:1863635\nused_cpu_sys:28.23\nused_cpu_user:8.24\nused_cpu_sys_children:1.48\nused_cpu_user_children:6.89\nconnected_clients:0\nconnected_slaves:1\nclient_longest_output_list:0\nclient_biggest_input_buf:0\nblocked_clients:0\nused_memory:87061960\nused_memory_human:83.03M\nused_memory_rss:91430912\nused_memory_peak:1018693576\nused_memory_peak_human:971.50M\nmem_fragmentation_ratio:1.05\nmem_allocator:jemalloc-2.2.1\nloading:0\naof_enabled:1\nchanges_since_last_save:0\nbgsave_in_progress:0\nlast_save_time:1318870582\nbgrewriteaof_in_progress:0\ntotal_connections_received:2710\ntotal_commands_processed:14067\nexpired_keys:0\nevicted_keys:0\nkeyspace_hits:1023\nkeyspace_misses:8950\npubsub_channels:0\npubsub_patterns:0\nlatest_fork_usec:27831\nvm_enabled:0\nrole:master\naof_current_size:86031166\naof_base_size:0\naof_pending_rewrite:0\ndb0:key\n[2684] 17 Oct 16:56:31 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7fd1abedb215]\n[2684] 17 Oct 16:56:31 # /lib/x86_64-linux-gnu/libc.so.6(inet_aton+0x35) [0x7fd1abedb215]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server() [0x40ca99]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(connectWithMaster+0x1a) [0x41c14a]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(replicationCron+0xe6) [0x41c416]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(serverCron+0x1c8) [0x40fa78]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(aeProcessEvents+0x1db) [0x40c45b]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(aeMain+0x2e) [0x40c70e]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server(main+0x106) [0x40b606]\n[2684] 17 Oct 16:56:31 # /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xed) [0x7fd1abe0c30d]\n[2684] 17 Oct 16:56:31 # /usr/local/bin/redis-server() [0x40b72d]\n```\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/145/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/145/timeline","performed_via_github_app":null,"state_reason":"completed"}