{"url":"https://api.github.com/repos/redis/redis/issues/4278","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/4278/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/4278/comments","events_url":"https://api.github.com/repos/redis/redis/issues/4278/events","html_url":"https://github.com/redis/redis/issues/4278","id":254437107,"node_id":"MDU6SXNzdWUyNTQ0MzcxMDc=","number":4278,"title":"Potential Buffer Overflow from user-controllable Array Index value","user":{"login":"kirit1193","id":5624097,"node_id":"MDQ6VXNlcjU2MjQwOTc=","avatar_url":"https://avatars.githubusercontent.com/u/5624097?v=4","gravatar_id":"","url":"https://api.github.com/users/kirit1193","html_url":"https://github.com/kirit1193","followers_url":"https://api.github.com/users/kirit1193/followers","following_url":"https://api.github.com/users/kirit1193/following{/other_user}","gists_url":"https://api.github.com/users/kirit1193/gists{/gist_id}","starred_url":"https://api.github.com/users/kirit1193/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kirit1193/subscriptions","organizations_url":"https://api.github.com/users/kirit1193/orgs","repos_url":"https://api.github.com/users/kirit1193/repos","events_url":"https://api.github.com/users/kirit1193/events{/privacy}","received_events_url":"https://api.github.com/users/kirit1193/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2017-08-31T19:06:03Z","updated_at":"2019-10-20T03:45:41Z","closed_at":"2017-10-31T08:54:47Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The _clusterLoadConfig_ function within _/redis/src/cluster.c_ seems to allow for a Buffer Overflow vulnerability leading from an array index being set from user-controllable input. The vulnerable code is:\r\n\r\n```\r\ndirection = p[1]; /* Either '>' or '<' */\r\nslot = atoi(argv[j]+1);\r\np += 3;\r\ncn = clusterLookupNode(p);\r\nif (!cn) {\r\n   cn = createClusterNode(p,0);\r\n   clusterAddNode(cn);\r\n   }\r\nif (direction == '>') {\r\n   server.cluster->migrating_slots_to[slot] = cn;\r\n} else {\r\n   server.cluster->importing_slots_from[slot] = cn;\r\n}\r\n```\r\n\r\nAs we can see, the _slot_ variable is receiving the output of atoi being run here: `slot = atoi(argv[j]+1);`\r\n\r\nNow, _argv[j]_ is basically the arguments of each line (stored in _line[]_) being put into the array using _sdssplitargs_ for further processing.\r\n\r\nThe slot value, after being extracted is then used in the _if-else_ block which controls the slot migration, i.e. `server.cluster->migrating_slots_to[slot] = cn;` and `server.cluster->importing_slots_from[slot] = cn;`.\r\n\r\nIt is safe to assume that a user won't try to put in invalid slot numbers in the cluster configuration file. However, an attacker with limited access to the machine would be able to trigger memory corruption issues or even potentially execute code by forcing an Array Index out of Bounds exception from happening due to invalid values of _slot_. There should be some validation on the value of _slot_ and the maximum length of the _migrating_slots_to_ and _migrating_slots_from_ arrays.","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/4278/reactions","total_count":3,"+1":3,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/4278/timeline","performed_via_github_app":null,"state_reason":"completed"}