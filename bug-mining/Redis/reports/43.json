{"url":"https://api.github.com/repos/redis/redis/issues/1525","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/1525/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/1525/comments","events_url":"https://api.github.com/repos/redis/redis/issues/1525/events","html_url":"https://github.com/redis/redis/issues/1525","id":26294242,"node_id":"MDU6SXNzdWUyNjI5NDI0Mg==","number":1525,"title":"EVAL replicated + conditionals about key existence = replication bug.","user":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":7,"created_at":"2014-01-25T15:02:59Z","updated_at":"2017-07-15T13:04:10Z","closed_at":"2017-07-15T13:04:10Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Lua scripts may contain conditionals in order to run or not commands depending on the existence or not of keys. For example let's examine the following Lua script:\n\n```\nif redis.call(\"exists\",KEYS[1]) == 1\nthen\n    redis.call(\"incr\",\"mycounter\")\nend\n\nif redis.call(\"exists\",KEYS[1]) == 1\nthen\n    return redis.call(\"incr\",\"mycounter\")\nend\n```\n\nThe script executes two times the same _if key exists then increment counter_ logic. However the two executions will work differently in the master and the slaves.\n\nIn the master the first time the key may still exist, while the second time the key may no longer exist. This will result in the key incremented just one time. However as a side effect the master will generate a synthetic `DEL` command in the replication channel in order to force the slaves to expire the key (given that key expiration is master-driven).\n\nWhen the same script will run in the slave, the key will no longer be there, so the script will not increment the key.\n\nI reproduced the bug using the above Lua script and the following bash script:\n\n``` #!/bin/bash\nwhile [ 1 ]\ndo\n    redis-cli set x foo px 100 > /dev/null\n    sleep 0.092\n    redis-cli --eval /tmp/myscript.lua x > /dev/null\n    sleep 0.1\n    redis-cli get mycounter\n    redis-cli -p 6380 get mycounter\ndone\n```\n\nAfter a few iterations the two counters will desynchronized.\n## Proposed fix\n\nMy guess is that the best way to fix this issue is:\n- Don't expire keys when the client performing the lookup is flagged as being a Lua script.\n- However before the script execution, run the expireIfNeeded() function against all the elements in the KEYS[] array (that is, the keys passed to the script).\n\nNote that the second step is not required to guarantee consistency, but is required to guarantee a behavior that makes sense, that is, to expire keys ASAP when possible as the rest of the Redis semantics does.\n\nAn alternative way to address the problem is to replicate raw commands as proposed multiple times. Let's say that I don't believe this alone is sufficient to bias me towards this extreme solution (extreme as it will make Lua scripting bound to the replication link bandwidth), but it is true that this new bug adds some value to this alternative replication model for scripts.\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/1525/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/1525/timeline","performed_via_github_app":null,"state_reason":"completed"}