{"url":"https://api.github.com/repos/redis/redis/issues/142","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/142/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/142/comments","events_url":"https://api.github.com/repos/redis/redis/issues/142/events","html_url":"https://github.com/redis/redis/issues/142","id":1924465,"node_id":"MDU6SXNzdWUxOTI0NDY1","number":142,"title":"AOF ignores FLUSHALL","user":{"login":"janoberst","id":19206,"node_id":"MDQ6VXNlcjE5MjA2","avatar_url":"https://avatars.githubusercontent.com/u/19206?v=4","gravatar_id":"","url":"https://api.github.com/users/janoberst","html_url":"https://github.com/janoberst","followers_url":"https://api.github.com/users/janoberst/followers","following_url":"https://api.github.com/users/janoberst/following{/other_user}","gists_url":"https://api.github.com/users/janoberst/gists{/gist_id}","starred_url":"https://api.github.com/users/janoberst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/janoberst/subscriptions","organizations_url":"https://api.github.com/users/janoberst/orgs","repos_url":"https://api.github.com/users/janoberst/repos","events_url":"https://api.github.com/users/janoberst/events{/privacy}","received_events_url":"https://api.github.com/users/janoberst/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2011-10-17T02:12:48Z","updated_at":"2011-10-17T15:07:07Z","closed_at":"2011-10-17T08:32:31Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I fill up my Redis instance, issue a FLUSHALL and shortly after that restart the machine (through upstart with SIGTERM). After the reboot, Redis will start and load the AOF. But it will not replay the FLUSHALL command, and therefore report to duty with all the data loaded again.\n\nThe docs say \"When you restart Redis it will re-play the AOF to rebuild the state.\" Therefore I thought it would honor the FLUSHALL command, too, and end up with an empty DB. I have limited memory and just throw away my whole database regularly via FLUSHALL. If it crashes after a while, I'm unable to recover the append-only file because it just contains way too much data. Note, that AOF rewrites don't compact anything here, either.\n\nI am using 2.4.0. All save points are deactivated, I only use appendfsync on everysec. If I deactivate AOF, everything is fine, and the dump.rdb files are empty after I call FLUSHALL, then SAVE, and then restart.\n\nHere's the logfile. Notice how memory usage goes from 87896904 to 717616 because of the FLUSHALL, but then goes back to 87896824:\n\n```\n[977] 16 Oct 23:12:32 - 0 clients connected (0 slaves), 87896904 bytes in use\n[977] 16 Oct 23:12:32 - Accepted 127.0.0.1:36209\n[977] 16 Oct 23:12:32 * DB saved on disk\n[977] 16 Oct 23:12:33 - Client closed connection\n[977] 16 Oct 23:12:37 - 0 clients connected (0 slaves), 717616 bytes in use\n[977] 16 Oct 23:12:40 # Received SIGTERM, scheduling shutdown...\n[977] 16 Oct 23:12:40 # User requested shutdown...\n[977] 16 Oct 23:12:40 * Calling fsync() on the AOF file.\n[977] 16 Oct 23:12:40 # Redis is now ready to exit, bye bye...\n\n( system reboot )\n\n[985] 16 Oct 23:13:05 * Server started, Redis version 2.4.0\n[985] 16 Oct 23:13:05 * DB saved on disk\n[985] 16 Oct 23:13:36 * DB loaded from append only file: 31 seconds\n[985] 16 Oct 23:13:36 * The server is now ready to accept connections on port 10001\n[985] 16 Oct 23:13:37 - DB 0: 820 keys (0 volatile) in 1024 slots HT.\n[985] 16 Oct 23:13:37 - 0 clients connected (0 slaves), 87896824 bytes in use\n```\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/142/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/142/timeline","performed_via_github_app":null,"state_reason":"completed"}