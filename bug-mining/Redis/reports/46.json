{"url":"https://api.github.com/repos/redis/redis/issues/14218","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/14218/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/14218/comments","events_url":"https://api.github.com/repos/redis/redis/issues/14218/events","html_url":"https://github.com/redis/redis/issues/14218","id":3256914802,"node_id":"I_kwDOAAJhcs7CIJNy","number":14218,"title":"[BUG] HINCRBYFLOAT on HFE field removes field expiration on replica","user":{"login":"ShooterIT","id":18362176,"node_id":"MDQ6VXNlcjE4MzYyMTc2","avatar_url":"https://avatars.githubusercontent.com/u/18362176?v=4","gravatar_id":"","url":"https://api.github.com/users/ShooterIT","html_url":"https://github.com/ShooterIT","followers_url":"https://api.github.com/users/ShooterIT/followers","following_url":"https://api.github.com/users/ShooterIT/following{/other_user}","gists_url":"https://api.github.com/users/ShooterIT/gists{/gist_id}","starred_url":"https://api.github.com/users/ShooterIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShooterIT/subscriptions","organizations_url":"https://api.github.com/users/ShooterIT/orgs","repos_url":"https://api.github.com/users/ShooterIT/repos","events_url":"https://api.github.com/users/ShooterIT/events{/privacy}","received_events_url":"https://api.github.com/users/ShooterIT/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2215212793,"node_id":"MDU6TGFiZWwyMjE1MjEyNzkz","url":"https://api.github.com/repos/redis/redis/labels/class:bug","name":"class:bug","color":"a0ce44","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2025-07-23T15:54:46Z","updated_at":"2025-07-30T11:40:59Z","closed_at":"2025-07-30T11:40:59Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\n\nWhen executing `HINCRBYFLOAT` on a field of HFE, the expiration time of that field is removed on the replica, even though the master retains it. This leads to an inconsistency between master and replica.\n\n**To reproduce**\n\n- master\n```\n127.0.0.1:6379> hset hash f1 1\n(integer) 1\n127.0.0.1:6379> hexpire hash 200 fields 1 f1\n1) (integer) 1\n127.0.0.1:6379> hincrbyfloat hash f1 1\n\"2\"\n127.0.0.1:6379> HTTL hash fields 1 f1\n1) (integer) 187\n```\n\n- replica\n```\n127.0.0.1:6380> httl hash fields 1 f1  <== after hexpire\n1) (integer) 197\n127.0.0.1:6380> httl hash fields 1 f1 <== after hincrbyfloat\n1) (integer) -1\n```\n\n**Expected behavior**\n\nField expiration metadata should be preserved on the replica after HINCRBYFLOAT\n\n**Additional information**\n\nthe root cause is that we rewrite `HINCRBYFLOAT` to `HSET` after executing `HINCRBYFLOAT`\n\nhttps://github.com/redis/redis/blob/f6f16746e1d4bc51960158d9a896e1aa0a2c7dbd/src/t_hash.c#L2565-L2572\n\nmaybe we can use `HSETEX ... KEEPTTL`, but `HSETEX` is introduced from 8.0, the bug should be introduced from 7.4\n","closed_by":{"login":"ShooterIT","id":18362176,"node_id":"MDQ6VXNlcjE4MzYyMTc2","avatar_url":"https://avatars.githubusercontent.com/u/18362176?v=4","gravatar_id":"","url":"https://api.github.com/users/ShooterIT","html_url":"https://github.com/ShooterIT","followers_url":"https://api.github.com/users/ShooterIT/followers","following_url":"https://api.github.com/users/ShooterIT/following{/other_user}","gists_url":"https://api.github.com/users/ShooterIT/gists{/gist_id}","starred_url":"https://api.github.com/users/ShooterIT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ShooterIT/subscriptions","organizations_url":"https://api.github.com/users/ShooterIT/orgs","repos_url":"https://api.github.com/users/ShooterIT/repos","events_url":"https://api.github.com/users/ShooterIT/events{/privacy}","received_events_url":"https://api.github.com/users/ShooterIT/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/14218/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/14218/timeline","performed_via_github_app":null,"state_reason":"completed"}