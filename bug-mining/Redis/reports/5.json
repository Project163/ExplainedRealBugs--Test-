{"url":"https://api.github.com/repos/redis/redis/issues/327","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/327/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/327/comments","events_url":"https://api.github.com/repos/redis/redis/issues/327/events","html_url":"https://github.com/redis/redis/issues/327","id":3092567,"node_id":"MDU6SXNzdWUzMDkyNTY3","number":327,"title":"maxmemory + evicting policy + slaves = death","user":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155760,"node_id":"MDU6TGFiZWwxNTU3NjA=","url":"https://api.github.com/repos/redis/redis/labels/critical%20bug","name":"critical bug","color":"e10c02","default":false,"description":null},{"id":156159,"node_id":"MDU6TGFiZWwxNTYxNTk=","url":"https://api.github.com/repos/redis/redis/labels/state-work-needed","name":"state-work-needed","color":"0b02e1","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/redis/redis/milestones/1","html_url":"https://github.com/redis/redis/milestone/1","labels_url":"https://api.github.com/repos/redis/redis/milestones/1/labels","id":38963,"node_id":"MDk6TWlsZXN0b25lMzg5NjM=","number":1,"title":"Redis 2.6","description":"Redis 2.6, first version of Redis with scripting support.","creator":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":75,"state":"closed","created_at":"2011-09-20T12:59:46Z","updated_at":"2014-12-11T14:54:39Z","due_on":null,"closed_at":"2012-10-05T09:21:16Z"},"comments":13,"created_at":"2012-02-04T07:57:44Z","updated_at":"2012-02-20T16:31:19Z","closed_at":"2012-02-20T16:31:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Pieter Noordhuis discovered this interesting bug, with the help of an user experiencing strange things in a Redis instance with multiple slaves and maxmemory configured at the same time: when maxmemory was reached the DB on the master was completely erased (thanks to Pieter, Dane and Jemie for the investigation).\n\nThe issue happens for the following reason:\n- Redis reached the configured limit, so it tries to expire keys.\n- Evicting keys turns into explicit DELs sent to slaves, since masters control the eviction of slaves for well known reasons.\n- But this way if there are enough slaves, emitting the protocol in the output buffers will actually take more memory than the amount freed removing keys...\n- So the key eviction process starts to enter into an infinite loop.\n\nUp to a given point the fact that there is a static buffer part in the output queue of every client (including slaves) mitigate this in certain conditions, but once Redis can't use the output buffer but must use the queue of objects the infinite loop is triggered.\n\nI'm working to fix this problem, there are different ways to do this and I'm doing experiments to find the best solution. Among the possible solutions there is to ignore output buffer of slaves when computing max memory, or to call the function that flushes data to the slave while we are inside the eviction loop if we detect that the memory is raising after every deletion instead of decreasing, or to even tolerate the fact that the memory increases inside the loop but up to a certain limit, and break the loop when a few keys are evicted (enough to go under the maxmemory limit, if we subtract the size taken by the slave output buffers).\n\nI'm experimenting with the above solutions, but also improving the memory used generating the protocol by using more shared objects for common parts of the protocol, that helps to make this issue (and the code path resolving it, that should be considered an exception) less likely to be triggered.\n\n**Edit:** Update, a fix is available in the issue327 branch.\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/327/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/327/timeline","performed_via_github_app":null,"state_reason":"completed"}