<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:43:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CSV-224] Some multi-iterator parsing peek sequences incorrectly consume elements</title>
                <link>https://issues.apache.org/jira/browse/CSV-224</link>
                <project id="12313222" key="CSV">Commons CSV</project>
                    <description>&lt;p&gt;Repeated calls to CSVParser Iterable return new Iterators that each reference the same underlying parser lexer. Within the scope of a&#160;single Iterator, row peeking with Iterator.hasNext() works as intended. When row peeking with Iterator.hasNext()&#160;under circumstances that create a new Iterator, an element is consumed by the iterator which cannot be&#160;accessed by subsequent, newly created Iterators and Iterator.next()s. Effectively, the record Iterator and the lexer get out of sequence. See snippet below.&lt;/p&gt;

&lt;p&gt;The &quot;right thing&quot; is keeping the Iterator in sequence with the lexer, and since this is reading from a buffer, there seem to me to be only two resolutions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;One lexer, one Iterator.&lt;/li&gt;
	&lt;li&gt;New Iterators, but peeking with hasNext doesn&apos;t advance the lexer.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If there&apos;s a consensus on one of these, I can put up a PR.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; @Test

&#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void newIteratorSameLexer() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {



&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; fiveRows = &lt;span class=&quot;code-quote&quot;&gt;&quot;1\n2\n3\n4\n5\n&quot;&lt;/span&gt;;



&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Enhanced &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; loop, no peeking:&quot;&lt;/span&gt;);

&#160; &#160; CSVParser parser =

&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CSVParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedReader(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(fiveRows)), CSVFormat.DEFAULT);

&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; recordNumber = 0;

&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (CSVRecord record : parser) {

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (recordNumber &amp;gt;= 2) {

&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;

&#160; &#160; &#160; }

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// CSVParser.iterator() returns a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; iterator, but the lexer isn&apos;t reset so we can pick up
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// where we left off.
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (CSVRecord record : parser) {

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Enhanced &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; loop, no peeking:
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 1 -&amp;gt; 1
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 2 -&amp;gt; 2
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 3 -&amp;gt; 3
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 4 -&amp;gt; 4
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 5 -&amp;gt; 5
&lt;/span&gt;




&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;\nEnhanced &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; loop, with peek:&quot;&lt;/span&gt;);

&#160; &#160; parser = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CSVParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedReader(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(fiveRows)), CSVFormat.DEFAULT);

&#160; &#160; recordNumber = 0;

&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (CSVRecord record : parser) {

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (recordNumber &amp;gt;= 2) {

&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;

&#160; &#160; &#160; }

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// CSVParser.iterator() returns a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; iterator, but we call hasNext before next, so we queue
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// one element &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; consumption. This element is discarded by the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; iterator, even though the
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// lexer has advanced a row, so we&apos;ve consumed an element with the peek!
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;hasNext(): &quot;&lt;/span&gt; + parser.iterator().hasNext());

&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (CSVRecord record : parser) {

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Enhanced &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; loop, with peek:
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 1 -&amp;gt; 1
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 2 -&amp;gt; 2
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// hasNext(): &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 3 -&amp;gt; 4
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 4 -&amp;gt; 5
&lt;/span&gt;




&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;\nIterator &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;, with peek:&quot;&lt;/span&gt;);

&#160; &#160; parser = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CSVParser(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedReader(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(fiveRows)), CSVFormat.DEFAULT);

&#160; &#160; recordNumber = 0;

&#160; &#160; Iterator&amp;lt;CSVRecord&amp;gt; iter = parser.iterator();

&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext()) {

&#160; &#160; &#160; CSVRecord record = iter.next();

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (recordNumber &amp;gt;= 2) {

&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;

&#160; &#160; &#160; }

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// When we use the same iterator, iterator and lexer are in sequence.
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;hasNext(): &quot;&lt;/span&gt; + iter.hasNext());

&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext()) {

&#160; &#160; &#160; CSVRecord record = iter.next();

&#160; &#160; &#160; recordNumber++;

&#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(recordNumber + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt; + record.get(0));

&#160; &#160; }

&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Iterator &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;, with peek:
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 1 -&amp;gt; 1
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 2 -&amp;gt; 2
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// hasNext(): &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 3 -&amp;gt; 3
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 4 -&amp;gt; 4
&lt;/span&gt;
&#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// 5 -&amp;gt; 5
&lt;/span&gt;
&#160; }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13152078">CSV-224</key>
            <summary>Some multi-iterator parsing peek sequences incorrectly consume elements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Dave Warshaw">David Warshaw</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Apr 2018 20:36:08 +0000</created>
                <updated>Tue, 25 Sep 2018 13:31:41 +0000</updated>
                            <resolved>Fri, 18 May 2018 20:25:36 +0000</resolved>
                                    <version>1.5</version>
                                    <fixVersion>1.6</fixVersion>
                                    <component>Parser</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16436319" author="garydgregory" created="Thu, 12 Apr 2018 21:15:44 +0000"  >&lt;p&gt;Thank you for your report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Dave+Warshaw&quot; class=&quot;user-hover&quot; rel=&quot;Dave Warshaw&quot;&gt;Dave Warshaw&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This seems like it deserves a PR. But it is worth noting that the workaround is simple.&lt;/p&gt;</comment>
                            <comment id="16436364" author="dave warshaw" created="Thu, 12 Apr 2018 22:05:51 +0000"  >&lt;p&gt;The workaround is simple, if you know you have the problem.&lt;/p&gt;

&lt;p&gt;With the number of&#160;batching / chunking Java based CSV processing apps out in the wild, I can&apos;t believe that everyone has avoided this error.&lt;/p&gt;</comment>
                            <comment id="16436380" author="garydgregory" created="Thu, 12 Apr 2018 22:11:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Dave+Warshaw&quot; class=&quot;user-hover&quot; rel=&quot;Dave Warshaw&quot;&gt;Dave Warshaw&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Make sure your PR provides unit tests that fail unless the main part of the patch is applied.&lt;/p&gt;

&lt;p&gt;Thank you,&lt;/p&gt;

&lt;p&gt;Gary&lt;/p&gt;</comment>
                            <comment id="16437330" author="dave warshaw" created="Fri, 13 Apr 2018 13:59:16 +0000"  >&lt;p&gt;PR up:&#160;&lt;a href=&quot;https://github.com/apache/commons-csv/pull/27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-csv/pull/27&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16445748" author="dave warshaw" created="Fri, 20 Apr 2018 13:51:00 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=garydgregory&quot; class=&quot;user-hover&quot; rel=&quot;garydgregory&quot;&gt;garydgregory&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16446926" author="garydgregory" created="Sat, 21 Apr 2018 18:21:13 +0000"  >&lt;p&gt;I started looking at the patch last week but got side tracked by some work issues. I should be able to look again in the coming week. Thank you for the PR.&lt;/p&gt;</comment>
                            <comment id="16481154" author="garydgregory" created="Fri, 18 May 2018 20:25:36 +0000"  >&lt;p&gt;Patch applied, thank you. Please verify and close this ticket and related PR.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3shnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>