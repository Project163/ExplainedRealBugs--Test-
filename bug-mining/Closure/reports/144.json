{"id":532,"status":"Fixed","summary":"Closure Compiler Advanced Mode does not recognize toJSON (like it recognizes toString)","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":4,"comments":[{"id":0,"commenterId":984933248238154508,"content":"\u003cb\u003eWhat steps will reproduce the problem?\u003c/b\u003e\nCompile the following simple javascript program (with advanced optimizations):\r\n\r\n// \u003d\u003dClosureCompiler\u003d\u003d\r\n// @compilation_level ADVANCED_OPTIMIZATIONS\r\n// @output_file_name default.js\r\n// \u003d\u003d/ClosureCompiler\u003d\u003d\r\n\r\n/**\r\n@constructor\r\n@param {number} x\r\n@param {number} y\r\n*/\r\nfunction foo(x, y) { \r\n  this.x \u003d x;\r\n  this.y \u003d y;\r\n  this.lastSum \u003d x + y;\r\n};\r\n\r\n/**\r\n@type {number}\r\n*/\r\nfoo.prototype.x;\r\n\r\n/**\r\n@type {number}\r\n*/\r\nfoo.prototype.y;\r\n\r\n/**\r\n@type {number}\r\n*/\r\nfoo.prototype.lastSum;\r\n\r\n/**\r\n@override\r\n@return {string}\r\n*/\r\nfoo.prototype.toString \u003d function() {\r\n  return \u0027(\u0027 + this.x + \u0027,\u0027 + this.y + \u0027)\u0027; \r\n};\r\n\r\n/**\r\n@return {Object}\r\n*/\r\nfoo.prototype.toJSON \u003d function() {\r\n  return {\r\n    x: this.x,\r\n    y: this.y\r\n  };\r\n};\r\n\r\n/**\r\n@return {number}\r\n*/\r\nfoo.prototype.recalc \u003d function() {\r\n  return (this.lastSum \u003d this.x + this.y);\r\n};\r\n\r\nvar temp \u003d new foo(10, 12);\r\nalert(temp.toString() + \u0027\\n\\n\u0027 + JSON.stringify(temp));\r\ntemp.x \u003d 15;\r\nalert(temp.toString() + \u0027\\n\\n\u0027 + JSON.stringify(temp));\r\ntemp.recalc();\r\nalert(temp.toString() + \u0027\\n\\n\u0027 + JSON.stringify(temp));\r\n\r\n// *** EOF \r\n\r\n\u003cb\u003eWhat is the expected output? What do you see instead?\u003c/b\u003e\n\r\nThe output produced (with pretty print) is:\r\nfunction a(c, d) {\r\n  this.x \u003d c;\r\n  this.y \u003d d;\r\n  this.a \u003d c + d\r\n}\r\na.prototype.toString \u003d function() {\r\n  return\u0026quot;(\u0026quot; + this.x + \u0026quot;,\u0026quot; + this.y + \u0026quot;)\u0026quot;\r\n};\r\na.prototype.recalc \u003d function() {\r\n  return this.a \u003d this.x + this.y\r\n};\r\nvar b \u003d new a(10, 12);\r\nalert(b.toString() + \u0026quot;\\n\\n\u0026quot; + JSON.stringify(b));\r\nb.x \u003d 15;\r\nalert(b.toString() + \u0026quot;\\n\\n\u0026quot; + JSON.stringify(b));\r\nb.recalc();\r\nalert(b.toString() + \u0026quot;\\n\\n\u0026quot; + JSON.stringify(b));\r\n\r\nThe compiler removes the function from the scope (as it should since it doesn\u0027t recognize that it is an side effect override similar to toString).  The compiler should recognize toJSON like it does with toString and never change the name as it breaks JSON.stringify\u0027s interaction with the object.\r\n\r\n\r\n\u003cb\u003eWhat version of the product are you using? On what operating system?\u003c/b\u003e\n\r\nTest produced with Closure Compiler Service, first noticed on custom build of most recent source (only change was to turn on disambiguateProperties).\r\n\r\n\r\n\r\n\u003cb\u003ePlease provide any additional information below.\u003c/b\u003e\n\r\nI realize this can be rectified by using:\r\n     foo.prototype[\u0027toJSON\u0027] \u003d function(){....  \r\n  export style notation.\r\n\r\nThat said it still is unexpected behavior as toString() behaves the way the you would expect it to.\r\n\r\nI realize this is a sticky situation as toString() is actually defined on the object and toJSON() needs more of a special placeholder. But someone should make this a little more normalized as [\u0027toJSON\u0027] feels kind of hack-ey and counter-intuitive.... Thanks for your time.\r\n","timestamp":1313425267,"attachments":[]},{"id":1,"commenterId":-5060162230523776870,"content":"","timestamp":1313428966,"attachments":[]},{"id":2,"commenterId":-5060162230523776870,"content":"","timestamp":1313428982,"attachments":[]},{"id":3,"commenterId":1328304962299559429,"content":"This issue was closed by revision r1359.","timestamp":1313684952,"attachments":[]}]}