{"id":1072,"status":"Fixed","summary":"weird type-inference failure when type-casts added to an unrelated function","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":7,"comments":[{"id":0,"commenterId":-7699928860083865744,"content":"Try the following code.\r\n\r\n// \u003d\u003dClosureCompiler\u003d\u003d\r\n// @compilation_level ADVANCED_OPTIMIZATIONS\r\n// @output_file_name default.js\r\n// \u003d\u003d/ClosureCompiler\u003d\u003d\r\n\r\n/**\r\n * @param {string} x\r\n * @return {number}\r\n */\r\nvar f1 \u003d function (x) {\r\n  return 3;\r\n};\r\n\r\n/** Function */\r\nvar f2 \u003d function (x) {\r\n  if (!x) throw new Error()\r\n  return /** @type {number} */ (f1(\u0027x\u0027))\r\n}\r\n\r\n/**\r\n * @param {string} x\r\n */\r\nvar f3 \u003d function (x) {};\r\n\r\nf1(f3);\r\n\r\nI get the warning:\r\nactual parameter 1 of f1 does not match formal parameter\r\nfound   : function (?): undefined\r\nrequired: string\r\nf1(f3);\r\n\r\nNotice that type inference of f3 has failed.\r\n\r\nIf I remove the type-cast, the type of \u0027f3\u0027 is inferred correctly.\r\n\r\nactual parameter 1 of f1 does not match formal parameter\r\nfound   : function (string): undefined\r\nrequired: string\r\nf1(f3);\r\n\r\nIt seems odd to me that changing the definition of f2 breaks type inference for f3, which makes me suspect a problem with jsdoc parsing.\r\n","timestamp":1377543481,"attachments":[]},{"id":1,"commenterId":-7699928860083865744,"content":"poking at this a bit more, i think the pattern\r\nif (x) throw Error()\r\nwithout a semi-colon at the end makes the type-checker fail in all sorts of bizarre ways. Adding a semi-colon fixes the issue.","timestamp":1377546745,"attachments":[]},{"id":2,"commenterId":-7699928860083865744,"content":"I see the problem. Rhino attaches crazy bogus position information to the THROW node, and the new AttachJsDoc uses this information as the source of truth.\r\n\r\nWe might want to be a bit more defensive about idiosyncratic Rhino behavior, but for now I\u0027ll apply the easy fix.","timestamp":1377610239,"attachments":[]},{"id":3,"commenterId":-7699928860083865744,"content":"(The reason an extra semi-colon fixes the issue is because Rhino \"corrects\" the length of the throw node to include the semi-colon)","timestamp":1377610416,"attachments":[]},{"id":4,"commenterId":-7699928860083865744,"content":"CL posted here:\r\nhttp://codereview.appspot.com/13279043","timestamp":1377610596,"attachments":[]},{"id":5,"commenterId":-7699928860083865744,"content":"This issue was closed by revision 6c43134465d9.","timestamp":1377878547,"attachments":[]},{"id":6,"commenterId":-7699928860083865744,"content":"This issue was closed by revision 6c43134465d9.","timestamp":1381947632,"attachments":[]}]}