{"id":390,"status":"Fixed","summary":"Workaround for nested assignment bug in Opera","labels":["Type-Defect","Priority-Medium"],"stars":4,"commentCount":19,"comments":[{"id":0,"commenterId":-427252666174472748,"content":"http://bugs.jquery.com/ticket/8463\r\n\r\nhttp://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js line 6750,transport should not be null.\r\n\r\n\r\n","timestamp":1301028999,"attachments":[]},{"id":1,"commenterId":-7699928860083865744,"content":"i have no idea what this bug report means. i looked at the ticket, and I was even more confused.\r\nhttp://bugs.jquery.com/ticket/8463 \r\ndoesn\u0027t say anything about how closure compiler is being run, but it\u0027s marked as a duplicate of\r\nhttp://bugs.jquery.com/ticket/7318\r\nwhich says that they acknowledge this won\u0027t work.\r\n\r\nCan you provide a bit more context on how we can reproduce the issue, please?\r\nwhat compiler version are you using?\r\nwhat flags are you running it with?","timestamp":1301037212,"attachments":[]},{"id":2,"commenterId":-427252666174472748,"content":"latest version compiler and default flags,compiler compressed jquery cannot perform ajax request in opera11(works fine with chrome and firefox and IE9),uglifyjs compressed jquery works fine with all browser","timestamp":1301063322,"attachments":[]},{"id":3,"commenterId":8173196008570380122,"content":"I can get this to fail using SIMPLE_OPTIMIZATIONS\r\n\r\nOddly, it succeeds with --formatting PRETTY_PRINT.\r\n\r\nI\u0027m looking into this more, but it is a lot of code.","timestamp":1301070596,"attachments":[]},{"id":4,"commenterId":8173196008570380122,"content":"I finally was able to build a test case. Both alert statements below should output \"bar\". In Opera, the first statement is undefined. Note that the closure is required to trigger the bug.\r\n\r\nvar a \u003d {}, b \u003d \"key\", c \u003d {}, d \u003d \"key\", y ,z;\r\n\r\nfunction test1(bar) {\r\n  return function(index, value) {\r\n    var z \u003d index;\r\n    z \u003d bar[z] \u003d bar[z] || [];\r\n    z.push(value);\r\n  };\r\n}\r\n\r\nfunction test2(bar) {\r\n  return function(index, value) {\r\n    var z \u003d index;\r\n    bar[z] \u003d bar[z] || [];\r\n    z \u003d bar[z];\r\n    z.push(value);\r\n  };\r\n}\r\n\r\nvar foo1 \u003d test1(a), foo2 \u003d test2(c);\r\nfoo1(b, \"bar\");\r\nfoo2(d, \"bar\");\r\nalert(a[b]);\r\nalert(c[d]);","timestamp":1301148152,"attachments":[]},{"id":5,"commenterId":8173196008570380122,"content":"Online test case: http://people.missouristate.edu/chadkillingsworth/operatest.htm","timestamp":1301151075,"attachments":[]},{"id":6,"commenterId":8173196008570380122,"content":"As this is a bug in Opera\u0027s script engine, I submitted the bug to Opera. They responded that the bug had been fixed a week ago but had yet to make it to a public release. I\u0027ve asked for clarification on exactly which versions of Opera were affected and will post the answer here when/if I get it.\r\n\r\nSince this isn\u0027t a compiler bug, I\u0027m closing the ticket.","timestamp":1301227899,"attachments":[]},{"id":7,"commenterId":8173196008570380122,"content":"Opera responded and stated that this is a nested assignment bug that affects Opera Desktop products 10.5 - 11.1.","timestamp":1301266577,"attachments":[]},{"id":8,"commenterId":-7699928860083865744,"content":"@chad: do we know exactly what the bug is? (i wish opera was better about making their bug-tracking world-readable). does it affect all nested assignments, or just ones in particular cases?\r\n\r\nwe have, in the past, inserted workarounds for browser bugs when it\u0027s easy to do so.","timestamp":1301272472,"attachments":[]},{"id":9,"commenterId":8173196008570380122,"content":"@Nick Not yet, but I\u0027ve asked. The Opera folks actually mentioned that it would be nice if the compiler would work around this. I told them we\u0027d need the specific conditions that triggered the bug and am waiting on the response.","timestamp":1301278245,"attachments":[]},{"id":10,"commenterId":-8074791118265029,"content":"\r\nThe conditions for which this Opera-specific bug will hit is\r\n\r\n   v \u003d rhs\r\n\r\nwhere \u0027rhs\u0027 contains a compound assignment of the form  a[i] or obj.p _and_ \u0027v\u0027 is also used in \u0027rhs\u0027. i.e., for the above example, \r\n\r\n   z \u003d bar[z] \u003d bar[z] || [];\r\n\r\nor \r\n\r\n   x \u003d foo.bar +\u003d x.baz;\r\n\r\nOpera 11.10 final will have the fix included, but if emitting constructs like the above is common and can be readily avoided, that\u0027d be very helpful. More than happy to supply extra information \u0026 work through the details to make this happen, if needed.\r\n\r\n--sof / sof@opera.com","timestamp":1301308101,"attachments":[]},{"id":11,"commenterId":8173196008570380122,"content":"Re-opening as request for workaround.","timestamp":1301326304,"attachments":[]},{"id":12,"commenterId":6454800031398885070,"content":"I think that the only workable fix would be to have a custom pass after ExploitAssigns, as all of the following might cause this problem:\r\n  - InlineVariables\r\n  - FlowSensitiveInlineVariables\r\n  - InlineFunctions\r\n  - InlineMethods\r\n  - PeepholeSubstituteAlternateSyntax (maybe)\r\n","timestamp":1301436405,"attachments":[]},{"id":13,"commenterId":-215138502632663007,"content":"If this only happens for compound assigns, how about we put in a workaround by running expression decompose on them if this pattern shows up.\r\n\r\nOnce Opera 11.10 is out, we can remove it.","timestamp":1301436505,"attachments":[]},{"id":14,"commenterId":1948758734812428220,"content":"I\u0027ll put in a pass to do just that","timestamp":1301438653,"attachments":[]},{"id":15,"commenterId":-8074791118265029,"content":"Opera 11.10 beta snapshots (build # \u003e\u003d 2076) now have the fixes to the treatment of compound assignments included (*). Sincerely appreciate the quick followup and the suggested addition of a desugaring pass. That would be ideal, as the rate by which the userbase migrate to new versions could be higher/quicker, so we expect there to be a tail on this one. But if this merits support in the compiler is of course your decision entirely.\r\n\r\nthanks again\r\n--sof / sof@opera.com\r\n\r\n* - see http://my.opera.com/desktopteam/blog/ for test snapshots.\r\n","timestamp":1301693430,"attachments":[]},{"id":16,"commenterId":-5060162230523776870,"content":"r959","timestamp":1302192529,"attachments":[]},{"id":17,"commenterId":1948758734812428220,"content":"When is a good time to remove this workaround?","timestamp":1304632714,"attachments":[]},{"id":18,"commenterId":-8074791118265029,"content":"Opera 11.10 Final has the compilation scheme fix, as has the upcoming 11.50. Hard to say if we\u0027re living in the shadow of your good work wrt older browser versions, but there\u0027s an automatic upgrade path available to users should they run into the issue.\r\n\r\nSo, please retire the workaround pass whenever suits you. We really appreciate the quick help in tiding us over with this bug; great stuff.\r\n\r\n--sigbjorn / sof@opera.com\r\n","timestamp":1304965278,"attachments":[]}]}