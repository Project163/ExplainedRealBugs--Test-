{"id":764,"status":"Fixed","summary":"java.lang.IllegalArgumentException when using --transform_amd_modules","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":12,"comments":[{"id":0,"commenterId":-1302235527754825532,"content":"\u003cb\u003eWhat steps will reproduce the problem?\u003c/b\u003e\n1. Create three AMD files with this dependency graph:\r\n\r\n     1.js\r\n    /    \\\r\n  2.js   3.js\r\n\r\n2. Compile with --compilation_level ADVANCED_OPTIMIZATIONS and --transform_amd_modules\r\n\r\njava -jar closure-compiler/compiler.jar --compilation_level ADVANCED_OPTIMIZATIONS --process_common_js_modules --common_js_entry_module 1.js --transform_amd_modules --js 1.js 2.js 3.js\r\n\r\n\r\n\u003cb\u003eWhat is the expected output? What do you see instead?\u003c/b\u003e\nThe compiler should compile the files.\r\n\r\nInstead of this, there are compilation errors, but there is not compiled output, and compiler throws this exception:\r\n\r\njava.lang.RuntimeException: java.lang.IllegalArgumentException: expected one element but was: \u0026lt;module$2, module$3\u0026gt;\r\n\tat com.google.javascript.jscomp.Compiler.runCallable(Compiler.java:654)\r\n\tat com.google.javascript.jscomp.Compiler.runInCompilerThread(Compiler.java:599)\r\n\tat com.google.javascript.jscomp.Compiler.compile(Compiler.java:581)\r\n\tat com.google.javascript.jscomp.Compiler.compile(Compiler.java:540)\r\n\tat com.google.javascript.jscomp.AbstractCommandLineRunner.doRun(AbstractCommandLineRunner.java:739)\r\n\tat com.google.javascript.jscomp.AbstractCommandLineRunner.run(AbstractCommandLineRunner.java:351)\r\n\tat com.google.javascript.jscomp.CommandLineRunner.main(CommandLineRunner.java:905)\r\nCaused by: java.lang.IllegalArgumentException: expected one element but was: \u0026lt;module$2, module$3\u0026gt;\r\n\tat com.google.common.collect.Iterators.getOnlyElement(Iterators.java:308)\r\n\tat com.google.common.collect.Iterables.getOnlyElement(Iterables.java:265)\r\n\tat com.google.javascript.jscomp.JSModuleGraph.getRootModule(JSModuleGraph.java:130)\r\n\tat com.google.javascript.jscomp.AnalyzePrototypeProperties.\u0026lt;init\u0026gt;(AnalyzePrototypeProperties.java:123)\r\n\tat com.google.javascript.jscomp.CrossModuleMethodMotion.\u0026lt;init\u0026gt;(CrossModuleMethodMotion.java:75)\r\n\tat com.google.javascript.jscomp.DefaultPassConfig$66.createInternal(DefaultPassConfig.java:1763)\r\n\tat com.google.javascript.jscomp.PassFactory.create(PassFactory.java:89)\r\n\tat com.google.javascript.jscomp.PhaseOptimizer$PassFactoryDelegate.processInternal(PhaseOptimizer.java:296)\r\n\tat com.google.javascript.jscomp.PhaseOptimizer$NamedPass.process(PhaseOptimizer.java:273)\r\n\tat com.google.javascript.jscomp.PhaseOptimizer$LoopInternal.process(PhaseOptimizer.java:359)\r\n\tat com.google.javascript.jscomp.PhaseOptimizer.process(PhaseOptimizer.java:187)\r\n\tat com.google.javascript.jscomp.Compiler.optimize(Compiler.java:1848)\r\n\tat com.google.javascript.jscomp.Compiler.compileInternal(Compiler.java:693)\r\n\tat com.google.javascript.jscomp.Compiler.access$000(Compiler.java:77)\r\n\tat com.google.javascript.jscomp.Compiler$1.call(Compiler.java:584)\r\n\tat com.google.javascript.jscomp.Compiler$1.call(Compiler.java:581)\r\n\tat com.google.javascript.jscomp.Compiler$2.run(Compiler.java:626)\r\n\tat java.lang.Thread.run(Thread.java:722)\r\n\r\n\r\n\r\n\u003cb\u003eWhat version of the product are you using? On what operating system?\u003c/b\u003e\nVersion: 20120430 (revision 1918), Linux (Fedora 17)\r\n\r\n\u003cb\u003ePlease provide any additional information below.\u003c/b\u003e\nThe error occurs only when using ADVANCED_OPTIMIZATIONS and the dependency graph of the entry module has more than one leaves. So basically every time except in very simple cases, like this dependency graph : 1.js -\u0026gt; 2.js -\u0026gt; 3.js -\u0026gt; 4.js\r\n","timestamp":1340723474,"attachments":[]},{"id":1,"commenterId":-5060162230523776870,"content":"Malte can you comment on what is expected here?","timestamp":1341945530,"attachments":[]},{"id":2,"commenterId":-2708059715677396299,"content":"Could you paste the actual source files?","timestamp":1341949468,"attachments":[]},{"id":3,"commenterId":8393402175286303949,"content":"I think this issue is linked to this one:\r\nhttp://code.google.com/p/closure-compiler/issues/detail?id\u003d373\r\n\r\nA workaround that worked for me is described here:\r\nhttps://groups.google.com/forum/?fromgroups#!topic/closure-compiler-discuss/yP482KpgJMs","timestamp":1345278865,"attachments":[]},{"id":4,"commenterId":-5697700909281489174,"content":"I have exactly the same problem with r2224. Is there any progress on this issue?\r\n","timestamp":1349177751,"attachments":[]},{"id":5,"commenterId":-2708059715677396299,"content":"The feature is currently broken due to a different bug but unrelated to the output here. If you really have the same issue, could you post a repro case","timestamp":1349178696,"attachments":[]},{"id":6,"commenterId":-5697700909281489174,"content":"Here you go. The output from running the attached Makefile is:\r\n\r\njava -jar ../../../../build/tool/gccompiler/compiler.jar --transform_amd_modules --process_common_js_modules --common_js_entry_module\u003dFoo.js --compilation_level\u003dADVANCED_OPTIMIZATIONS --js_output_file\u003dout.js --js\u003dFoo.js --js\u003dlib/Bar.js --js\u003dlib/Baz.js\r\n\r\njava.lang.RuntimeException: java.lang.IllegalArgumentException: expected one element but was: \u003cmodule$lib$Bar, module$lib$Baz\u003e\r\n        at com.google.javascript.jscomp.Compiler.runInCompilerThread(Compiler.java:698)\r\n        at com.google.javascript.jscomp.Compiler.compile(Compiler.java:632)\r\n        at com.google.javascript.jscomp.Compiler.compile(Compiler.java:588)\r\n        at com.google.javascript.jscomp.AbstractCommandLineRunner.doRun(AbstractCommandLineRunner.java:747)\r\n        at com.google.javascript.jscomp.AbstractCommandLineRunner.run(AbstractCommandLineRunner.java:359)\r\n        at com.google.javascript.jscomp.CommandLineRunner.main(CommandLineRunner.java:930)\r\nCaused by: java.lang.IllegalArgumentException: expected one element but was: \u003cmodule$lib$Bar, module$lib$Baz\u003e\r\n        at com.google.common.collect.Iterators.getOnlyElement(Iterators.java:375)\r\n        at com.google.common.collect.Iterables.getOnlyElement(Iterables.java:270)\r\n        at com.google.javascript.jscomp.JSModuleGraph.getRootModule(JSModuleGraph.java:135)\r\n        at com.google.javascript.jscomp.AnalyzePrototypeProperties.\u003cinit\u003e(AnalyzePrototypeProperties.java:123)\r\n        at com.google.javascript.jscomp.CrossModuleMethodMotion.\u003cinit\u003e(CrossModuleMethodMotion.java:76)\r\n        at com.google.javascript.jscomp.DefaultPassConfig$69.createInternal(DefaultPassConfig.java:1823)\r\n        at com.google.javascript.jscomp.PassFactory.create(PassFactory.java:89)\r\n        at com.google.javascript.jscomp.PhaseOptimizer$PassFactoryDelegate.processInternal(PhaseOptimizer.java:303)\r\n        at com.google.javascript.jscomp.PhaseOptimizer$NamedPass.process(PhaseOptimizer.java:279)\r\n        at com.google.javascript.jscomp.PhaseOptimizer$LoopInternal.process(PhaseOptimizer.java:366)\r\n        at com.google.javascript.jscomp.PhaseOptimizer.process(PhaseOptimizer.java:191)\r\n        at com.google.javascript.jscomp.Compiler.optimize(Compiler.java:1891)\r\n        at com.google.javascript.jscomp.Compiler.compileInternal(Compiler.java:737)\r\n        at com.google.javascript.jscomp.Compiler.access$1(Compiler.java:704)\r\n        at com.google.javascript.jscomp.Compiler$3.call(Compiler.java:635)\r\n        at com.google.javascript.jscomp.Compiler$3.call(Compiler.java:1)\r\n        at com.google.javascript.jscomp.Compiler$4.call(Compiler.java:662)\r\n        at java.util.concurrent.FutureTask$Sync.innerRun(Unknown Source)\r\n        at java.util.concurrent.FutureTask.run(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n        at java.lang.Thread.run(Unknown Source)\r\n\r\nGJSCC r2224, Win7 x64\r\n","timestamp":1349185066,"attachments":[{"id":7640006000,"fileName":"amd.zip","fileSize":1163}]},{"id":7,"commenterId":-2708059715677396299,"content":"Thanks. I\u0027ll fix it next week.","timestamp":1349185142,"attachments":[]},{"id":8,"commenterId":-5697700909281489174,"content":"Is there a chance for the fix anytime soon?\r\n","timestamp":1349772796,"attachments":[]},{"id":9,"commenterId":-2708059715677396299,"content":"Found the issue. Will submit a fix tomorrowish.","timestamp":1349795480,"attachments":[]},{"id":10,"commenterId":-7699928860083865744,"content":"This issue was closed by revision r2256.","timestamp":1350319387,"attachments":[]},{"id":11,"commenterId":-5697700909281489174,"content":"Works on the provided test case. Thanks a lot guys! Have a nice day.\r\n","timestamp":1350375001,"attachments":[]}]}