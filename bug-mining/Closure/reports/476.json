{"id":746,"status":"Fixed","summary":"Closure can break code by moving function invocations that have side affects within an object","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":5,"comments":[{"id":0,"commenterId":-6731017537173522114,"content":"\u003cb\u003eWhat steps will reproduce the problem?\u003c/b\u003e\n1. Run the attached code. Notice \u0026quot;awesome\u0026quot; in the output\r\n2. Run closure against the attached code, rerun, notice \u0026quot;failure\u0026quot; in the output\r\n\r\n\u003cb\u003eWhat is the expected output? What do you see instead?\u003c/b\u003e\nExpected awesome, got failure. Closure moves the function call who side affect is to alter the variable containing the message.\r\n\r\n\u003cb\u003eWhat version of the product are you using? On what operating system?\u003c/b\u003e\nClosure Compiler (http://code.google.com/closure/compiler)\r\nVersion: 20120305 (revision 1810)\r\nBuilt on: 2012/03/05 20:55\r\nMac / Lion\r\n\r\n\u003cb\u003ePlease provide any additional information below.\u003c/b\u003e","timestamp":1338772968,"attachments":[{"id":7460000000,"fileName":"moving-fn-calls.js","fileSize":728}]},{"id":1,"commenterId":-5060162230523776870,"content":"This looks like a variable inlining bug:\r\n\r\n// \u003d\u003dClosureCompiler\u003d\u003d\r\n// @output_file_name default.js\r\n// @compilation_level ADVANCED_OPTIMIZATIONS\r\n// @debug true\r\n// @formatting pretty_print\r\n// \u003d\u003d/ClosureCompiler\u003d\u003d\r\n\r\nfunction MyClass() {\r\n  this.lastFormData \u003d \"failure\";\r\n}\r\n\r\nMyClass.prototype.validate \u003d function() {\r\n  console.log(\"validate\");\r\n  this.lastFormData \u003d \"awesome\";\r\n  return Math.random() \u003e 0.5;\r\n}\r\n\r\nMyClass.prototype._setErrors \u003d function(errors) {\r\n  console.log(\"setting errors\");\r\n}\r\n\r\nMyClass.prototype._updateReport \u003d function(){\r\n  var errors \u003d this.validate();\r\n  var data \u003d this.lastFormData;\r\n\r\n  this._setErrors(errors);\r\n\r\n  console.log(data);\r\n\r\n  eval(\"updateReport\");\r\n};\r\n\r\n\r\nvar m \u003d new MyClass();\r\nm._updateReport();\r\n\r\n\r\n\r\nproduces:\r\n\r\n\r\n\r\nfunction $MyClass$$() {\r\n  this.$lastFormData$ \u003d \"failure\"\r\n}\r\nfunction $JSCompiler_StaticMethods_validate$$($JSCompiler_StaticMethods_validate$self$$) {\r\n  eval(\"me\");\r\n  $JSCompiler_StaticMethods_validate$self$$.$lastFormData$ \u003d \"awesome\";\r\n  return 0.5 \u003c Math.random()\r\n}\r\nfunction $JSCompiler_StaticMethods__setErrors$$() {\r\n  console.log(\"setting errors\")\r\n}\r\n(function() {\r\n  var $JSCompiler_StaticMethods__updateReport$self$$ \u003d new $MyClass$$, $data$$21$$ \u003d $JSCompiler_StaticMethods__updateReport$self$$.$lastFormData$;\r\n  $JSCompiler_StaticMethods__setErrors$$($JSCompiler_StaticMethods_validate$$($JSCompiler_StaticMethods__updateReport$self$$));\r\n  console.log($data$$21$$);\r\n  eval(\"updateReport\")\r\n})();","timestamp":1338825184,"attachments":[]},{"id":2,"commenterId":-7699928860083865744,"content":"ya, this is the bug we were talking to evan about on friday. we should have a fix soon.","timestamp":1338825854,"attachments":[]},{"id":3,"commenterId":-5060162230523776870,"content":"Fixed with r2021?","timestamp":1338945255,"attachments":[]},{"id":4,"commenterId":-7699928860083865744,"content":"","timestamp":1338949621,"attachments":[]}]}