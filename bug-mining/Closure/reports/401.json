{"id":1207,"status":"Invalid","summary":"Math.random() fails with --use_only_custom_externs","labels":["Type-Defect","Priority-Medium"],"stars":0,"commentCount":5,"comments":[{"id":0,"commenterId":-2761451945267698014,"content":"\u003cb\u003eWhat version of the product are you using? On what operating system?\u003c/b\u003e\nClosure Compiler (http://code.google.com/closure/compiler)\r\nVersion: v20140110\r\nBuilt on: 2014/01/14 16:25\r\n\r\nDebian GNU/Linux Xfce\r\n\r\n\u003cb\u003ePlease provide any additional information below.\u003c/b\u003e\nCompile a program with these options:\r\n\r\n  --compilation_level\u003dADVANCED_OPTIMIZATIONS\r\n  --use_only_custom_externs\r\n  --debug\r\n\r\nIt should look like this:\r\n\r\n  Math.$random$();\r\n  ...rest of code here...\r\n\r\nNotice that it\u0027s called Math.$random$ rather than Math.random. Which means if you remove --debug, it\u0027ll get renamed to something short like Math.K, which obviously fails.\r\n\r\nThe problem is line 1006 in the base.js file of the Closure Library:\r\n\r\n  goog.UID_PROPERTY_ \u003d \u0027closure_uid_\u0027 + ((Math.random() * 1e9) \u0026gt;\u0026gt;\u0026gt; 0);\r\n\r\nNormally this isn\u0027t a problem because of \u0026quot;externs/es3.js\u0026quot;.\r\n\r\nBut because the call to Math.random is at the top level (and not inside a function), it doesn\u0027t get stripped out when using --use_only_custom_externs.\r\n\r\nThis means that if a user wants to use --use_only_custom_externs they *must* provide their own extern for Math.random, even if they never call Math.random themself.\r\n\r\nA quick fix would be to change the line in base.js to this:\r\n\r\n  goog.UID_PROPERTY_ \u003d \u0027closure_uid_\u0027 + ((Math[\u0027random\u0027]() * 1e9) \u0026gt;\u0026gt;\u0026gt; 0);\r\n\r\nAt least then it won\u0027t fail with an error, though you\u0027ll still have a useless Math.random call in the output.\r\n\r\nA better fix would be to make the compiler smart enough to strip out the Math.random even without an extern (perhaps treating the base.js file as special). Alternatively, the line could be moved into a function.","timestamp":1390597355,"attachments":[]},{"id":1,"commenterId":8173196008570380122,"content":"This is expected behavior. The externs for the built-in ecmascript objects MUST be provided. \r\n\r\nSee comment #2 on issue 755","timestamp":1390599994,"attachments":[]},{"id":2,"commenterId":-2761451945267698014,"content":"My point is that this makes --use_only_custom_externs significantly less useful, because you must provide an extern for Math.random *even if you never use Math.random*, because base.js uses it at the top-level.","timestamp":1390604010,"attachments":[]},{"id":3,"commenterId":-7699928860083865744,"content":"--use_only_custom_externs is for a very slim set of users. If you\u0027re using base.js, then it isn\u0027t meant for you.","timestamp":1390662184,"attachments":[]},{"id":4,"commenterId":-2761451945267698014,"content":"I see... thanks for explaining.","timestamp":1390696940,"attachments":[]}]}