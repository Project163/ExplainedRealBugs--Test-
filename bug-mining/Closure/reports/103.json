{"id":409,"status":"Fixed","summary":"LocaleUtil is not BCP47 compliant (doesn\u0027t parse locale variants correctly)","labels":["Type-Defect","Priority-Medium"],"stars":2,"commentCount":7,"comments":[{"id":0,"commenterId":4865687641346111136,"content":"LocaleUtil.getLocaleFromStandardLocaleString(localeString) fails to parse correctly for language tags which have a language subtag and a variant subtag, but not region subtag:\r\n\r\nStatus    localeString     Resulting Locale\r\nOK        de_AT_1996       new Locale(\u0026quot;de\u0026quot;, \u0026quot;AT\u0026quot;, \u0026quot;1996\u0026quot;)\r\nOK        de__1996         new Locale(\u0026quot;de\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;1996\u0026quot;)\r\nBROKEN    de_1996          new Locale(\u0026quot;de\u0026quot;, \u0026quot;1996\u0026quot;)\r\nBROKEN    de-1996          new Locale(\u0026quot;de\u0026quot;, \u0026quot;1996\u0026quot;)\r\n\r\n\u0026quot;1996\u0026quot; is just an example. The parsing doesn\u0027t work for any valid variant subtag value.\r\n\r\nSee:\r\nhttp://code.google.com/p/closure-compiler/source/browse/trunk/src/com/google/javascript/jscomp/LocaleUtil.java\r\n\r\nExpected behavior:\r\n\r\nThe localeString parsing should be BCP-47 compliant. E.g. if there\u0027s a 2nd subtag, don\u0027t just interpret it as region code. Determine whether it\u0027s a region code, script subtag, variant or extension.\r\n\r\nJava Locale 6 doesn\u0027t support script subtags and extensions, but variants.\r\n\r\nSo at the very least, I\u0027d suggest to test whether the 2nd subtag meets syntactic requirements to be a region subtag, and if not, interpret it as variant. (support 2 letter region codes and 3 digit UN M.49 region identifiers like 419 as in es-419).\r\n\r\nOnce Java 7 is out, we can just use Locale.forLanguageTag(localeString). But until then, we need a fix that works with variants.","timestamp":1302042347,"attachments":[]},{"id":1,"commenterId":-5060162230523776870,"content":"Did you have a suggested change?","timestamp":1302714108,"attachments":[]},{"id":2,"commenterId":4865687641346111136,"content":"I don\u0027t have a patch ready. Here\u0027s a sketch of the proposed change:\r\n\r\n - Try to be as lenient in locale string parsing as LocaleUtil (and Java 6 / 7) currently is. Don\u0027t be as strict as BCP47. (A lot of time of the Java 7 locale enhancement project went into ensuring that it\u0027s as backwards compatible as possible.)\r\n\r\n - Don\u0027t try to handle script subtags in a special way (they\u0027re not expected in Java 6 anyway, but people do weird things to cope with Java 6\u0027s shortcomings). Continue to be as agnostic about the meaning of each subtag as possible to avoid incompatibilities with previous behavior.\r\n\r\n - That having said, for locale strings that have 2 subtags, I\u0027d introduce some additional processing. If the 2nd subtag rather looks like a variant than a region subtag, then interpret it as a variant.\r\n\r\nDetail: For locale strings with exactly 2 subtags, these are the heuristics I\u0027d use to decide whether the subtag should be used as 2nd (region) or 3rd (variant) field in the Locale constructor invocation:\r\n\r\n - 2 letter subtag -\u003e region subtag\r\n - 3 digit subtag -\u003e region subtag\r\n - 4+ digits / characters -\u003e variant subtag (more loose than BCP47\u0027s syntax requirements, but a good heuristic). Matches \"1996\", \"POSIX\", \"fonipa\", etc.\r\n - 3 letter subtag -\u003e by BCP47 this can\u0027t be a region subtag, but people might use 3 letter region codes in their code. I guess I\u0027d continue to interpret this as a region subtag.\r\n - \"x-foobar\" - private use parts: I guess I wouln\u0027t deal with that for now.\r\n\r\nSo I guess the rule could be as simple as:\r\n If the locale string has 2 subtags, interpret the 2nd subtag as variant if it\u0027s 4+ alphanum characters long. Otherwise interpret it as region subtag.","timestamp":1302715401,"attachments":[]},{"id":3,"commenterId":-7699928860083865744,"content":"why do we care? it\u0027s package-private, and not used anywhere.","timestamp":1302722737,"attachments":[]},{"id":4,"commenterId":4865687641346111136,"content":"LocaleUtil.getLocaleFromStandardLocaleString is used by Google internal code. If you look at Google\u0027s internal version of this package, you\u0027ll see additional classes to adapt JSCompiler to Google localization data structures and infrastructure.\r\n\r\nI guess the class LocaleUtil itself shouldn\u0027t be in the public version of jscompiler if it\u0027s not used by the public version.\r\n\r\nEither way, we need to fix this for Google internal call sites.","timestamp":1302732870,"attachments":[]},{"id":5,"commenterId":4865687641346111136,"content":"Alternative solution:\r\n\r\nRemove LocaleUtil from the public version of JSCompiler. Then we can change the Google internal call sites of LocaleUtil.getLocaleFromStandardLocaleString to call ICU4J or other locale parsing methods which wouldn\u0027t be available in the public JSCompiler code base.","timestamp":1302732970,"attachments":[]},{"id":6,"commenterId":-7699928860083865744,"content":"This issue was closed by revision r1003.","timestamp":1302737028,"attachments":[]}]}