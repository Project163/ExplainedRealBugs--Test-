diff --git a/src/com/google/javascript/jscomp/Es6RewriteModules.java b/src/com/google/javascript/jscomp/Es6RewriteModules.java
index 8db31aa6c..03e944319 100644
--- a/src/com/google/javascript/jscomp/Es6RewriteModules.java
+++ b/src/com/google/javascript/jscomp/Es6RewriteModules.java
@@ -80,8 +80,6 @@ public final class Es6RewriteModules extends AbstractPostOrderCallback
 
   private Set<String> alreadyRequired;
 
-  private boolean forceRewrite;
-
   private Node googRequireInsertSpot;
 
   /**
@@ -158,7 +156,6 @@ public final class Es6RewriteModules extends AbstractPostOrderCallback
     this.classes = new HashSet<>();
     this.typedefs = new HashSet<>();
     this.alreadyRequired = new HashSet<>();
-    this.forceRewrite = true;
     this.googRequireInsertSpot = null;
   }
 
@@ -202,10 +199,8 @@ public final class Es6RewriteModules extends AbstractPostOrderCallback
   @Override
   public void visit(NodeTraversal t, Node n, Node parent) {
     if (n.isImport()) {
-      forceRewrite = false;
       visitImport(t, n, parent);
     } else if (n.isExport()) {
-      forceRewrite = false;
       visitExport(t, n, parent);
     } else if (n.isScript()) {
       scriptNodeCount++;
@@ -472,14 +467,12 @@ public final class Es6RewriteModules extends AbstractPostOrderCallback
     // Rename vars to not conflict in global scope.
     NodeTraversal.traverseEs6(compiler, script, new RenameGlobalVars(moduleName));
 
-    if (!exportMap.isEmpty() || forceRewrite) {
-      // Add goog.provide call.
-      Node googProvide = IR.exprResult(
-          IR.call(NodeUtil.newQName(compiler, "goog.provide"),
-              IR.string(moduleName)));
-      script.addChildToFront(googProvide.useSourceInfoIfMissingFromForTree(script));
-      t.getInput().addProvide(moduleName);
-    }
+    // Add goog.provide call.
+    Node googProvide = IR.exprResult(
+        IR.call(NodeUtil.newQName(compiler, "goog.provide"),
+            IR.string(moduleName)));
+    script.addChildToFront(googProvide.useSourceInfoIfMissingFromForTree(script));
+    t.getInput().addProvide(moduleName);
 
     JSDocInfoBuilder jsDocInfo = script.getJSDocInfo() == null
         ? new JSDocInfoBuilder(false)
diff --git a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
index 639eca8f6..ddff739b9 100644
--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
@@ -1831,7 +1831,8 @@ public final class CommandLineRunnerTest extends TestCase {
               "/** @constructor */ var module$foo = function(){};",
               "module$foo.prototype.bar=function(){console.log(\"bar\")};"),
           LINE_JOINER.join(
-              "var baz$$module$app = new module$foo();", "console.log(baz$$module$app.bar());")
+              "var module$app = {}, baz$$module$app = new module$foo();",
+              "console.log(baz$$module$app.bar());")
         });
   }
 
@@ -1851,7 +1852,33 @@ public final class CommandLineRunnerTest extends TestCase {
               "/** @const */ var module$foo={};",
               "function foo$$module$foo(){ alert('foo'); }",
               "foo$$module$foo();"),
-          "'use strict';"
+          "var module$app = {};"
+        });
+  }
+
+  public void testES6ImportOfFileWithImportsButNoExports() {
+    args.add("--dependency_mode=STRICT");
+    args.add("--entry_point='./app.js'");
+    args.add("--language_in=ECMASCRIPT6");
+    setFilename(0, "message.js");
+    setFilename(1, "foo.js");
+    setFilename(2, "app.js");
+    test(
+        new String[] {
+          "export default 'message';",
+          "import message from './message.js';\n  function foo() { alert(message); }\n  foo();",
+          "import './foo.js';"
+        },
+        new String[] {
+          CompilerTestCase.LINE_JOINER.join(
+              "/** @const */ var module$message={},",
+              "  $jscompDefaultExport$$module$message = 'message';",
+              "module$message.default = $jscompDefaultExport$$module$message;"),
+          CompilerTestCase.LINE_JOINER.join(
+              "/** @const */ var module$foo={};",
+              "function foo$$module$foo(){ alert(module$message.default); }",
+              "foo$$module$foo();"),
+          "var module$app = {};"
         });
   }
 
diff --git a/test/com/google/javascript/jscomp/CompilerTest.java b/test/com/google/javascript/jscomp/CompilerTest.java
index 75dce8592..ba42b7969 100644
--- a/test/com/google/javascript/jscomp/CompilerTest.java
+++ b/test/com/google/javascript/jscomp/CompilerTest.java
@@ -1160,18 +1160,18 @@ public final class CompilerTest extends TestCase {
   }
 
   public void testEs6ModulePathWithOddCharacters() throws Exception {
-    List<SourceFile> inputs = ImmutableList.of(
-        SourceFile.fromCode(
-            "/index[0].js", "import foo from './foo'; foo('hello');"),
-        SourceFile.fromCode("/foo.js",
-            "export default (foo) => { alert(foo); }"));
+    // Note that this is not yet compatible with transpilation, since the generated goog.provide
+    // statements are not valid identifiers.
+    List<SourceFile> inputs =
+        ImmutableList.of(
+            SourceFile.fromCode("/index[0].js", "import foo from './foo'; foo('hello');"),
+            SourceFile.fromCode("/foo.js", "export default (foo) => { alert(foo); }"));
 
     List<ModuleIdentifier> entryPoints = ImmutableList.of(
-        ModuleIdentifier.forFile("/index[0]"));
+        ModuleIdentifier.forFile("/index[0].js"));
 
     CompilerOptions options = createNewFlagBasedOptions();
-    options.setLanguageIn(CompilerOptions.LanguageMode.ECMASCRIPT_2017);
-    options.setLanguageOut(CompilerOptions.LanguageMode.ECMASCRIPT5);
+    options.setLanguage(CompilerOptions.LanguageMode.ECMASCRIPT_2017);
     options.dependencyOptions.setDependencyPruning(true);
     options.dependencyOptions.setDependencySorting(true);
     options.dependencyOptions.setEntryPoints(entryPoints);
diff --git a/test/com/google/javascript/jscomp/Es6RewriteModulesTest.java b/test/com/google/javascript/jscomp/Es6RewriteModulesTest.java
index c4724ab04..fee2357a3 100644
--- a/test/com/google/javascript/jscomp/Es6RewriteModulesTest.java
+++ b/test/com/google/javascript/jscomp/Es6RewriteModulesTest.java
@@ -62,8 +62,15 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
   }
 
   void testModules(String input, String expected) {
-    ModulesTestUtils.testModules(this, input,
-        "/** @fileoverview\n * @suppress {missingProvide|missingRequire}\n */" + expected);
+    ModulesTestUtils.testModules(
+        this,
+        input,
+        LINE_JOINER.join(
+            "/** @fileoverview",
+            " *  @suppress {missingProvide|missingRequire}",
+            " */",
+            "goog.provide('module$testcode');",
+            expected));
   }
 
   public void testImport() {
@@ -108,7 +115,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export var a = 1, b = 2;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var a$$module$testcode = 1, b$$module$testcode = 2;",
             "module$testcode.a = a$$module$testcode;",
             "module$testcode.b = b$$module$testcode;"));
@@ -116,7 +122,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export var a;\nexport var b;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var a$$module$testcode; var b$$module$testcode;",
             "module$testcode.a = a$$module$testcode;",
             "module$testcode.b = b$$module$testcode;"));
@@ -124,14 +129,12 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export function f() {};",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "function f$$module$testcode() {}",
             "module$testcode.f = f$$module$testcode;"));
 
     testModules(
         "export function f() {};\nfunction g() { f(); }",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "function f$$module$testcode() {}",
             "function g$$module$testcode() { f$$module$testcode(); }",
             "module$testcode.f = f$$module$testcode;"));
@@ -139,7 +142,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         LINE_JOINER.join("export function MyClass() {};", "MyClass.prototype.foo = function() {};"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "function MyClass$$module$testcode() {}",
             "MyClass$$module$testcode.prototype.foo = function() {};",
             "module$testcode.MyClass = MyClass$$module$testcode;"));
@@ -147,7 +149,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "var f = 1;\nvar b = 2;\nexport {f as foo, b as bar};",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var f$$module$testcode = 1;",
             "var b$$module$testcode = 2;",
             "module$testcode.foo = f$$module$testcode;",
@@ -156,14 +157,12 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "var f = 1;\nexport {f as default};",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var f$$module$testcode = 1;",
             "module$testcode.default = f$$module$testcode;"));
 
     testModules(
         "var f = 1;\nexport {f as class};",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var f$$module$testcode = 1;",
             "module$testcode.class = f$$module$testcode;"));
   }
@@ -172,7 +171,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "/** @constructor */\nexport function F() { return '';}",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "/** @constructor */",
             "function F$$module$testcode() { return ''; }",
             "module$testcode.F = F$$module$testcode"));
@@ -180,7 +178,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "/** @return {string} */\nexport function f() { return '';}",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "/** @return {string} */",
             "function f$$module$testcode() { return ''; }",
             "module$testcode.f = f$$module$testcode"));
@@ -188,7 +185,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "/** @return {string} */\nexport var f = function() { return '';}",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "/** @return {string} */",
             "var f$$module$testcode = function() { return ''; }",
             "module$testcode.f = f$$module$testcode"));
@@ -196,7 +192,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "/** @type {number} */\nexport var x = 3",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "/** @type {number} */",
             "var x$$module$testcode = 3;",
             "module$testcode.x = x$$module$testcode"));
@@ -206,7 +201,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         LINE_JOINER.join("import {name as n} from './other.js';", "use(n);", "export {n as name};"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "use(module$other.name);",
             "module$testcode.name = module$other.name;"));
@@ -219,7 +213,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
             "export {default} from './other.js';",
             "export {class} from './other.js';"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "module$testcode.name = module$other.name;",
             "module$testcode.default = module$other.default;",
@@ -228,7 +221,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export {a, b as c, d} from './other.js';",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "module$testcode.a = module$other.a;",
             "module$testcode.c = module$other.b;",
@@ -237,7 +229,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export {a as b, b as a} from './other.js';",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "module$testcode.b = module$other.a;",
             "module$testcode.a = module$other.b;"));
@@ -248,7 +239,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
             "export {a as a2, default as b} from './other.js';",
             "export {class as switch} from './other.js';"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "module$testcode.a = module$other.default;",
             "module$testcode.a2 = module$other.a;",
@@ -260,14 +250,12 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export default 'someString';",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var $jscompDefaultExport$$module$testcode = 'someString';",
             "module$testcode.default = $jscompDefaultExport$$module$testcode;"));
 
     testModules(
         "var x = 5;\nexport default x;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var x$$module$testcode = 5;",
             "var $jscompDefaultExport$$module$testcode = x$$module$testcode;",
             "module$testcode.default = $jscompDefaultExport$$module$testcode;"));
@@ -275,7 +263,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export default function f(){};\n var x = f();",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "function f$$module$testcode() {}",
             "var x$$module$testcode = f$$module$testcode();",
             "module$testcode.default = f$$module$testcode;"));
@@ -283,7 +270,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export default class Foo {};\n var x = new Foo;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "class Foo$$module$testcode {}",
             "var x$$module$testcode = new Foo$$module$testcode;",
             "module$testcode.default = Foo$$module$testcode;"));
@@ -293,14 +279,12 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export default class {};",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var $jscompDefaultExport$$module$testcode = class {};",
             "module$testcode.default = $jscompDefaultExport$$module$testcode;"));
 
     testModules(
         "export default function() {}",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var $jscompDefaultExport$$module$testcode = function() {}",
             "module$testcode.default = $jscompDefaultExport$$module$testcode;"));
   }
@@ -328,7 +312,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
             "  useParent(parent) {}",
             "}"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "class Child$$module$testcode extends module$other.Parent {",
             "  /** @param {Parent$$module$other} parent */",
@@ -342,7 +325,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
         LINE_JOINER.join(
             "export class Child {", "  /** @param {Child} child */", "  useChild(child) {}", "}"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "class Child$$module$testcode {",
             "  /** @param {Child$$module$testcode} child */",
             "  useChild(child) {}",
@@ -356,7 +338,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
             "  useBaz(baz) {}",
             "}"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "class Child$$module$testcode {",
             "  /** @param {Child$$module$testcode.Foo.Bar.Baz} baz */",
             "  useBaz(baz) {}",
@@ -370,7 +351,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
         LINE_JOINER.join(
             "export class Foo {", "  /** @param {./other.Baz} baz */", "  useBaz(baz) {}", "}"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "class Foo$$module$testcode {",
             "  /** @param {module$other.Baz} baz */",
             "  useBaz(baz) {}",
@@ -384,7 +364,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
             "  useBaz(baz) {}",
             "}"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "class Foo$$module$testcode {",
             "  /** @param {module$other.Baz} baz */",
             "  useBaz(baz) {}",
@@ -412,7 +391,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
         LINE_JOINER.join(
             "import './other.js';", "/** @typedef {string|!Object} */", "export var UnionType;"),
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('module$other');",
             "/** @typedef {string|!Object} */",
             "var UnionType$$module$testcode;",
@@ -454,7 +432,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "goog.require('foo.bar');\nexport var x;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('foo.bar');",
             "var x$$module$testcode;",
             "module$testcode.x = x$$module$testcode"));
@@ -462,7 +439,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export var x;\n goog.require('foo.bar');",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var x$$module$testcode;",
             "goog.require('foo.bar');",
             "module$testcode.x = x$$module$testcode"));
@@ -480,7 +456,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "const bar = goog.require('foo.bar')\nexport var x;",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "goog.require('foo.bar');",
             "const bar$$module$testcode = foo.bar;",
             "var x$$module$testcode;",
@@ -489,7 +464,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
     testModules(
         "export var x\nconst bar = goog.require('foo.bar');",
         LINE_JOINER.join(
-            "goog.provide('module$testcode');",
             "var x$$module$testcode;",
             "goog.require('foo.bar');",
             "const bar$$module$testcode = foo.bar;",
@@ -560,6 +534,7 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
         LINE_JOINER.join(
             "goog.require('other.Foo');",
             "use(other.Foo)"));
+
     testModules(
         LINE_JOINER.join(
             "import {x, y} from 'goog:other.Foo';",
@@ -568,6 +543,7 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
         LINE_JOINER.join(
             "goog.require('other.Foo');",
             "use(other.Foo.x);\n use(other.Foo.y);"));
+
     testModules(
         LINE_JOINER.join(
             "import Foo from 'goog:other.Foo';",
@@ -637,6 +613,6 @@ public final class Es6RewriteModulesTest extends CompilerTestCase {
                     "goog.provide('module$mod$name');")),
             SourceFile.fromCode(
                 Compiler.joinPathParts("base", "test", "sub.js"),
-                "goog.require('module$mod$name');")));
+                "goog.provide('module$test$sub'); goog.require('module$mod$name');")));
   }
 }
diff --git a/test/com/google/javascript/jscomp/IntegrationTest.java b/test/com/google/javascript/jscomp/IntegrationTest.java
index 1cd22d7c6..3c4ad25e9 100644
--- a/test/com/google/javascript/jscomp/IntegrationTest.java
+++ b/test/com/google/javascript/jscomp/IntegrationTest.java
@@ -679,7 +679,7 @@ public final class IntegrationTest extends IntegrationTestCase {
           "import {x} from './i1'; alert(x);", "export var x = 5;",
         },
         new String[] {
-          "goog.require('module$i1'); alert(module$i1.x);",
+          "goog.provide('module$i0'); goog.require('module$i1'); alert(module$i1.x);",
           "goog.provide('module$i1'); var x$$module$i1 = 5; module$i1.x = x$$module$i1;",
         });
   }
