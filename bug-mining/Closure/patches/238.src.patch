diff --git a/build.xml b/build.xml
index b49159062..c18b0eb87 100644
--- a/build.xml
+++ b/build.xml
@@ -307,6 +307,7 @@
       <fileset dir="${build.dir}" includes="externs.zip" />
       <zipfileset src="${lib.dir}/args4j.jar"/>
       <zipfileset src="${lib.dir}/guava.jar"/>
+      <zipfileset src="${lib.dir}/json.jar"/>
       <zipfileset src="${lib.dir}/jsr305.jar"/>
       <zipfileset src="${lib.dir}/protobuf-java.jar"/>
 
diff --git a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
index faab91796..7bc173079 100644
--- a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
@@ -52,8 +52,8 @@ import java.util.ArrayList;
 import java.util.Collections;
 import java.util.List;
 import java.util.Map;
-import java.util.Set;
 import java.util.Map.Entry;
+import java.util.Set;
 import java.util.logging.Level;
 
 /**
@@ -211,6 +211,7 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
   static DependencyOptions createDependencyOptions(
       boolean manageClosureDependencies,
       boolean onlyClosureDependencies,
+      boolean processCommonJSModules,
       List<String> closureEntryPoints)
       throws FlagUsageException {
     if (onlyClosureDependencies) {
@@ -224,7 +225,14 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
           .setDependencySorting(true)
           .setMoocherDropping(true)
           .setEntryPoints(closureEntryPoints);
-    } else if (manageClosureDependencies ||
+    } else if (processCommonJSModules) {
+      return new DependencyOptions()
+        .setDependencyPruning(false)
+        .setDependencySorting(true)
+        .setMoocherDropping(false)
+        .setEntryPoints(closureEntryPoints);
+    }
+    else if (manageClosureDependencies ||
         closureEntryPoints.size() > 0) {
       return new DependencyOptions()
           .setDependencyPruning(true)
@@ -265,6 +273,7 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
     DependencyOptions depOptions = createDependencyOptions(
         config.manageClosureDependencies,
         config.onlyClosureDependencies,
+        config.processCommonJSModules,
         config.closureEntryPoints);
     if (depOptions != null) {
       options.setDependencyOptions(depOptions);
@@ -742,6 +751,14 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
 
     List<String> jsFiles = config.js;
     List<String> moduleSpecs = config.module;
+
+    boolean createCommonJsModules = false;
+    if (options.processCommonJSModules) {
+      if (moduleSpecs.size() == 1 && "auto".equals(moduleSpecs.get(0))) {
+        createCommonJsModules = true;
+        moduleSpecs.remove(0);
+      }
+    }
     if (!moduleSpecs.isEmpty()) {
       modules = createJsModules(moduleSpecs, jsFiles);
       if (config.skipNormalOutputs) {
@@ -757,6 +774,11 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
         result = compiler.compile(externs, inputs, options);
       }
     }
+    if (createCommonJsModules) {
+      // For CommonJS modules construct modules from actual inputs.
+      modules = Lists.newArrayList(compiler.getDegenerateModuleGraph()
+          .getAllModules());
+    }
 
     int errCode = processResults(result, modules, options);
     // Flush the output if we are writing to a file.
@@ -817,8 +839,10 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
       // Output the manifest and bundle files if requested.
       outputManifest();
       outputBundle();
+      outputModuleGraphJson();
       return 0;
     } else if (result.success) {
+      outputModuleGraphJson();
       if (modules == null) {
         writeOutput(
             jsOutput, compiler, compiler.toSource(), config.outputWrapper,
@@ -1430,6 +1454,27 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
     }
   }
 
+  /**
+   * Creates a file containing the current module graph in JSON serialization.
+   */
+  private void outputModuleGraphJson() throws IOException {
+    if (config.outputModuleDependencies != null &&
+        config.outputModuleDependencies != "") {
+      Writer out = fileNameToOutputWriter2(config.outputModuleDependencies);
+      printModuleGraphJsonTo(compiler.getDegenerateModuleGraph(), out);
+      out.close();
+    }
+  }
+
+  /**
+   * Prints the current module graph as JSON.
+   */
+  @VisibleForTesting
+  void printModuleGraphJsonTo(JSModuleGraph graph,
+      Appendable out) throws IOException {
+    out.append(compiler.getDegenerateModuleGraph().toJson().toString());
+  }
+
   /**
    * Prints a set of modules to the manifest or bundle file.
    */
@@ -1955,6 +2000,18 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
       return this;
     }
 
+    private String outputModuleDependencies = null;
+
+    /**
+     * Sets whether a JSON file representing the dependencies between modules
+     * should be created.
+     */
+    CommandLineConfig setOutputModuleDependencies(String
+        outputModuleDependencies) {
+      this.outputModuleDependencies = outputModuleDependencies;
+      return this;
+    }
+
     private List<String> outputBundles = ImmutableList.of();
 
     /**
diff --git a/src/com/google/javascript/jscomp/CommandLineRunner.java b/src/com/google/javascript/jscomp/CommandLineRunner.java
index baf03e26a..d935a45a6 100644
--- a/src/com/google/javascript/jscomp/CommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/CommandLineRunner.java
@@ -151,7 +151,9 @@ public class CommandLineRunner extends
         + "unique. Each dep is the name of a module that this module "
         + "depends on. Modules must be listed in dependency order, and JS "
         + "source files must be listed in the corresponding order. Where "
-        + "--module flags occur in relation to --js flags is unimportant")
+        + "--module flags occur in relation to --js flags is unimportant. "
+        + "Provide the value 'auto' to trigger module creation from CommonJS"
+        + "modules.")
     private List<String> module = Lists.newArrayList();
 
     @Option(name = "--variable_map_input_file",
@@ -372,6 +374,10 @@ public class CommandLineRunner extends
         + "a manifest for each module.")
     private String output_manifest = "";
 
+    @Option(name = "--output_module_dependencies",
+        usage = "Prints out a JSON file of dependencies between modules.")
+    private String output_module_dependencies = "";
+
     @Option(name = "--accept_const_keyword",
         usage = "Allows usage of const keyword.")
     private boolean accept_const_keyword = false;
@@ -732,6 +738,7 @@ public class CommandLineRunner extends
           .setOnlyClosureDependencies(flags.only_closure_dependencies)
           .setClosureEntryPoints(flags.closure_entry_point)
           .setOutputManifest(ImmutableList.of(flags.output_manifest))
+          .setOutputModuleDependencies(flags.output_module_dependencies)
           .setAcceptConstKeyword(flags.accept_const_keyword)
           .setLanguageIn(flags.language_in)
           .setProcessCommonJSModules(flags.process_common_js_modules)
diff --git a/src/com/google/javascript/jscomp/Compiler.java b/src/com/google/javascript/jscomp/Compiler.java
index c8e1974f6..e3a39985f 100644
--- a/src/com/google/javascript/jscomp/Compiler.java
+++ b/src/com/google/javascript/jscomp/Compiler.java
@@ -28,6 +28,7 @@ import com.google.javascript.jscomp.CompilerOptions.DevMode;
 import com.google.javascript.jscomp.CompilerOptions.LanguageMode;
 import com.google.javascript.jscomp.ReferenceCollectingCallback.ReferenceCollection;
 import com.google.javascript.jscomp.Scope.Var;
+import com.google.javascript.jscomp.deps.SortedDependencies;
 import com.google.javascript.jscomp.deps.SortedDependencies.CircularDependencyException;
 import com.google.javascript.jscomp.deps.SortedDependencies.MissingProvideException;
 import com.google.javascript.jscomp.parsing.Config;
@@ -1527,7 +1528,16 @@ public class Compiler extends AbstractCompiler {
             options.dependencyOptions, inputs)) {
           modules.add(modulesByInput.get(input));
         }
+        JSModule root = new JSModule("root");
+        for (JSModule m : modules) {
+          m.addDependency(root);
+        }
+        modules.add(0, root);
+        SortedDependencies<JSModule> sorter =
+          new SortedDependencies<JSModule>(modules);
+        modules = sorter.getDependenciesOf(modules, true);
         this.modules = modules;
+
         this.moduleGraph = new JSModuleGraph(modules);
       } catch (Exception e) {
         Throwables.propagate(e);
diff --git a/src/com/google/javascript/jscomp/JSModuleGraph.java b/src/com/google/javascript/jscomp/JSModuleGraph.java
index c5e89b4e7..114ad2a1a 100644
--- a/src/com/google/javascript/jscomp/JSModuleGraph.java
+++ b/src/com/google/javascript/jscomp/JSModuleGraph.java
@@ -17,6 +17,7 @@
 package com.google.javascript.jscomp;
 
 import com.google.common.base.Preconditions;
+import com.google.common.base.Throwables;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Iterables;
 import com.google.common.collect.LinkedHashMultimap;
@@ -40,6 +41,10 @@ import java.util.Map;
 import java.util.Set;
 import java.util.TreeSet;
 
+import org.json.JSONArray;
+import org.json.JSONException;
+import org.json.JSONObject;
+
 /**
  * A {@link JSModule} dependency graph that assigns a depth to each module and
  * can answer depth-related queries about them. For the purposes of this class,
@@ -130,6 +135,44 @@ public class JSModuleGraph {
     return Iterables.getOnlyElement(modulesByDepth.get(0));
   }
 
+  /**
+   * Returns a JSON representation of the JSModuleGraph. Specifically a
+   * JSONArray of "Modules" where each module has a
+   * - "name"
+   * - "dependencies" (list of module names)
+   * - "transitive-dependencies" (list of module names, deepest first)
+   * - "inputs" (list of file names)
+   * @return List of module JSONObjects.
+   */
+  JSONArray toJson() {
+    JSONArray modules = new JSONArray();
+    for (JSModule module : getAllModules()) {
+      JSONObject node = new JSONObject();
+      try {
+        node.put("name", module.getName());
+        JSONArray deps = new JSONArray();
+        node.put("dependencies", deps);
+        for (JSModule m : module.getDependencies()) {
+          deps.put(m.getName());
+        }
+        JSONArray transitiveDeps = new JSONArray();
+        node.put("transitive-dependencies", transitiveDeps);
+        for (JSModule m : getTransitiveDepsDeepestFirst(module)) {
+          transitiveDeps.put(m.getName());
+        }
+        JSONArray inputs = new JSONArray();
+        node.put("inputs", inputs);
+        for (CompilerInput input : module.getInputs()) {
+          inputs.put(input.getSourceFile().getOriginalPath());
+        }
+        modules.put(node);
+      } catch (JSONException e) {
+        Throwables.propagate(e);
+      }
+    }
+    return modules;
+  }
+
   /**
    * Determines whether this module depends on a given module. Note that a
    * module never depends on itself, as that dependency would be cyclic.
diff --git a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
index 50cbc1b51..419e92e99 100644
--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
@@ -904,6 +904,17 @@ public class CommandLineRunnerTest extends TestCase {
         builder.toString());
   }
 
+  public void testOutputModuleGraphJson() throws Exception {
+    useModules = ModulePattern.STAR;
+    testSame(new String[] {
+        "var x = 3;", "var y = 5;", "var z = 7;", "var a = 9;"});
+
+    StringBuilder builder = new StringBuilder();
+    lastCommandLineRunner.printModuleGraphJsonTo(
+        lastCompiler.getModuleGraph(), builder);
+    assertTrue(builder.toString().indexOf("transitive-dependencies") != -1);
+  }
+
   public void testVersionFlag() {
     args.add("--version");
     testSame("");
@@ -1068,20 +1079,46 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testProcessCJS() {
+    useStringComparison = true;
+    args.add("--process_common_js_modules");
+    args.add("--common_js_entry_module=foo/bar");
+    setFilename(0, "foo/bar.js");
+    String expected = "var module$foo$bar={test:1};";
+    test("exports.test = 1", expected);
+    assertEquals(expected + "\n", outReader.toString());
+  }
+
+  public void testProcessCJSWithModuleOutput() {
+    useStringComparison = true;
     args.add("--process_common_js_modules");
     args.add("--common_js_entry_module=foo/bar");
+    args.add("--module=auto");
     setFilename(0, "foo/bar.js");
     test("exports.test = 1",
         "var module$foo$bar={test:1};");
+    // With modules=auto no direct output is created.
+    assertEquals("", outReader.toString());
   }
 
   public void testTransformAMDAndProcessCJS() {
+    useStringComparison = true;
+    args.add("--transform_amd_modules");
+    args.add("--process_common_js_modules");
+    args.add("--common_js_entry_module=foo/bar");
+    setFilename(0, "foo/bar.js");
+    test("define({foo: 1})",
+        "var module$foo$bar={},module$foo$bar={foo:1};");
+  }
+
+  public void testModuleJSON() {
+    useStringComparison = true;
     args.add("--transform_amd_modules");
     args.add("--process_common_js_modules");
     args.add("--common_js_entry_module=foo/bar");
+    args.add("--output_module_dependencies=test.json");
     setFilename(0, "foo/bar.js");
     test("define({foo: 1})",
-        "var module$foo$bar={}, module$foo$bar={foo:1};");
+        "var module$foo$bar={},module$foo$bar={foo:1};");
   }
 
   /* Helper functions */
diff --git a/test/com/google/javascript/jscomp/CompilerTest.java b/test/com/google/javascript/jscomp/CompilerTest.java
index 7b5555daf..86efa5018 100644
--- a/test/com/google/javascript/jscomp/CompilerTest.java
+++ b/test/com/google/javascript/jscomp/CompilerTest.java
@@ -119,14 +119,15 @@ public class CompilerTest extends TestCase {
 
     Compiler compiler = initCompilerForCommonJS(inputs, entryPoints);
     JSModuleGraph graph = compiler.getModuleGraph();
-    assertEquals(graph.getModuleCount(), 3);
+    assertEquals(4, graph.getModuleCount());
     List<CompilerInput> result = graph.manageDependencies(entryPoints,
         compiler.getInputsForTesting());
-    assertEquals("[module$tonic]", result.get(0).getName());
-    assertEquals("[module$gin]", result.get(1).getName());
-    assertEquals("tonic.js", result.get(2).getName());
-    assertEquals("gin.js", result.get(3).getName());
-    assertEquals("mix.js", result.get(4).getName());
+    assertEquals("[root]", result.get(0).getName());
+    assertEquals("[module$tonic]", result.get(1).getName());
+    assertEquals("[module$gin]", result.get(2).getName());
+    assertEquals("tonic.js", result.get(3).getName());
+    assertEquals("gin.js", result.get(4).getName());
+    assertEquals("mix.js", result.get(5).getName());
   }
 
   public void testCommonJSMissingRequire() throws Exception {
diff --git a/test/com/google/javascript/jscomp/JSModuleGraphTest.java b/test/com/google/javascript/jscomp/JSModuleGraphTest.java
index 4cc58c5cd..144c7facc 100644
--- a/test/com/google/javascript/jscomp/JSModuleGraphTest.java
+++ b/test/com/google/javascript/jscomp/JSModuleGraphTest.java
@@ -24,6 +24,10 @@ import junit.framework.*;
 
 import java.util.*;
 
+import org.json.JSONArray;
+import org.json.JSONException;
+import org.json.JSONObject;
+
 /**
  * Tests for {@link JSModuleGraph}
  *
@@ -235,6 +239,24 @@ public class JSModuleGraphTest extends TestCase {
     assertTrue(results.isEmpty());
   }
 
+  public void testToJson() throws JSONException {
+    JSONArray modules = graph.toJson();
+    assertEquals(6, modules.length());
+    for (int i = 0; i < modules.length(); i++) {
+      JSONObject m = modules.getJSONObject(i);
+      assertNotNull(m.getString("name"));
+      assertNotNull(m.getJSONArray("dependencies"));
+      assertNotNull(m.getJSONArray("transitive-dependencies"));
+      assertNotNull(m.getJSONArray("inputs"));
+    }
+    JSONObject m = modules.getJSONObject(3);
+    assertEquals("D", m.getString("name"));
+    assertEquals("[\"B\"]", m.getJSONArray("dependencies").toString());
+    assertEquals(2,
+        m.getJSONArray("transitive-dependencies").length());
+    assertEquals("[]", m.getJSONArray("inputs").toString());
+  }
+
   private List<CompilerInput> setUpManageDependenciesTest() {
     List<CompilerInput> inputs = Lists.newArrayList();
 
diff --git a/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java b/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java
index 43bc8ede6..fc1dc556d 100644
--- a/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java
+++ b/test/com/google/javascript/jscomp/ProcessCommonJSModulesTest.java
@@ -16,6 +16,11 @@
 
 package com.google.javascript.jscomp;
 
+import java.util.List;
+
+import com.google.common.collect.ImmutableList;
+import com.google.common.collect.Lists;
+
 /**
  * Unit tests for {@link ProcessCommonJSModules}
  */
@@ -134,4 +139,48 @@ public class ProcessCommonJSModulesTest extends CompilerTestCase {
     assertEquals("module$bar$baz",
         pass.guessCJSModuleName("foo\\bar\\baz.js"));
   }
+
+  public void testSortInputs() throws Exception {
+    SourceFile a = SourceFile.fromCode("a.js",
+            "require('b');require('c')");
+    SourceFile b = SourceFile.fromCode("b.js",
+            "require('d')");
+    SourceFile c = SourceFile.fromCode("c.js",
+            "require('d')");
+    SourceFile d = SourceFile.fromCode("d.js", "1;");
+
+    assertSortedInputs(
+        ImmutableList.of(d, b, c, a),
+        ImmutableList.of(a, b, c, d));
+    assertSortedInputs(
+        ImmutableList.of(d, b, c, a),
+        ImmutableList.of(d, b, c, a));
+    assertSortedInputs(
+        ImmutableList.of(d, c, b, a),
+        ImmutableList.of(d, c, b, a));
+    assertSortedInputs(
+        ImmutableList.of(d, b, c, a),
+        ImmutableList.of(d, a, b, c));
+  }
+
+  private void assertSortedInputs(
+      List<SourceFile> expected, List<SourceFile> shuffled)
+      throws Exception {
+    Compiler compiler = new Compiler(System.err);
+    compiler.initCompilerOptionsIfTesting();
+    compiler.getOptions().setProcessCommonJSModules(true);
+    compiler.getOptions().dependencyOptions.setEntryPoints(
+        Lists.newArrayList(ProcessCommonJSModules.toModuleName("a")));
+    compiler.compile(Lists.newArrayList(SourceFile.fromCode("externs.js", "")),
+        shuffled, compiler.getOptions());
+
+    List<SourceFile> result = Lists.newArrayList();
+    for (JSModule m : compiler.getModuleGraph().getAllModules()) {
+      for (CompilerInput i : m.getInputs()) {
+        result.add(i.getSourceFile());
+      }
+    }
+
+    assertEquals(expected, result);
+  }
 }
