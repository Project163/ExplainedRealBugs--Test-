diff --git a/.classpath b/.classpath
index 7e0fc093c..43f903eaf 100644
--- a/.classpath
+++ b/.classpath
@@ -1,14 +1,15 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<classpath>
-	<classpathentry kind="src" path="gen"/>
-	<classpathentry kind="src" path="src"/>
-	<classpathentry kind="src" path="test"/>
-	<classpathentry kind="lib" path="lib/google_common_deploy.jar"/>
-	<classpathentry kind="lib" path="lib/protobuf_deploy.jar"/>
-	<classpathentry kind="lib" path="lib/libtrunk_rhino_parser_jarjared.jar"/>
-	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER"/>
-	<classpathentry kind="lib" path="lib/ant_deploy.jar"/>
-	<classpathentry kind="lib" path="lib/junit4-core.jar"/>
-	<classpathentry kind="lib" path="lib/junit4-legacy.jar"/>
-	<classpathentry kind="output" path="build/classes"/>
-</classpath>
+<?xml version="1.0" encoding="UTF-8"?>
+<classpath>
+        <classpathentry kind="src" path="gen"/>
+        <classpathentry kind="src" path="src"/>
+        <classpathentry kind="src" path="test"/>
+        <classpathentry kind="lib" path="lib/google_common_deploy.jar"/>
+        <classpathentry kind="lib" path="lib/protobuf_deploy.jar"/>
+        <classpathentry kind="lib" path="lib/libtrunk_rhino_parser_jarjared.jar"/>
+        <classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER"/>
+        <classpathentry kind="lib" path="lib/ant_deploy.jar"/>
+        <classpathentry kind="lib" path="lib/args4j_deploy.jar"/>
+        <classpathentry kind="lib" path="lib/junit4-core.jar"/>
+        <classpathentry kind="lib" path="lib/junit4-legacy.jar"/>
+        <classpathentry kind="output" path="build/classes"/>
+</classpath>
diff --git a/build.xml b/build.xml
index ecf8d3b32..b29ccf5df 100644
--- a/build.xml
+++ b/build.xml
@@ -23,7 +23,6 @@
   <property name="build.dir" value="${basedir}/build" />
   <property name="classes.dir" value="${build.dir}/classes" />
   <property name="testClasses.dir" value="${build.dir}/test" />
-  <property name="flags.xml" value="${build.dir}/flags.xml" />
   <property name="javadoc.dir" value="${build.dir}/javadoc" />
   <property name="stylesheetfile" value="" />
   <property name="lib.dir" value="${basedir}/lib" />
@@ -73,33 +72,17 @@
           todir="${classes.dir}/com/google/javascript/jscomp/js" />
   </target>
 
-  <target name="apt">
-    <mkdir dir="${build.dir}" />
-    <apt srcdir="${src.dir}"
-         compile="false"
-         factory="com.google.common.flags.FlagProcessorFactory"
-         >
-      <classpath>
-        <pathelement location="${lib.dir}/google_common_deploy.jar" />
-        <pathelement location="${tools.dir}/FlagProcessorFactory_deploy.jar" />
-      </classpath>
-      <compilerarg value="-Aflags.path=${flags.xml}" />
-    </apt>
-  </target>
-
   <target name="jar"
-          depends="compile,apt"
+          depends="compile"
           description="package compiler as an executable jar">
     <zip destfile="${build.dir}/externs.zip" basedir="${externs.dir}" />
     <jar destfile="${jarfile}" update="true">
-      <zipfileset src="${lib.dir}/google_common_deploy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/protobuf_deploy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/libtrunk_rhino_parser_jarjared.jar"
-                  excludes="flags.xml" />
+      <zipfileset src="${lib.dir}/args4j_deploy.jar" />
+      <zipfileset src="${lib.dir}/google_common_deploy.jar" />
+      <zipfileset src="${lib.dir}/protobuf_deploy.jar" />
+      <zipfileset src="${lib.dir}/libtrunk_rhino_parser_jarjared.jar" />
       <fileset dir="${classes.dir}" />
-      <fileset dir="${build.dir}" includes="flags.xml,externs.zip" />
+      <fileset dir="${build.dir}" includes="externs.zip" />
       <manifest>
         <attribute name="Main-Class"
                    value="com.google.javascript.jscomp.CommandLineRunner" />
@@ -119,23 +102,17 @@
   </target>
 
   <target name="all-classes-jar"
-          depends="compile,compile-tests,apt"
+          depends="compile,compile-tests"
           description="package the compiler and its tests into one jar">
     <jar destfile="${jarfile}" update="true">
-      <zipfileset src="${lib.dir}/ant_deploy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/junit4-core.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/junit4-legacy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/hamcrest-core-1.1.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/google_common_deploy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/protobuf_deploy.jar"
-                  excludes="flags.xml" />
-      <zipfileset src="${lib.dir}/libtrunk_rhino_parser_jarjared.jar"
-                  excludes="flags.xml" />
+      <zipfileset src="${lib.dir}/ant_deploy.jar" />
+      <zipfileset src="${lib.dir}/args4j_deploy.jar" />
+      <zipfileset src="${lib.dir}/junit4-core.jar" />
+      <zipfileset src="${lib.dir}/junit4-legacy.jar" />
+      <zipfileset src="${lib.dir}/hamcrest-core-1.1.jar" />
+      <zipfileset src="${lib.dir}/google_common_deploy.jar" />
+      <zipfileset src="${lib.dir}/protobuf_deploy.jar" />
+      <zipfileset src="${lib.dir}/libtrunk_rhino_parser_jarjared.jar" />
       <fileset dir="${classes.dir}" />
       <fileset dir="${testClasses.dir}" />
     </jar>
diff --git a/javadoc/com/google/javascript/jscomp/CommandLineRunner.html b/javadoc/com/google/javascript/jscomp/CommandLineRunner.html
index 4411787f8..b3239cab0 100644
--- a/javadoc/com/google/javascript/jscomp/CommandLineRunner.html
+++ b/javadoc/com/google/javascript/jscomp/CommandLineRunner.html
@@ -73,9 +73,9 @@ function windowTitle()
 </TR>
 <TR>
 <TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
-  SUMMARY:&nbsp;<A HREF="#nested_class_summary">NESTED</A>&nbsp;|&nbsp;<A HREF="#field_summary">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
+  SUMMARY:&nbsp;<A HREF="#nested_class_summary">NESTED</A>&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
 <TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
-DETAIL:&nbsp;<A HREF="#field_detail">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
+DETAIL:&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
 </TR>
 </TABLE>
 <A NAME="skip-navbar_top"></A>
@@ -144,31 +144,6 @@ CommandLineRunner translates flags into Java API calls on the Compiler.
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;An exception thrown when command-line flags are used incorrectly.</TD>
 </TR>
 </TABLE>
-&nbsp;<!-- =========== FIELD SUMMARY =========== -->
-
-<A NAME="field_summary"><!-- --></A>
-<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
-<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
-<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
-<B>Field Summary</B></FONT></TH>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>static&nbsp;com.google.common.flags.Flag&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/util/List.html?is-external=true" title="class or interface in java.util">List</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&gt;</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../com/google/javascript/jscomp/CommandLineRunner.html#FLAG_externs">FLAG_externs</A></B></CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>static&nbsp;com.google.common.flags.Flag&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../com/google/javascript/jscomp/CommandLineRunner.html#FLAG_logging_level">FLAG_logging_level</A></B></CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
-</TR>
-</TABLE>
 &nbsp;
 <!-- ======== CONSTRUCTOR SUMMARY ======== -->
 
@@ -241,6 +216,14 @@ CommandLineRunner translates flags into Java API calls on the Compiler.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
+<CODE>protected &nbsp;com.google.javascript.jscomp.AbstractCommandLineRunner.CommandLineConfig</CODE></FONT></TD>
+<TD><CODE><B><A HREF="../../../../com/google/javascript/jscomp/CommandLineRunner.html#getCommandLineConfig()">getCommandLineConfig</A></B>()</CODE>
+
+<BR>
+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get the command line config, so that it can be initialized.</TD>
+</TR>
+<TR BGCOLOR="white" CLASS="TableRowColor">
+<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>protected &nbsp;A</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../com/google/javascript/jscomp/CommandLineRunner.html#getCompiler()">getCompiler</A></B>()</CODE>
 
@@ -310,35 +293,6 @@ CommandLineRunner translates flags into Java API calls on the Compiler.
 &nbsp;
 <P>
 
-<!-- ============ FIELD DETAIL =========== -->
-
-<A NAME="field_detail"><!-- --></A>
-<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
-<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
-<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
-<B>Field Detail</B></FONT></TH>
-</TR>
-</TABLE>
-
-<A NAME="FLAG_logging_level"><!-- --></A><H3>
-FLAG_logging_level</H3>
-<PRE>
-public static final com.google.common.flags.Flag&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt; <B>FLAG_logging_level</B></PRE>
-<DL>
-<DL>
-</DL>
-</DL>
-<HR>
-
-<A NAME="FLAG_externs"><!-- --></A><H3>
-FLAG_externs</H3>
-<PRE>
-public static final com.google.common.flags.Flag&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/util/List.html?is-external=true" title="class or interface in java.util">List</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&gt; <B>FLAG_externs</B></PRE>
-<DL>
-<DL>
-</DL>
-</DL>
-
 <!-- ========= CONSTRUCTOR DETAIL ======== -->
 
 <A NAME="constructor_detail"><!-- --></A>
@@ -352,12 +306,17 @@ public static final com.google.common.flags.Flag&lt;<A HREF="http://java.sun.com
 <A NAME="CommandLineRunner(java.lang.String[])"><!-- --></A><H3>
 CommandLineRunner</H3>
 <PRE>
-protected <B>CommandLineRunner</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>[]&nbsp;args)</PRE>
+protected <B>CommandLineRunner</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>[]&nbsp;args)
+                     throws org.kohsuke.args4j.CmdLineException</PRE>
 <DL>
 <DD>Create a new command-line runner. You should only need to call
  the constructor if you're extending this class. Otherwise, the main
  method should instantiate it.
 <P>
+<DL>
+
+<DT><B>Throws:</B>
+<DD><CODE>org.kohsuke.args4j.CmdLineException</CODE></DL>
 </DL>
 <HR>
 
@@ -366,8 +325,13 @@ CommandLineRunner</H3>
 <PRE>
 protected <B>CommandLineRunner</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>[]&nbsp;args,
                             <A HREF="http://java.sun.com/javase/6/docs/api/java/io/PrintStream.html?is-external=true" title="class or interface in java.io">PrintStream</A>&nbsp;out,
-                            <A HREF="http://java.sun.com/javase/6/docs/api/java/io/PrintStream.html?is-external=true" title="class or interface in java.io">PrintStream</A>&nbsp;err)</PRE>
+                            <A HREF="http://java.sun.com/javase/6/docs/api/java/io/PrintStream.html?is-external=true" title="class or interface in java.io">PrintStream</A>&nbsp;err)
+                     throws org.kohsuke.args4j.CmdLineException</PRE>
 <DL>
+<DL>
+
+<DT><B>Throws:</B>
+<DD><CODE>org.kohsuke.args4j.CmdLineException</CODE></DL>
 </DL>
 
 <!-- ============ METHOD DETAIL ========== -->
@@ -447,6 +411,19 @@ public static void <B>main</B>(<A HREF="http://java.sun.com/javase/6/docs/api/ja
 </DL>
 <HR>
 
+<A NAME="getCommandLineConfig()"><!-- --></A><H3>
+getCommandLineConfig</H3>
+<PRE>
+protected com.google.javascript.jscomp.AbstractCommandLineRunner.CommandLineConfig <B>getCommandLineConfig</B>()</PRE>
+<DL>
+<DD>Get the command line config, so that it can be initialized.
+<P>
+<DD><DL>
+</DL>
+</DD>
+</DL>
+<HR>
+
 <A NAME="getDiagnoticGroups()"><!-- --></A><H3>
 getDiagnoticGroups</H3>
 <PRE>
@@ -592,9 +569,9 @@ protected int <B>doRun</B>()
 </TR>
 <TR>
 <TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
-  SUMMARY:&nbsp;<A HREF="#nested_class_summary">NESTED</A>&nbsp;|&nbsp;<A HREF="#field_summary">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
+  SUMMARY:&nbsp;<A HREF="#nested_class_summary">NESTED</A>&nbsp;|&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
 <TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
-DETAIL:&nbsp;<A HREF="#field_detail">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
+DETAIL:&nbsp;FIELD&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
 </TR>
 </TABLE>
 <A NAME="skip-navbar_bottom"></A>
diff --git a/javadoc/index-all.html b/javadoc/index-all.html
index 683c7baf8..206812da2 100644
--- a/javadoc/index-all.html
+++ b/javadoc/index-all.html
@@ -1840,12 +1840,6 @@ Constructor for class com.google.javascript.jscomp.graph.<A HREF="./com/google/j
 <DT><A HREF="./com/google/javascript/jscomp/graph/FixedPointGraphTraversal.EdgeCallback.html" title="interface in com.google.javascript.jscomp.graph"><B>FixedPointGraphTraversal.EdgeCallback</B></A>&lt;<A HREF="./com/google/javascript/jscomp/graph/FixedPointGraphTraversal.EdgeCallback.html" title="type parameter in FixedPointGraphTraversal.EdgeCallback">Node</A>,<A HREF="./com/google/javascript/jscomp/graph/FixedPointGraphTraversal.EdgeCallback.html" title="type parameter in FixedPointGraphTraversal.EdgeCallback">Edge</A>&gt; - Interface in <A HREF="./com/google/javascript/jscomp/graph/package-summary.html">com.google.javascript.jscomp.graph</A><DD>&nbsp;<DT><A HREF="./com/google/javascript/rhino/Node.html#FIXUPS_PROP"><B>FIXUPS_PROP</B></A> - 
 Static variable in class com.google.javascript.rhino.<A HREF="./com/google/javascript/rhino/Node.html" title="class in com.google.javascript.rhino">Node</A>
 <DD>&nbsp;
-<DT><A HREF="./com/google/javascript/jscomp/CommandLineRunner.html#FLAG_externs"><B>FLAG_externs</B></A> - 
-Static variable in class com.google.javascript.jscomp.<A HREF="./com/google/javascript/jscomp/CommandLineRunner.html" title="class in com.google.javascript.jscomp">CommandLineRunner</A>
-<DD>&nbsp;
-<DT><A HREF="./com/google/javascript/jscomp/CommandLineRunner.html#FLAG_logging_level"><B>FLAG_logging_level</B></A> - 
-Static variable in class com.google.javascript.jscomp.<A HREF="./com/google/javascript/jscomp/CommandLineRunner.html" title="class in com.google.javascript.jscomp">CommandLineRunner</A>
-<DD>&nbsp;
 <DT><A HREF="./com/google/javascript/jscomp/CompilerOptions.html#flowSensitiveInlineVariables"><B>flowSensitiveInlineVariables</B></A> - 
 Variable in class com.google.javascript.jscomp.<A HREF="./com/google/javascript/jscomp/CompilerOptions.html" title="class in com.google.javascript.jscomp">CompilerOptions</A>
 <DD>&nbsp;
diff --git a/lib/args4j_deploy.jar b/lib/args4j_deploy.jar
new file mode 100755
index 000000000..c1c562385
Binary files /dev/null and b/lib/args4j_deploy.jar differ
diff --git a/lib/google_common_deploy.jar b/lib/google_common_deploy.jar
index c4f9018db..08f45e06f 100755
Binary files a/lib/google_common_deploy.jar and b/lib/google_common_deploy.jar differ
diff --git a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
index 3d3497a95..b34a49646 100644
--- a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
@@ -23,10 +23,6 @@ import com.google.common.base.Preconditions;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Lists;
 import com.google.common.collect.Maps;
-import com.google.common.flags.DocLevel;
-import com.google.common.flags.Flag;
-import com.google.common.flags.FlagSpec;
-import com.google.common.flags.Flags;
 import com.google.javascript.rhino.Node;
 import com.google.javascript.rhino.TokenStream;
 import com.google.protobuf.CodedOutputStream;
@@ -94,17 +90,23 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
 
   private final RunTimeStats runTimeStats = new RunTimeStats();
 
-  AbstractCommandLineRunner(CommandLineConfig config) {
-    this(config, System.out, System.err);
+  AbstractCommandLineRunner() {
+    this(System.out, System.err);
   }
 
-  AbstractCommandLineRunner(
-      CommandLineConfig config, PrintStream out, PrintStream err) {
-    this.config = config;
+  AbstractCommandLineRunner(PrintStream out, PrintStream err) {
+    this.config = new CommandLineConfig();
     this.out = out;
     this.err = err;
   }
 
+  /**
+   * Get the command line config, so that it can be initialized.
+   */
+  protected CommandLineConfig getCommandLineConfig() {
+    return config;
+  }
+
   /**
    * Returns the instance of the Compiler to use when {@link #run()} is
    * called.
diff --git a/src/com/google/javascript/jscomp/CommandLineRunner.java b/src/com/google/javascript/jscomp/CommandLineRunner.java
index 3a0ed45d5..a5118cda8 100644
--- a/src/com/google/javascript/jscomp/CommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/CommandLineRunner.java
@@ -17,18 +17,26 @@
 package com.google.javascript.jscomp;
 
 import com.google.common.collect.Lists;
-import com.google.common.flags.DocLevel;
-import com.google.common.flags.Flag;
-import com.google.common.flags.FlagSpec;
-import com.google.common.flags.Flags;
+import com.google.common.collect.Sets;
 import com.google.common.io.LimitInputStream;
 import com.google.javascript.jscomp.AbstractCommandLineRunner.CommandLineConfig;
 
+import org.kohsuke.args4j.CmdLineException;
+import org.kohsuke.args4j.CmdLineParser;
+import org.kohsuke.args4j.Option;
+import org.kohsuke.args4j.OptionDef;
+import org.kohsuke.args4j.spi.OptionHandler;
+import org.kohsuke.args4j.spi.Parameters;
+import org.kohsuke.args4j.spi.Setter;
+
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.PrintStream;
 import java.util.List;
+import java.util.Set;
 import java.util.logging.Level;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
 import java.util.zip.ZipEntry;
 import java.util.zip.ZipInputStream;
 
@@ -61,173 +69,241 @@ import java.util.zip.ZipInputStream;
 public class CommandLineRunner extends
     AbstractCommandLineRunner<Compiler, CompilerOptions> {
 
-  @FlagSpec(help = "Prints out the parse tree and exits",
-      docLevel = DocLevel.SECRET)
-  static final Flag<Boolean> FLAG_print_tree = Flag.value(false);
-
-  @FlagSpec(help = "Runs the compile job many times, then prints out the " +
-      "best phase ordering from this run",
-      docLevel = DocLevel.SECRET)
-  static final Flag<Boolean> FLAG_compute_phase_ordering =
-      Flag.value(false);
-
-  @FlagSpec(help = "Prints a dot file describing the internal abstract syntax"
-      + " tree and exits",
-      docLevel = DocLevel.SECRET)
-  static final Flag<Boolean> FLAG_print_ast = Flag.value(false);
-
-  @FlagSpec(help = "Prints a dot file describing the passes that will get run"
-      + " and exits",
-      docLevel = DocLevel.SECRET)
-  static final Flag<Boolean> FLAG_print_pass_graph = Flag.value(false);
-
-  @FlagSpec(help = "Turns on extra sanity checks", altName = "dev_mode",
-      docLevel = DocLevel.SECRET)
-  static final Flag<CompilerOptions.DevMode> FLAG_jscomp_dev_mode =
-      Flag.value(CompilerOptions.DevMode.OFF);
-
-  // TODO(nicksantos): Make the next 2 flags package-private.
-  @FlagSpec(help = "The logging level (standard java.util.logging.Level"
-      + " values) for Compiler progress. Does not control errors or"
-      + " warnings for the JavaScript code under compilation",
-      docLevel = DocLevel.SECRET)
-  public static final Flag<String> FLAG_logging_level =
-      Flag.value(Level.WARNING.getName());
-
-  @FlagSpec(help = "The file containing javascript externs. You may specify"
-      + " multiple")
-  public static final Flag<List<String>> FLAG_externs = Flag.stringCollector();
-
-  @FlagSpec(help = "The javascript filename. You may specify multiple")
-  static final Flag<List<String>> FLAG_js = Flag.stringCollector();
-
-  @FlagSpec(help = "Primary output filename. If not specified, output is " +
-            "written to stdout")
-  static final Flag<String> FLAG_js_output_file = Flag.value("");
-
-  @FlagSpec(help = "A javascript module specification. The format is "
-      + "<name>:<num-js-files>[:[<dep>,...][:]]]. Module names must be "
-      + "unique. Each dep is the name of a module that this module "
-      + "depends on. Modules must be listed in dependency order, and js "
-      + "source files must be listed in the corresponding order. Where "
-      + "--module flags occur in relation to --js flags is unimportant")
-  static final Flag<List<String>> FLAG_module = Flag.stringCollector();
-
-  @FlagSpec(help = "File containing the serialized version of the variable "
-      + "renaming map produced by a previous compilation")
-  static final Flag<String> FLAG_variable_map_input_file =
-      Flag.value("");
-
-  @FlagSpec(help = "File containing the serialized version of the property "
-      + "renaming map produced by a previous compilation",
-      docLevel = DocLevel.SECRET)
-  static final Flag<String> FLAG_property_map_input_file =
-      Flag.value("");
-
-  @FlagSpec(help = "File where the serialized version of the variable "
-      + "renaming map produced should be saved",
-      docLevel = DocLevel.SECRET)
-  static final Flag<String> FLAG_variable_map_output_file =
-      Flag.value("");
-
-  @FlagSpec(help = "If true, variable renaming and property renaming map "
-      + "files will be produced as {binary name}_vars_map.out and "
-      + "{binary name}_props_map.out. Note that this flag cannot be used "
-      + "in conjunction with either variable_map_output_file or "
-      + "property_map_output_file",
-      docLevel = DocLevel.SECRET)
-  static final Flag<Boolean> FLAG_create_name_map_files =
-      Flag.value(false);
-
-  @FlagSpec(help = "File where the serialized version of the property "
-      + "renaming map produced should be saved")
-  static final Flag<String> FLAG_property_map_output_file =
-      Flag.value("");
-
-  @FlagSpec(help = "Check source validity but do not enforce Closure style "
-      + "rules and conventions")
-  static final Flag<Boolean> FLAG_third_party = Flag.value(false);
-
-
-  @FlagSpec(help = "Controls how detailed the compilation summary is. Values:"
-      + " 0 (never print summary), 1 (print summary only if there are "
-      + "errors or warnings), 2 (print summary if type checking is on, "
-      + "see --check_types), 3 (always print summary). The default level "
-      + "is 1")
-  static final Flag<Integer> FLAG_summary_detail_level = Flag.value(1);
-
-  @FlagSpec(help = "Interpolate output into this string at the place denoted"
-      + " by the marker token %output%. See --output_wrapper_marker")
-  static final Flag<String> FLAG_output_wrapper = Flag.value("");
-
-  @FlagSpec(help = "Use this token as output marker in the value of"
-      + " --output_wrapper")
-  static final Flag<String> FLAG_output_wrapper_marker =
-      Flag.value("%output%");
-
-  @FlagSpec(help = "An output wrapper for a javascript module (optional). "
-      + "The format is <name>:<wrapper>. The module name must correspond "
-      + "with a module specified using --module. The wrapper must "
-      + "contain %s as the code placeholder")
-  static final Flag<List<String>> FLAG_module_wrapper =
-      Flag.stringCollector();
-
-  @FlagSpec(help = "Prefix for filenames of compiled js modules. "
-      + "<module-name>.js will be appended to this prefix. Directories "
-      + "will be created as needed. Use with --module")
-  static final Flag<String> FLAG_module_output_path_prefix =
-      Flag.value("./");
-
-  @FlagSpec(help = "If specified, a source map file mapping the generated " +
-            "source files back to the original source file will be " +
-            "output to the specified path. The %outname% placeholder will " +
-            "expand to the name of the output file that the source map " +
-            "corresponds to.")
-  static final Flag<String> FLAG_create_source_map =
-      Flag.value("");
-
-  @FlagSpec(help = "Make the named class of warnings an error. Options:" +
-      DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
-  static final Flag<List<String>> FLAG_jscomp_error =
-      Flag.stringCollector();
-
-  @FlagSpec(help = "Make the named class of warnings a normal warning. " +
-                "Options:" + DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
-  static final Flag<List<String>> FLAG_jscomp_warning =
-      Flag.stringCollector();
-
-  @FlagSpec(help = "Turn off the named class of warnings. Options:" +
-      DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
-  static final Flag<List<String>> FLAG_jscomp_off =
-      Flag.stringCollector();
-
-  @FlagSpec(altName = "D",
-      help = "Override the value of a variable annotated @define. " +
-      "The format is <name>[=<val>], where <name> is the name of a @define " +
-      "variable and <val> is a boolean, number, or a single-quoted string " +
-      "that contains no single quotes. If [=<val>] is omitted, " +
-      "the variable is marked true")
-  static final Flag<List<String>> FLAG_define = Flag.stringCollector();
-
-  @FlagSpec(help = "Input charset for all files.")
-  static final Flag<String> FLAG_charset = Flag.value("");
-
-  @FlagSpec(help = "Specifies the compilation level to use. Options: " +
-            "WHITESPACE_ONLY, SIMPLE_OPTIMIZATIONS, ADVANCED_OPTIMIZATIONS")
-  static final Flag<CompilationLevel> FLAG_compilation_level
-      = Flag.value(CompilationLevel.SIMPLE_OPTIMIZATIONS);
-
-  @FlagSpec(help = "Specifies the warning level to use. Options: " +
-            "QUIET, DEFAULT, VERBOSE")
-  static final Flag<WarningLevel> FLAG_warning_level
-      = Flag.value(WarningLevel.DEFAULT);
-
-  @FlagSpec(help = "Specifies whether the default externs should be excluded")
-  static final Flag<Boolean> FLAG_use_only_custom_externs
-      = Flag.value(false);
-
-  @FlagSpec(help = "Enable debugging options")
-  static final Flag<Boolean> FLAG_debug = Flag.value(false);
+  private static class Flags {
+    @Option(name = "--print_tree",
+        handler = BooleanOptionHandler.class,
+        usage = "Prints out the parse tree and exits")
+    private boolean print_tree = false;
+
+    @Option(name = "--compute_phase_ordering",
+        handler = BooleanOptionHandler.class,
+        usage = "Runs the compile job many times, then prints out the " +
+        "best phase ordering from this run")
+    private boolean compute_phase_ordering = false;
+
+    @Option(name = "--print_ast",
+        handler = BooleanOptionHandler.class,
+        usage = "Prints a dot file describing the internal abstract syntax"
+        + " tree and exits")
+    private boolean print_ast = false;
+
+    @Option(name = "--print_pass_graph",
+        usage = "Prints a dot file describing the passes that will get run"
+        + " and exits")
+    private boolean print_pass_graph = false;
+
+    @Option(name = "--jscomp_dev_mode",
+        usage = "Turns on extra sanity checks",
+        aliases = {"--dev_mode"})
+    private CompilerOptions.DevMode jscomp_dev_mode =
+        CompilerOptions.DevMode.OFF;
+
+    // TODO(nicksantos): Make the next 2 flags package-private.
+    @Option(name = "--logging_level",
+        usage = "The logging level (standard java.util.logging.Level"
+        + " values) for Compiler progress. Does not control errors or"
+        + " warnings for the JavaScript code under compilation")
+    private String logging_level = Level.WARNING.getName();
+
+    @Option(name = "--externs",
+        usage = "The file containing javascript externs. You may specify"
+        + " multiple")
+    private List<String> externs = Lists.newArrayList();
+
+    @Option(name = "--js",
+        usage = "The javascript filename. You may specify multiple")
+    private List<String> js = Lists.newArrayList();
+
+    @Option(name = "--js_output_file",
+        usage = "Primary output filename. If not specified, output is " +
+        "written to stdout")
+    private String js_output_file = "";
+
+    @Option(name = "--module",
+        usage = "A javascript module specification. The format is "
+        + "<name>:<num-js-files>[:[<dep>,...][:]]]. Module names must be "
+        + "unique. Each dep is the name of a module that this module "
+        + "depends on. Modules must be listed in dependency order, and js "
+        + "source files must be listed in the corresponding order. Where "
+        + "--module flags occur in relation to --js flags is unimportant")
+    private List<String> module = Lists.newArrayList();
+
+    @Option(name = "--variable_map_input_file",
+        usage = "File containing the serialized version of the variable "
+        + "renaming map produced by a previous compilation")
+    private String variable_map_input_file = "";
+
+    @Option(name = "--property_map_input_file",
+        usage = "File containing the serialized version of the property "
+        + "renaming map produced by a previous compilation")
+    private String property_map_input_file = "";
+
+    @Option(name = "--variable_map_output_file",
+        usage = "File where the serialized version of the variable "
+        + "renaming map produced should be saved")
+    private String variable_map_output_file = "";
+
+    @Option(name = "--create_name_map_files",
+        handler = BooleanOptionHandler.class,
+        usage = "If true, variable renaming and property renaming map "
+        + "files will be produced as {binary name}_vars_map.out and "
+        + "{binary name}_props_map.out. Note that this flag cannot be used "
+        + "in conjunction with either variable_map_output_file or "
+        + "property_map_output_file")
+    private boolean create_name_map_files = false;
+
+    @Option(name = "--property_map_output_file",
+        usage = "File where the serialized version of the property "
+        + "renaming map produced should be saved")
+    private String property_map_output_file = "";
+
+    @Option(name = "--third_party",
+        handler = BooleanOptionHandler.class,
+        usage = "Check source validity but do not enforce Closure style "
+        + "rules and conventions")
+    private boolean third_party = false;
+
+
+    @Option(name = "--summary_detail_level",
+        usage = "Controls how detailed the compilation summary is. Values:"
+        + " 0 (never print summary), 1 (print summary only if there are "
+        + "errors or warnings), 2 (print summary if type checking is on, "
+        + "see --check_types), 3 (always print summary). The default level "
+        + "is 1")
+    private int summary_detail_level = 1;
+
+    @Option(name = "--output_wrapper",
+        usage = "Interpolate output into this string at the place denoted"
+        + " by the marker token %output%. See --output_wrapper_marker")
+    private String output_wrapper = "";
+
+    @Option(name = "--output_wrapper_marker",
+        usage = "Use this token as output marker in the value of"
+        + " --output_wrapper")
+    private String output_wrapper_marker = "%output%";
+
+    @Option(name = "--module_wrapper",
+        usage = "An output wrapper for a javascript module (optional). "
+        + "The format is <name>:<wrapper>. The module name must correspond "
+        + "with a module specified using --module. The wrapper must "
+        + "contain %s as the code placeholder")
+    private List<String> module_wrapper = Lists.newArrayList();
+
+    @Option(name = "--module_output_path_prefix",
+        usage = "Prefix for filenames of compiled js modules. "
+        + "<module-name>.js will be appended to this prefix. Directories "
+        + "will be created as needed. Use with --module")
+    private String module_output_path_prefix = "./";
+
+    @Option(name = "--create_source_map",
+        usage = "If specified, a source map file mapping the generated " +
+        "source files back to the original source file will be " +
+        "output to the specified path. The %outname% placeholder will " +
+        "expand to the name of the output file that the source map " +
+        "corresponds to.")
+    private String create_source_map = "";
+
+    @Option(name = "--jscomp_error",
+        usage = "Make the named class of warnings an error. Options:" +
+        DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
+    private List<String> jscomp_error = Lists.newArrayList();
+
+    @Option(name = "--jscomp_warning",
+        usage = "Make the named class of warnings a normal warning. " +
+        "Options:" + DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
+    private List<String> jscomp_warning =  Lists.newArrayList();
+
+    @Option(name = "--jscomp_off",
+        usage = "Turn off the named class of warnings. Options:" +
+        DiagnosticGroups.DIAGNOSTIC_GROUP_NAMES)
+    private List<String> jscomp_off = Lists.newArrayList();
+
+    @Option(name = "--define",
+        aliases = {"--D"},
+        usage = "Override the value of a variable annotated @define. " +
+        "The format is <name>[=<val>], where <name> is the name of a @define " +
+        "variable and <val> is a boolean, number, or a single-quoted string " +
+        "that contains no single quotes. If [=<val>] is omitted, " +
+        "the variable is marked true")
+    private List<String> define = Lists.newArrayList();
+
+    @Option(name = "--charset",
+        usage = "Input charset for all files.")
+    private String charset = "";
+
+    @Option(name = "--compilation_level",
+        usage = "Specifies the compilation level to use. Options: " +
+        "WHITESPACE_ONLY, SIMPLE_OPTIMIZATIONS, ADVANCED_OPTIMIZATIONS")
+    private CompilationLevel compilation_level =
+        CompilationLevel.SIMPLE_OPTIMIZATIONS;
+
+    @Option(name = "--warning_level",
+        usage = "Specifies the warning level to use. Options: " +
+        "QUIET, DEFAULT, VERBOSE")
+    private WarningLevel warning_level = WarningLevel.DEFAULT;
+
+    @Option(name = "--use_only_custom_externs",
+        handler = BooleanOptionHandler.class,
+        usage = "Specifies whether the default externs should be excluded")
+    private boolean use_only_custom_externs = false;
+
+    @Option(name = "--debug",
+        handler = BooleanOptionHandler.class,
+        usage = "Enable debugging options")
+    private boolean debug = false;
+
+    @Option(name = "--formatting",
+        usage = "Specifies which formatting options, if any, should be "
+        + "applied to the output JS. Options: "
+        + "PRETTY_PRINT, PRINT_INPUT_DELIMITER")
+    private List<FormattingOption> formatting = Lists.newArrayList();
+
+    @Option(name = "--process_closure_primitives",
+        handler = BooleanOptionHandler.class,
+        usage = "Processes built-ins from the Closure library, such as "
+        + "goog.require(), goog.provide(), and goog.exportSymbol()")
+    private boolean process_closure_primitives = true;
+
+    // Our own option parser to be backwards-compatible.
+    // It needs to be public because of the crazy reflection that args4j does.
+    public static class BooleanOptionHandler extends OptionHandler<Boolean> {
+      private static final Set<String> TRUES =
+          Sets.newHashSet("true", "on", "yes", "1");
+      private static final Set<String> FALSES =
+          Sets.newHashSet("false", "off", "no", "0");
+
+      public BooleanOptionHandler(
+          CmdLineParser parser, OptionDef option,
+          Setter<? super Boolean> setter) {
+        super(parser, option, setter);
+      }
+
+      @Override
+      public int parseArguments(Parameters params) throws CmdLineException {
+        String param = params.getParameter(0);
+        if (param == null) {
+          setter.addValue(true);
+          return 0;
+        } else {
+          String lowerParam = param.toLowerCase();
+          if (TRUES.contains(lowerParam)) {
+            setter.addValue(true);
+          } else if (FALSES.contains(lowerParam)) {
+            setter.addValue(false);
+          } else {
+            throw new CmdLineException(owner,
+               "Illegal boolean value: " + lowerParam);
+          }
+          return 1;
+        }
+      }
+
+      @Override
+      public String getDefaultMetaVariable() {
+        return null;
+      }
+    }
+  }
 
   /**
    * Set of options that can be used with the --formatting flag.
@@ -251,78 +327,105 @@ public class CommandLineRunner extends
     }
   }
 
-  @FlagSpec(help = "Specifies which formatting options, if any, should be "
-      + "applied to the output JS. Options: "
-      + "PRETTY_PRINT, PRINT_INPUT_DELIMITER")
-  static final Flag<List<FormattingOption>> FLAG_formatting
-      = Flag.enumList(FormattingOption.class);
-
-  @FlagSpec(help = "Processes built-ins from the Closure library, such as "
-      + "goog.require(), goog.provide(), and goog.exportSymbol()")
-  static final Flag<Boolean> FLAG_process_closure_primitives
-      = Flag.value(true);
+  private final Flags flags = new Flags();
 
   /**
    * Create a new command-line runner. You should only need to call
    * the constructor if you're extending this class. Otherwise, the main
    * method should instantiate it.
    */
-  protected CommandLineRunner(String[] args) {
-    super(readConfigFromFlags(args));
+  protected CommandLineRunner(String[] args)
+      throws CmdLineException {
+    super();
+    initConfigFromFlags(args, System.err);
   }
 
-  protected CommandLineRunner(String[] args, PrintStream out, PrintStream err) {
-    super(readConfigFromFlags(args), out, err);
+  protected CommandLineRunner(String[] args, PrintStream out, PrintStream err)
+      throws CmdLineException {
+    super(out, err);
+    initConfigFromFlags(args, err);
   }
 
-  private static CommandLineConfig readConfigFromFlags(String[] args) {
-    Flags.parse(args);
-    return new CommandLineConfig()
-        .setPrintTree(FLAG_print_tree.get())
-        .setComputePhaseOrdering(FLAG_compute_phase_ordering.get())
-        .setPrintAst(FLAG_print_ast.get())
-        .setPrintPassGraph(FLAG_print_pass_graph.get())
-        .setJscompDevMode(FLAG_jscomp_dev_mode.get())
-        .setLoggingLevel(FLAG_logging_level.get())
-        .setExterns(FLAG_externs.get())
-        .setJs(FLAG_js.get())
-        .setJsOutputFile(FLAG_js_output_file.get())
-        .setModule(FLAG_module.get())
-        .setVariableMapInputFile(FLAG_variable_map_input_file.get())
-        .setPropertyMapInputFile(FLAG_property_map_input_file.get())
-        .setVariableMapOutputFile(FLAG_variable_map_output_file.get())
-        .setCreateNameMapFiles(FLAG_create_name_map_files.get())
-        .setPropertyMapOutputFile(FLAG_property_map_output_file.get())
-        .setThirdParty(FLAG_third_party.get())
-        .setSummaryDetailLevel(FLAG_summary_detail_level.get())
-        .setOutputWrapper(FLAG_output_wrapper.get())
-        .setOutputWrapperMarker(FLAG_output_wrapper_marker.get())
-        .setModuleWrapper(FLAG_module_wrapper.get())
-        .setModuleOutputPathPrefix(FLAG_module_output_path_prefix.get())
-        .setCreateSourceMap(FLAG_create_source_map.get())
-        .setJscompError(FLAG_jscomp_error.get())
-        .setJscompWarning(FLAG_jscomp_warning.get())
-        .setJscompOff(FLAG_jscomp_off.get())
-        .setDefine(FLAG_define.get())
-        .setCharset(FLAG_charset.get());
+  private void initConfigFromFlags(
+      String[] args, PrintStream err)
+      throws CmdLineException {
+    // Args4j has a different format that the old command-line parser.
+    // So we use some voodoo to get the args into the format that args4j
+    // expects.
+    Pattern argPattern = Pattern.compile("(--[a-zA-Z_]+)=(.*)");
+    Pattern quotesPattern = Pattern.compile("^['\"](.*)['\"]$");
+    List<String> processedArgs = Lists.newArrayList();
+    for (String arg : args) {
+      Matcher matcher = argPattern.matcher(arg);
+      if (matcher.matches()) {
+        processedArgs.add(matcher.group(1));
+
+        String value = matcher.group(2);
+        Matcher quotesMatcher = quotesPattern.matcher(value);
+        if (quotesMatcher.matches()) {
+          processedArgs.add(quotesMatcher.group(1));
+        } else {
+          processedArgs.add(value);
+        }
+      } else {
+        processedArgs.add(arg);
+      }
+    }
+
+    CmdLineParser parser = new CmdLineParser(flags);
+    try {
+      parser.parseArgument(processedArgs.toArray(new String[] {}));
+    } catch (CmdLineException e) {
+      err.println(e.getMessage());
+      parser.printUsage(err);
+      throw e;
+    }
+    getCommandLineConfig()
+        .setPrintTree(flags.print_tree)
+        .setComputePhaseOrdering(flags.compute_phase_ordering)
+        .setPrintAst(flags.print_ast)
+        .setPrintPassGraph(flags.print_pass_graph)
+        .setJscompDevMode(flags.jscomp_dev_mode)
+        .setLoggingLevel(flags.logging_level)
+        .setExterns(flags.externs)
+        .setJs(flags.js)
+        .setJsOutputFile(flags.js_output_file)
+        .setModule(flags.module)
+        .setVariableMapInputFile(flags.variable_map_input_file)
+        .setPropertyMapInputFile(flags.property_map_input_file)
+        .setVariableMapOutputFile(flags.variable_map_output_file)
+        .setCreateNameMapFiles(flags.create_name_map_files)
+        .setPropertyMapOutputFile(flags.property_map_output_file)
+        .setThirdParty(flags.third_party)
+        .setSummaryDetailLevel(flags.summary_detail_level)
+        .setOutputWrapper(flags.output_wrapper)
+        .setOutputWrapperMarker(flags.output_wrapper_marker)
+        .setModuleWrapper(flags.module_wrapper)
+        .setModuleOutputPathPrefix(flags.module_output_path_prefix)
+        .setCreateSourceMap(flags.create_source_map)
+        .setJscompError(flags.jscomp_error)
+        .setJscompWarning(flags.jscomp_warning)
+        .setJscompOff(flags.jscomp_off)
+        .setDefine(flags.define)
+        .setCharset(flags.charset);
   }
 
   @Override
   protected CompilerOptions createOptions() {
     CompilerOptions options = new CompilerOptions();
     options.setCodingConvention(new ClosureCodingConvention());
-    CompilationLevel level = FLAG_compilation_level.get();
+    CompilationLevel level = flags.compilation_level;
     level.setOptionsForCompilationLevel(options);
-    if (FLAG_debug.get()) {
+    if (flags.debug) {
       level.setDebugOptionsForCompilationLevel(options);
     }
 
-    WarningLevel wLevel = FLAG_warning_level.get();
+    WarningLevel wLevel = flags.warning_level;
     wLevel.setOptionsForWarningLevel(options);
-    for (FormattingOption formattingOption : FLAG_formatting.get()) {
+    for (FormattingOption formattingOption : flags.formatting) {
       formattingOption.applyToOptions(options);
     }
-    if (FLAG_process_closure_primitives.get()) {
+    if (flags.process_closure_primitives) {
       options.closurePass = true;
     }
 
@@ -339,7 +442,7 @@ public class CommandLineRunner extends
   protected List<JSSourceFile> createExterns() throws FlagUsageException,
       IOException {
     List<JSSourceFile> externs = super.createExterns();
-    if (!FLAG_use_only_custom_externs.get()) {
+    if (!flags.use_only_custom_externs) {
       List<JSSourceFile> defaultExterns = getDefaultExterns();
       defaultExterns.addAll(externs);
       return defaultExterns;
@@ -368,6 +471,10 @@ public class CommandLineRunner extends
    * Runs the Compiler. Exits cleanly in the event of an error.
    */
   public static void main(String[] args) {
-    (new CommandLineRunner(args)).run();
+    try {
+      (new CommandLineRunner(args)).run();
+    } catch (CmdLineException e) {
+      System.exit(-1);
+    }
   }
 }
diff --git a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
index fec3dda89..9043ee016 100644
--- a/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
+++ b/test/com/google/javascript/jscomp/CommandLineRunnerTest.java
@@ -18,12 +18,14 @@ package com.google.javascript.jscomp;
 
 import com.google.common.base.Joiner;
 import com.google.common.collect.Lists;
-import com.google.common.flags.Flags;
 import com.google.javascript.rhino.Node;
 
 import junit.framework.TestCase;
 
+import org.kohsuke.args4j.CmdLineException;
+
 import java.io.IOException;
+import java.util.List;
 
 /**
  * Tests for {@link CommandLineRunner}.
@@ -37,6 +39,8 @@ public class CommandLineRunnerTest extends TestCase {
   // If set to true, uses comparison by string instead of by AST.
   private boolean useStringComparison = false;
 
+  private List<String> args = Lists.newArrayList();
+
   /** Externs for the test */
   private final JSSourceFile[] externs = new JSSourceFile[] {
     JSSourceFile.fromCode("externs",
@@ -53,23 +57,13 @@ public class CommandLineRunnerTest extends TestCase {
   @Override
   public void setUp() throws Exception {
     super.setUp();
-    Flags.disableStateCheckingForTest();
-    Flags.resetAllFlagsForTest();
     lastCompiler = null;
     useStringComparison = false;
+    args.clear();
   }
 
   @Override
   public void tearDown() throws Exception {
-    Flags.resetAllFlagsForTest();
-
-    // NOTE(nicksantos): ANT needs this for some weird reason.
-    CommandLineRunner.FLAG_define.resetForTest();
-    CommandLineRunner.FLAG_jscomp_off.resetForTest();
-    CommandLineRunner.FLAG_jscomp_warning.resetForTest();
-    CommandLineRunner.FLAG_jscomp_error.resetForTest();
-
-    Flags.enableStateCheckingForTest();
     super.tearDown();
   }
 
@@ -79,49 +73,45 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testTypeCheckingOnWithVerbose() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.VERBOSE);
+    args.add("--warning_level=VERBOSE");
     test("function f(x) { return x; } f();", TypeCheck.WRONG_ARGUMENT_COUNT);
   }
 
   public void testTypeCheckOverride1() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.VERBOSE);
-    CommandLineRunner.FLAG_jscomp_off.setForTest(
-        Lists.newArrayList("checkTypes"));
+    args.add("--warning_level=VERBOSE");
+    args.add("--jscomp_off=checkTypes");
     testSame("var x = x || {}; x.f = function() {}; x.f(3);");
   }
 
   public void testTypeCheckOverride2() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.DEFAULT);
+    args.add("--warning_level=DEFAULT");
     testSame("var x = x || {}; x.f = function() {}; x.f(3);");
 
-    CommandLineRunner.FLAG_jscomp_warning.setForTest(
-        Lists.newArrayList("checkTypes"));
+    args.add("--jscomp_warning=checkTypes");
     test("var x = x || {}; x.f = function() {}; x.f(3);",
          TypeCheck.WRONG_ARGUMENT_COUNT);
   }
 
   public void testCheckSymbolsOffForDefault() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.DEFAULT);
+    args.add("--warning_level=DEFAULT");
     test("x = 3; var y; var y;", "x=3; var y;");
   }
 
   public void testCheckSymbolsOnForVerbose() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.VERBOSE);
+    args.add("--warning_level=VERBOSE");
     test("x = 3;", VarCheck.UNDEFINED_VAR_ERROR);
     test("var y; var y;", SyntacticScopeCreator.VAR_MULTIPLY_DECLARED_ERROR);
   }
 
   public void testCheckSymbolsOverrideForVerbose() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.VERBOSE);
-    CommandLineRunner.FLAG_jscomp_off.setForTest(
-        Lists.newArrayList("undefinedVars"));
+    args.add("--warning_level=VERBOSE");
+    args.add("--jscomp_off=undefinedVars");
     testSame("x = 3;");
   }
 
   public void testCheckUndefinedProperties() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.VERBOSE);
-    CommandLineRunner.FLAG_jscomp_error.setForTest(
-        Lists.newArrayList("missingProperties"));
+    args.add("--warning_level=VERBOSE");
+    args.add("--jscomp_error=missingProperties");
     test("var x = {}; var y = x.bar;", TypeCheck.INEXISTENT_PROPERTY);
   }
 
@@ -131,8 +121,8 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testDefineFlag() {
-    CommandLineRunner.FLAG_define.setForTest(
-        Lists.newArrayList("FOO", "BAR=5"));
+    args.add("--define=FOO");
+    args.add("--define=\"BAR=5\"");
     test("/** @define {boolean} */ var FOO = false;" +
          "/** @define {number} */ var BAR = 3;",
          "var FOO = true, BAR = 5;");
@@ -150,10 +140,10 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testQuietMode() {
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.DEFAULT);
+    args.add("--warning_level=DEFAULT");
     test("/** @type { not a type name } */ var x;",
          RhinoErrorReporter.PARSE_ERROR);
-    CommandLineRunner.FLAG_warning_level.setForTest(WarningLevel.QUIET);
+    args.add("--warning_level=QUIET");
     testSame("/** @type { not a type name } */ var x;");
   }
 
@@ -165,18 +155,15 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testIssue81() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.ADVANCED_OPTIMIZATIONS);
+    args.add("--compilation_level=ADVANCED_OPTIMIZATIONS");
     useStringComparison = true;
     test("eval('1'); var x = eval; x('2');",
          "eval(\"1\");(0,eval)(\"2\");");
   }
 
   public void testIssue115() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.SIMPLE_OPTIMIZATIONS);
-    CommandLineRunner.FLAG_warning_level.setForTest(
-        WarningLevel.VERBOSE);
+    args.add("--compilation_level=SIMPLE_OPTIMIZATIONS");
+    args.add("--warning_level=VERBOSE");
     test("function f() { " +
          "  var arguments = Array.prototype.slice.call(arguments, 0);" +
          "  return arguments[0]; " +
@@ -188,26 +175,22 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testDebugFlag1() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.SIMPLE_OPTIMIZATIONS);
-    CommandLineRunner.FLAG_debug.setForTest(false);
+    args.add("--compilation_level=SIMPLE_OPTIMIZATIONS");
+    args.add("--debug=false");
     testSame("function foo(a) {}");
   }
 
   public void testDebugFlag2() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.SIMPLE_OPTIMIZATIONS);
-    CommandLineRunner.FLAG_debug.setForTest(true);
+    args.add("--compilation_level=SIMPLE_OPTIMIZATIONS");
+    args.add("--debug=true");
     test("function foo(a) {}",
          "function foo($a$$) {}");
   }
 
   public void testDebugFlag3() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.ADVANCED_OPTIMIZATIONS);
-    CommandLineRunner.FLAG_warning_level.setForTest(
-        WarningLevel.QUIET);
-    CommandLineRunner.FLAG_debug.setForTest(false);
+    args.add("--compilation_level=ADVANCED_OPTIMIZATIONS");
+    args.add("--warning_level=QUIET");
+    args.add("--debug=false");
     test("function Foo() {};" +
          "Foo.x = 1;" +
          "function f() {throw new Foo().x;} f();",
@@ -216,11 +199,9 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   public void testDebugFlag4() {
-    CommandLineRunner.FLAG_compilation_level.setForTest(
-        CompilationLevel.ADVANCED_OPTIMIZATIONS);
-    CommandLineRunner.FLAG_warning_level.setForTest(
-        WarningLevel.QUIET);
-    CommandLineRunner.FLAG_debug.setForTest(true);
+    args.add("--compilation_level=ADVANCED_OPTIMIZATIONS");
+    args.add("--warning_level=QUIET");
+    args.add("--debug=true");
     test("function Foo() {};" +
         "Foo.x = 1;" +
         "function f() {throw new Foo().x;} f();",
@@ -293,7 +274,13 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   private Compiler compile(String[] original) {
-    CommandLineRunner runner = new CommandLineRunner(new String[] {});
+    String[] argStrings = args.toArray(new String[] {});
+    CommandLineRunner runner = null;
+    try {
+      runner = new CommandLineRunner(argStrings);
+    } catch (CmdLineException e) {
+      throw new RuntimeException(e);
+    }
     Compiler compiler = runner.createCompiler();
     lastCompiler = compiler;
     JSSourceFile[] inputs = new JSSourceFile[original.length];
@@ -314,7 +301,13 @@ public class CommandLineRunnerTest extends TestCase {
   }
 
   private Node parse(String[] original) {
-    CommandLineRunner runner = new CommandLineRunner(new String[] {});
+    String[] argStrings = args.toArray(new String[] {});
+    CommandLineRunner runner = null;
+    try {
+      runner = new CommandLineRunner(argStrings);
+    } catch (CmdLineException e) {
+      throw new RuntimeException(e);
+    }
     Compiler compiler = runner.createCompiler();
     JSSourceFile[] inputs = new JSSourceFile[original.length];
     for (int i = 0; i < inputs.length; i++) {
diff --git a/tools/FlagProcessorFactory_deploy.jar b/tools/FlagProcessorFactory_deploy.jar
deleted file mode 100755
index 7f62cd697..000000000
Binary files a/tools/FlagProcessorFactory_deploy.jar and /dev/null differ
