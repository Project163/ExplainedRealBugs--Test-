diff --git a/externs/html5.js b/externs/html5.js
index b41e7227f..15aabcb30 100644
--- a/externs/html5.js
+++ b/externs/html5.js
@@ -905,3 +905,22 @@ WebSocket.prototype.send = function(data) {};
  * Closes the Web Socket connection or connection attempt, if any.
  */
 WebSocket.prototype.close = function() {};
+
+// HTML5 History
+/**
+ * Pushes a new state into the session history.
+ * @see http://www.w3.org/TR/html5/history.html#the-history-interface
+ * @param {*} data New state.
+ * @param {string} title The title for a new session history entry.
+ * @param {string=} opt_url The URL for a new session history entry.
+ */
+History.prototype.pushState = function(data, title, opt_url) {};
+
+/**
+ * Replaces the current state in the session history.
+ * @see http://www.w3.org/TR/html5/history.html#the-history-interface
+ * @param {*} data New state.
+ * @param {string} title The title for a session history entry.
+ * @param {string=} opt_url The URL for a new session history entry.
+ */
+History.prototype.replaceState = function(data, title, opt_url) {};
diff --git a/javadoc/com/google/javascript/rhino/jstype/EnumElementType.html b/javadoc/com/google/javascript/rhino/jstype/EnumElementType.html
index f3c3baa8e..69c3a9d6f 100644
--- a/javadoc/com/google/javascript/rhino/jstype/EnumElementType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/EnumElementType.html
@@ -178,14 +178,6 @@ The type of individual elements of an enum type
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/EnumElementType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/EnumElementType.html#equals(java.lang.Object)">equals</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A>&nbsp;that)</CODE>
 
@@ -825,23 +817,6 @@ public int <B>getPropertiesCount</B>()</PRE>
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="findPropertyType(java.lang.String)"><!-- --></A><H3>
 findPropertyType</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/EnumType.html b/javadoc/com/google/javascript/rhino/jstype/EnumType.html
index 115a75b39..2c20c9ed7 100644
--- a/javadoc/com/google/javascript/rhino/jstype/EnumType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/EnumType.html
@@ -170,14 +170,6 @@ An enum type representing a branded collection of elements. Each element
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/EnumType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/EnumType.html#defineElement(java.lang.String)">defineElement</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&nbsp;name)</CODE>
 
@@ -791,23 +783,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyTypeInferred(java.lang.String)"><!-- --></A><H3>
 isPropertyTypeInferred</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/FunctionPrototypeType.html b/javadoc/com/google/javascript/rhino/jstype/FunctionPrototypeType.html
index 41fae0084..a47ba82b7 100644
--- a/javadoc/com/google/javascript/rhino/jstype/FunctionPrototypeType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/FunctionPrototypeType.html
@@ -169,14 +169,6 @@ Represents the prototype of a <A HREF="../../../../../com/google/javascript/rhin
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionPrototypeType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;<A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionType.html" title="class in com.google.javascript.rhino.jstype">FunctionType</A></CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionPrototypeType.html#getConstructor()">getConstructor</A></B>()</CODE>
 
@@ -595,23 +587,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyTypeInferred(java.lang.String)"><!-- --></A><H3>
 isPropertyTypeInferred</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/FunctionType.html b/javadoc/com/google/javascript/rhino/jstype/FunctionType.html
index 5f2f6b3af..9ab3a95c4 100644
--- a/javadoc/com/google/javascript/rhino/jstype/FunctionType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/FunctionType.html
@@ -220,14 +220,6 @@ This derived type provides extended information about a function, including
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionType.html#equals(java.lang.Object)">equals</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A>&nbsp;otherType)</CODE>
 
@@ -1482,23 +1474,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyInExterns(java.lang.String)"><!-- --></A><H3>
 isPropertyInExterns</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/InstanceObjectType.html b/javadoc/com/google/javascript/rhino/jstype/InstanceObjectType.html
index ab70ad5e4..8ae66f5bc 100644
--- a/javadoc/com/google/javascript/rhino/jstype/InstanceObjectType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/InstanceObjectType.html
@@ -169,14 +169,6 @@ An object type that is an instance of some function constructor.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/InstanceObjectType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/InstanceObjectType.html#equals(java.lang.Object)">equals</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A>&nbsp;that)</CODE>
 
@@ -841,23 +833,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyTypeInferred(java.lang.String)"><!-- --></A><H3>
 isPropertyTypeInferred</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/NoObjectType.html b/javadoc/com/google/javascript/rhino/jstype/NoObjectType.html
index 21ecb2d5e..831129f11 100644
--- a/javadoc/com/google/javascript/rhino/jstype/NoObjectType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/NoObjectType.html
@@ -177,14 +177,6 @@ The bottom Object type, representing the subclass of all objects.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/NoObjectType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/NoObjectType.html#equals(java.lang.Object)">equals</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A>&nbsp;that)</CODE>
 
@@ -988,23 +980,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyInExterns(java.lang.String)"><!-- --></A><H3>
 isPropertyInExterns</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/NoType.html b/javadoc/com/google/javascript/rhino/jstype/NoType.html
index 55eb08a37..ad6bc6325 100644
--- a/javadoc/com/google/javascript/rhino/jstype/NoType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/NoType.html
@@ -176,14 +176,6 @@ Bottom type, representing the subclass of any value or object.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/NoType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;<A HREF="../../../../../com/google/javascript/rhino/jstype/JSType.html" title="class in com.google.javascript.rhino.jstype">JSType</A></CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/NoType.html#getGreatestSubtype(com.google.javascript.rhino.jstype.JSType)">getGreatestSubtype</A></B>(<A HREF="../../../../../com/google/javascript/rhino/jstype/JSType.html" title="class in com.google.javascript.rhino.jstype">JSType</A>&nbsp;that)</CODE>
 
@@ -682,23 +674,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyInExterns(java.lang.String)"><!-- --></A><H3>
 isPropertyInExterns</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/RecordType.html b/javadoc/com/google/javascript/rhino/jstype/RecordType.html
index bae81c2f9..bec2fa580 100644
--- a/javadoc/com/google/javascript/rhino/jstype/RecordType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/RecordType.html
@@ -178,14 +178,6 @@ A record (structural) type.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/RecordType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;boolean</CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/RecordType.html#equals(java.lang.Object)">equals</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A>&nbsp;other)</CODE>
 
@@ -685,23 +677,6 @@ public boolean <B>isPropertyTypeDeclared</B>(<A HREF="http://java.sun.com/javase
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="isPropertyTypeInferred(java.lang.String)"><!-- --></A><H3>
 isPropertyTypeInferred</H3>
 <PRE>
diff --git a/javadoc/com/google/javascript/rhino/jstype/UnknownType.html b/javadoc/com/google/javascript/rhino/jstype/UnknownType.html
index 63ea22bd0..d68d012ac 100644
--- a/javadoc/com/google/javascript/rhino/jstype/UnknownType.html
+++ b/javadoc/com/google/javascript/rhino/jstype/UnknownType.html
@@ -178,14 +178,6 @@ The <code>Unknown</code> type.
 </TR>
 <TR BGCOLOR="white" CLASS="TableRowColor">
 <TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
-<CODE>protected &nbsp;void</CODE></FONT></TD>
-<TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/UnknownType.html#collectPropertyNames(java.util.Set)">collectPropertyNames</A></B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</CODE>
-
-<BR>
-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Adds any properties defined on this type or its supertypes to the set.</TD>
-</TR>
-<TR BGCOLOR="white" CLASS="TableRowColor">
-<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
 <CODE>&nbsp;<A HREF="../../../../../com/google/javascript/rhino/jstype/FunctionType.html" title="class in com.google.javascript.rhino.jstype">FunctionType</A></CODE></FONT></TD>
 <TD><CODE><B><A HREF="../../../../../com/google/javascript/rhino/jstype/UnknownType.html#getConstructor()">getConstructor</A></B>()</CODE>
 
@@ -741,23 +733,6 @@ public int <B>getPropertiesCount</B>()</PRE>
 </DL>
 <HR>
 
-<A NAME="collectPropertyNames(java.util.Set)"><!-- --></A><H3>
-collectPropertyNames</H3>
-<PRE>
-protected void <B>collectPropertyNames</B>(<A HREF="http://java.sun.com/javase/6/docs/api/java/util/Set.html?is-external=true" title="class or interface in java.util">Set</A>&lt;<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/String.html?is-external=true" title="class or interface in java.lang">String</A>&gt;&nbsp;props)</PRE>
-<DL>
-<DD><B>Description copied from class: <CODE><A HREF="../../../../../com/google/javascript/rhino/jstype/ObjectType.html#collectPropertyNames(java.util.Set)">ObjectType</A></CODE></B></DD>
-<DD>Adds any properties defined on this type or its supertypes to the set.
-<P>
-<DD><DL>
-</DL>
-</DD>
-<DD><DL>
-</DL>
-</DD>
-</DL>
-<HR>
-
 <A NAME="getPropertyType(java.lang.String)"><!-- --></A><H3>
 getPropertyType</H3>
 <PRE>
diff --git a/javadoc/index-all.html b/javadoc/index-all.html
index ebcbe520e..9b6b35716 100644
--- a/javadoc/index-all.html
+++ b/javadoc/index-all.html
@@ -896,12 +896,6 @@ Variable in class com.google.javascript.jscomp.<A HREF="./com/google/javascript/
 <DT><A HREF="./com/google/javascript/jscomp/CompilerOptions.html#collapseVariableDeclarations"><B>collapseVariableDeclarations</B></A> - 
 Variable in class com.google.javascript.jscomp.<A HREF="./com/google/javascript/jscomp/CompilerOptions.html" title="class in com.google.javascript.jscomp">CompilerOptions</A>
 <DD>Collapses multiple variable declarations into one
-<DT><A HREF="./com/google/javascript/rhino/jstype/EnumElementType.html#collectPropertyNames(java.util.Set)"><B>collectPropertyNames(Set&lt;String&gt;)</B></A> - 
-Method in class com.google.javascript.rhino.jstype.<A HREF="./com/google/javascript/rhino/jstype/EnumElementType.html" title="class in com.google.javascript.rhino.jstype">EnumElementType</A>
-<DD>&nbsp;
-<DT><A HREF="./com/google/javascript/rhino/jstype/UnknownType.html#collectPropertyNames(java.util.Set)"><B>collectPropertyNames(Set&lt;String&gt;)</B></A> - 
-Method in class com.google.javascript.rhino.jstype.<A HREF="./com/google/javascript/rhino/jstype/UnknownType.html" title="class in com.google.javascript.rhino.jstype">UnknownType</A>
-<DD>&nbsp;
 <DT><A HREF="./com/google/javascript/rhino/Token.html#COLON"><B>COLON</B></A> - 
 Static variable in class com.google.javascript.rhino.<A HREF="./com/google/javascript/rhino/Token.html" title="class in com.google.javascript.rhino">Token</A>
 <DD>&nbsp;
diff --git a/lib/google_common_deploy.jar b/lib/google_common_deploy.jar
index 7620fd007..3190e75af 100755
Binary files a/lib/google_common_deploy.jar and b/lib/google_common_deploy.jar differ
diff --git a/src/com/google/javascript/jscomp/ExportTestFunctions.java b/src/com/google/javascript/jscomp/ExportTestFunctions.java
index 637538166..2d740d2f2 100644
--- a/src/com/google/javascript/jscomp/ExportTestFunctions.java
+++ b/src/com/google/javascript/jscomp/ExportTestFunctions.java
@@ -54,7 +54,7 @@ class ExportTestFunctions implements CompilerPass {
     public void visit(NodeTraversal t, Node n, Node parent) {
       if (parent != null && parent.getType() == Token.SCRIPT &&
           n.getType() == Token.FUNCTION) {
-        String functionName = NodeUtil.getFunctionName(n, parent);
+        String functionName = NodeUtil.getFunctionName(n);
         if (isTestFunction(n, functionName) && t.inGlobalScope()) {
           exportTestFunction(functionName, n, parent);
         }
diff --git a/src/com/google/javascript/jscomp/FindExportableNodes.java b/src/com/google/javascript/jscomp/FindExportableNodes.java
index 29d08ea12..f55b154ac 100644
--- a/src/com/google/javascript/jscomp/FindExportableNodes.java
+++ b/src/com/google/javascript/jscomp/FindExportableNodes.java
@@ -72,7 +72,7 @@ public class FindExportableNodes extends AbstractPostOrderCallback {
       switch (n.getType()) {
         case Token.FUNCTION:
           if (parent.getType() == Token.SCRIPT) {
-            export = NodeUtil.getFunctionName(n, parent);
+            export = NodeUtil.getFunctionName(n);
             context = new GenerateNodeContext(n, parent, n);
           }
           break;
diff --git a/src/com/google/javascript/jscomp/InlineFunctions.java b/src/com/google/javascript/jscomp/InlineFunctions.java
index d7620dca4..884109d39 100644
--- a/src/com/google/javascript/jscomp/InlineFunctions.java
+++ b/src/com/google/javascript/jscomp/InlineFunctions.java
@@ -751,7 +751,9 @@ class InlineFunctions implements CompilerPass {
   void verifyAllReferencesInlined(FunctionState fs) {
     for (Reference ref : fs.getReferences()) {
       if (!ref.inlined) {
-        throw new IllegalStateException("Call site missed.");
+        throw new IllegalStateException("Call site missed.\n call: "
+            + ref.callNode.toStringTree() + "\n parent:  " 
+            + ref.callNode.getParent().toStringTree());
       }
     }
   }
diff --git a/src/com/google/javascript/jscomp/NameReferenceGraphConstruction.java b/src/com/google/javascript/jscomp/NameReferenceGraphConstruction.java
index e6c7faa55..e6afe612f 100644
--- a/src/com/google/javascript/jscomp/NameReferenceGraphConstruction.java
+++ b/src/com/google/javascript/jscomp/NameReferenceGraphConstruction.java
@@ -121,7 +121,7 @@ class NameReferenceGraphConstruction implements CompilerPass {
         // TODO(user): A global function foo() is treated as the same
         // function as a inner function named foo(). We should use some clever
         // naming scheme to avoid this lost of precision.
-        String name = NodeUtil.getFunctionName(root, parent);
+        String name = NodeUtil.getFunctionName(root);
 
         if (name == null) {
           // When the name is null, we have a function that is presumably not
diff --git a/src/com/google/javascript/jscomp/NodeUtil.java b/src/com/google/javascript/jscomp/NodeUtil.java
index 28ad4bca1..2fc7a752f 100644
--- a/src/com/google/javascript/jscomp/NodeUtil.java
+++ b/src/com/google/javascript/jscomp/NodeUtil.java
@@ -146,10 +146,10 @@ public final class NodeUtil {
    * returned (the variable of qualified name).
    *
    * @param n a node whose type is {@link Token#FUNCTION}
-   * @param parent {@code n}'s parent (never {@code null})
    * @return the function's name, or {@code null} if it has no name
    */
-  static String getFunctionName(Node n, Node parent) {
+  static String getFunctionName(Node n) {
+    Node parent = n.getParent();
     String name = n.getFirstChild().getString();
     switch (parent.getType()) {
       case Token.NAME:
diff --git a/src/com/google/javascript/jscomp/RuntimeTypeCheck.java b/src/com/google/javascript/jscomp/RuntimeTypeCheck.java
index 20bde522e..fb25fdb41 100644
--- a/src/com/google/javascript/jscomp/RuntimeTypeCheck.java
+++ b/src/com/google/javascript/jscomp/RuntimeTypeCheck.java
@@ -137,7 +137,11 @@ class RuntimeTypeCheck implements CompilerPass {
             Node nodeToInsertAfter,
             @Nullable ObjectType interfaceType) {
 
-      String className = funType.getInstanceType().getReferenceName();
+      if (funType.getSource() == null) {
+        return nodeToInsertAfter;
+      }
+
+      String className = NodeUtil.getFunctionName(funType.getSource());
 
       // This can happen with anonymous classes declared with the type
       // {@code Function}.
@@ -358,6 +362,8 @@ class RuntimeTypeCheck implements CompilerPass {
     String boilerplateCode = getBoilerplateCode(logFunction);
 
     Node js = compiler.parseSyntheticCode(boilerplateCode);
+    NodeTraversal.traverse(compiler, js,
+        new Normalize.NormalizeStatements(compiler, false));
 
     compiler.getNodeForCodeInsertion(null).addChildrenToFront(
         js.removeChildren());
diff --git a/src/com/google/javascript/jscomp/js/runtime_type_check.js b/src/com/google/javascript/jscomp/js/runtime_type_check.js
index 9b986f6fb..fdb7c09de 100644
--- a/src/com/google/javascript/jscomp/js/runtime_type_check.js
+++ b/src/com/google/javascript/jscomp/js/runtime_type_check.js
@@ -251,8 +251,27 @@ jscomp.typecheck.ExternClassChecker_.trackOpenOnWindow = function(win) {
 };
 
 
-jscomp.typecheck.ExternClassChecker_.trackOpenOnWindow(top);
-jscomp.typecheck.ExternClassChecker_.trackOpenOnWindow(window);
+/**
+ * Returns the global 'this' object. This will normally be the same as 'window'
+ * but when running in a worker thread, the DOM is not available.
+ * @return {!Object}
+ * @private
+ */
+jscomp.typecheck.ExternClassChecker_.getGlobalThis_ = function() {
+  return (function() { return this; }).call(null);
+};
+
+
+// Install listeners on the global 'this' object.
+(function() {
+  var globalThis = jscomp.typecheck.ExternClassChecker_.getGlobalThis_();
+  jscomp.typecheck.ExternClassChecker_.trackOpenOnWindow(globalThis);
+
+  var theTop = globalThis['top'];
+  if (theTop) {
+    jscomp.typecheck.ExternClassChecker_.trackOpenOnWindow(theTop);
+  }
+})();
 
 
 /** @inheritDoc */
diff --git a/src/com/google/javascript/rhino/Node.java b/src/com/google/javascript/rhino/Node.java
index 667d9edb1..2ed0886f8 100644
--- a/src/com/google/javascript/rhino/Node.java
+++ b/src/com/google/javascript/rhino/Node.java
@@ -1328,7 +1328,9 @@ public class Node implements Cloneable, Serializable
         if (diff != null) {
           return "Node tree inequality:" +
               "\nTree1:\n" + toStringTree() +
-              "\n\nTree2:\n" + node2.toStringTree();
+              "\n\nTree2:\n" + node2.toStringTree() +
+              "\n\nSubtree1: " + diff.nodeA.toStringTree() +
+              "\n\nSubtree2: " + diff.nodeB.toStringTree();
         }
         return null;
     }
diff --git a/src/com/google/javascript/rhino/jstype/EnumElementType.java b/src/com/google/javascript/rhino/jstype/EnumElementType.java
index 853468313..3033d4558 100644
--- a/src/com/google/javascript/rhino/jstype/EnumElementType.java
+++ b/src/com/google/javascript/rhino/jstype/EnumElementType.java
@@ -211,7 +211,7 @@ public class EnumElementType extends ObjectType {
   }
 
   @Override
-  protected void collectPropertyNames(Set<String> props) {
+  void collectPropertyNames(Set<String> props) {
     if (primitiveObjectType != null) {
       primitiveObjectType.collectPropertyNames(props);
     }
diff --git a/src/com/google/javascript/rhino/jstype/InstanceObjectType.java b/src/com/google/javascript/rhino/jstype/InstanceObjectType.java
index 254f413a7..0c2afcac9 100644
--- a/src/com/google/javascript/rhino/jstype/InstanceObjectType.java
+++ b/src/com/google/javascript/rhino/jstype/InstanceObjectType.java
@@ -99,7 +99,11 @@ public final class InstanceObjectType extends PrototypeObjectType {
 
   @Override
   public String toString() {
-    return constructor.getReferenceName();
+    if (constructor.hasReferenceName()) {
+      return constructor.getReferenceName();
+    } else {
+      return super.toString();
+    }
   }
 
   @Override
diff --git a/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java b/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java
index fc8420abb..fc1bc0bc6 100644
--- a/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java
+++ b/src/com/google/javascript/rhino/jstype/JSTypeRegistry.java
@@ -1059,7 +1059,10 @@ public class JSTypeRegistry implements Serializable {
    * Create an anonymous object type.
    */
   public ObjectType createAnonymousObjectType() {
-    return createObjectType(null, null, null);
+    PrototypeObjectType type =
+        new PrototypeObjectType(this, null, null);
+    type.setPrettyPrint(true);
+    return type;
   }
 
   /**
diff --git a/src/com/google/javascript/rhino/jstype/PrototypeObjectType.java b/src/com/google/javascript/rhino/jstype/PrototypeObjectType.java
index 26e9c0118..65d90a485 100644
--- a/src/com/google/javascript/rhino/jstype/PrototypeObjectType.java
+++ b/src/com/google/javascript/rhino/jstype/PrototypeObjectType.java
@@ -41,7 +41,9 @@ package com.google.javascript.rhino.jstype;
 
 import static com.google.common.base.Preconditions.checkState;
 
+import com.google.common.base.Preconditions;
 import com.google.common.collect.Maps;
+import com.google.common.collect.Sets;
 import com.google.javascript.rhino.ErrorReporter;
 import com.google.javascript.rhino.JSDocInfo;
 
@@ -74,6 +76,12 @@ class PrototypeObjectType extends ObjectType {
   private ObjectType implicitPrototype;
   private final boolean nativeType;
 
+  // Whether the toString representation of this should be pretty-printed,
+  // by printing all properties.
+  private boolean prettyPrint = false;
+
+  private static final int MAX_PRETTY_PRINTED_PROPERTIES = 4;
+
   /**
    * Creates an object type.
    *
@@ -165,7 +173,7 @@ class PrototypeObjectType extends ObjectType {
   }
 
   @Override
-  protected void collectPropertyNames(Set<String> props) {
+  void collectPropertyNames(Set<String> props) {
     for (String prop : properties.keySet()) {
       props.add(prop);
     }
@@ -319,7 +327,47 @@ class PrototypeObjectType extends ObjectType {
 
   @Override
   public String toString() {
-    return getReferenceName();
+    if (hasReferenceName()) {
+      return getReferenceName();
+    } else if (prettyPrint) {
+      // Use a tree set so that the properties are sorted.
+      Set<String> propertyNames = Sets.newTreeSet();
+      for (ObjectType current = this;
+           current != null && !current.isNativeObjectType() &&
+               propertyNames.size() <= MAX_PRETTY_PRINTED_PROPERTIES;
+           current = current.getImplicitPrototype()) {
+        propertyNames.addAll(current.getOwnPropertyNames());
+      }
+
+      StringBuilder sb = new StringBuilder();
+      sb.append("{");
+
+      int i = 0;
+      for (String property : propertyNames) {
+        if (i > 0) {
+          sb.append(", ");
+        }
+
+        sb.append(property);
+        sb.append(": ");
+        sb.append(getPropertyType(property).toString());
+
+        ++i;
+        if (i == MAX_PRETTY_PRINTED_PROPERTIES) {
+          sb.append(", ...");
+          break;
+        }
+      }
+
+      sb.append("}");
+      return sb.toString();
+    } else {
+      return "{...}";
+    }
+  }
+
+  void setPrettyPrint(boolean prettyPrint) {
+    this.prettyPrint = prettyPrint;
   }
 
   @Override
@@ -348,7 +396,7 @@ class PrototypeObjectType extends ObjectType {
     if (className != null) {
       return className;
     } else {
-      return "{...}";
+      return null;
     }
   }
 
diff --git a/src/com/google/javascript/rhino/jstype/UnknownType.java b/src/com/google/javascript/rhino/jstype/UnknownType.java
index d5ead2a49..38af5b726 100644
--- a/src/com/google/javascript/rhino/jstype/UnknownType.java
+++ b/src/com/google/javascript/rhino/jstype/UnknownType.java
@@ -149,7 +149,7 @@ public class UnknownType extends ObjectType {
   }
 
   @Override
-  protected void collectPropertyNames(Set<String> props) {
+  void collectPropertyNames(Set<String> props) {
   }
 
   @Override
diff --git a/test/com/google/javascript/jscomp/NodeUtilTest.java b/test/com/google/javascript/jscomp/NodeUtilTest.java
index fbac1cc6f..c1d29f24f 100644
--- a/test/com/google/javascript/jscomp/NodeUtilTest.java
+++ b/test/com/google/javascript/jscomp/NodeUtilTest.java
@@ -114,7 +114,7 @@ public class NodeUtilTest extends TestCase {
     Compiler compiler = new Compiler();
     Node parent = compiler.parseTestCode("function name(){}");
 
-    testGetFunctionName(parent.getFirstChild(), parent, "name");
+    testGetFunctionName(parent.getFirstChild(), "name");
   }
 
   public void testGetFunctionName2() throws Exception {
@@ -122,7 +122,7 @@ public class NodeUtilTest extends TestCase {
     Node parent = compiler.parseTestCode("var name = function(){}")
         .getFirstChild().getFirstChild();
 
-    testGetFunctionName(parent.getFirstChild(), parent, "name");
+    testGetFunctionName(parent.getFirstChild(), "name");
   }
 
   public void testGetFunctionName3() throws Exception {
@@ -130,7 +130,7 @@ public class NodeUtilTest extends TestCase {
     Node parent = compiler.parseTestCode("qualified.name = function(){}")
         .getFirstChild().getFirstChild();
 
-    testGetFunctionName(parent.getLastChild(), parent, "qualified.name");
+    testGetFunctionName(parent.getLastChild(), "qualified.name");
   }
 
   public void testGetFunctionName4() throws Exception {
@@ -138,7 +138,7 @@ public class NodeUtilTest extends TestCase {
     Node parent = compiler.parseTestCode("var name2 = function name1(){}")
         .getFirstChild().getFirstChild();
 
-    testGetFunctionName(parent.getFirstChild(), parent, "name2");
+    testGetFunctionName(parent.getFirstChild(), "name2");
   }
 
   public void testGetFunctionName5() throws Exception {
@@ -146,12 +146,12 @@ public class NodeUtilTest extends TestCase {
     Node n = compiler.parseTestCode("qualified.name2 = function name1(){}");
     Node parent = n.getFirstChild().getFirstChild();
 
-    testGetFunctionName(parent.getLastChild(), parent, "qualified.name2");
+    testGetFunctionName(parent.getLastChild(), "qualified.name2");
   }
 
-  private void testGetFunctionName(Node function, Node parent, String name) {
+  private void testGetFunctionName(Node function, String name) {
     assertEquals(Token.FUNCTION, function.getType());
-    assertEquals(name, NodeUtil.getFunctionName(function, parent));
+    assertEquals(name, NodeUtil.getFunctionName(function));
   }
 
   public void testContainsFunctionDeclaration() {
diff --git a/test/com/google/javascript/jscomp/RuntimeTypeCheckTest.java b/test/com/google/javascript/jscomp/RuntimeTypeCheckTest.java
index 05602f6a1..aa79607ac 100644
--- a/test/com/google/javascript/jscomp/RuntimeTypeCheckTest.java
+++ b/test/com/google/javascript/jscomp/RuntimeTypeCheckTest.java
@@ -16,6 +16,8 @@
 
 package com.google.javascript.jscomp;
 
+import com.google.javascript.rhino.Node;
+
 /**
  * Tests for {@link RuntimeTypeCheck}.
  *
@@ -102,6 +104,21 @@ public class RuntimeTypeCheckTest extends CompilerTestCase {
         "}");
   }
 
+  public void testInnerClasses() {
+    enableNormalize(false);
+    testChecks(
+        "function f() { /** @constructor */ function inner() {} }" +
+        "function g() { /** @constructor */ function inner() {} }",
+        "function f() {" +
+        "  /** @constructor */ function inner() {}" +
+        "  inner.prototype['instance_of__inner'] = true;" +
+        "}" +
+        "function g() {" +
+        "  /** @constructor */ function inner$$1() {}" +
+        "  inner$$1.prototype['instance_of__inner$$1'] = true;" +
+        "}");
+  }
+
   public void testInterface() {
     testChecks("/** @interface */function I() {}" +
         "/** @param {!I} i */function f(i) {}",
@@ -199,7 +216,14 @@ public class RuntimeTypeCheckTest extends CompilerTestCase {
 
   private void testChecks(String js, String expected) {
     String boilerplateCode = RuntimeTypeCheck.getBoilerplateCode(null);
-    test(js, boilerplateCode + expected);
+    Compiler compiler = new Compiler();
+    compiler.init(new JSSourceFile[0], new JSSourceFile[0],
+        new CompilerOptions());
+    Node ast = compiler.parseSyntheticCode(boilerplateCode + expected);
+    NodeTraversal.traverse(compiler, ast,
+        new Normalize.NormalizeStatements(compiler, false));
+
+    test(js, compiler.toSource(ast));
   }
 
   @Override
diff --git a/test/com/google/javascript/jscomp/TypeCheckTest.java b/test/com/google/javascript/jscomp/TypeCheckTest.java
index 87ef2b506..22b28f842 100644
--- a/test/com/google/javascript/jscomp/TypeCheckTest.java
+++ b/test/com/google/javascript/jscomp/TypeCheckTest.java
@@ -3221,7 +3221,7 @@ public class TypeCheckTest extends CompilerTypeTestCase {
     testTypes("/** @return {number} */" +
         "function f() { var x = x || {}; return x; }",
         "inconsistent return type\n" +
-        "found   : {...}\n" +
+        "found   : {}\n" +
         "required: number");
   }
 
@@ -4687,7 +4687,7 @@ public class TypeCheckTest extends CompilerTypeTestCase {
   public void testBitOperation9() throws Exception {
     testTypes("var x = void 0; x |= {};",
         "bad right operand to bitwise operator\n" +
-        "found   : {...}\n" +
+        "found   : {}\n" +
         "required: (boolean|null|number|string|undefined)");
   }
 
diff --git a/test/com/google/javascript/rhino/jstype/JSTypeTest.java b/test/com/google/javascript/rhino/jstype/JSTypeTest.java
index f399f9792..5fd9345e9 100644
--- a/test/com/google/javascript/rhino/jstype/JSTypeTest.java
+++ b/test/com/google/javascript/rhino/jstype/JSTypeTest.java
@@ -5026,7 +5026,32 @@ public class JSTypeTest extends BaseJSTypeTestCase {
     // anonymous
     ObjectType anonymous = registry.createAnonymousObjectType();
     assertEquals(OBJECT_TYPE, anonymous.getImplicitPrototype());
-    assertEquals("{...}", anonymous.getReferenceName());
+    assertNull(anonymous.getReferenceName());
+    assertEquals("{}", anonymous.toString());
+  }
+
+  /**
+   * Tests the factory method
+   * {@link JSTypeRegistry#createAnonymousObjectType()}} and adds
+   * some properties to it.
+   */
+  public void testCreateAnonymousObjectType2() throws Exception {
+    // anonymous
+    ObjectType anonymous = registry.createAnonymousObjectType();
+    anonymous.defineDeclaredProperty(
+        "a", NUMBER_TYPE, false);
+    anonymous.defineDeclaredProperty(
+        "b", NUMBER_TYPE, false);
+    anonymous.defineDeclaredProperty(
+        "c", NUMBER_TYPE, false);
+    anonymous.defineDeclaredProperty(
+        "d", NUMBER_TYPE, false);
+    anonymous.defineDeclaredProperty(
+        "e", NUMBER_TYPE, false);
+    anonymous.defineDeclaredProperty(
+        "f", NUMBER_TYPE, false);
+    assertEquals("{a: number, b: number, c: number, d: number, ...}",
+        anonymous.toString());
   }
 
   /**
@@ -5040,7 +5065,8 @@ public class JSTypeTest extends BaseJSTypeTestCase {
         registry.createObjectType(DATE_TYPE.getImplicitPrototype());
     assertEquals(DATE_TYPE.getImplicitPrototype(),
         subDate.getImplicitPrototype());
-    assertEquals("{...}", subDate.getReferenceName());
+    assertNull(subDate.getReferenceName());
+    assertEquals("{...}", subDate.toString());
 
     // name, node, prototype
     ObjectType subError = registry.createObjectType("Foo", null,
