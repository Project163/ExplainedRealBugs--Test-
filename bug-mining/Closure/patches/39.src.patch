diff --git a/lib/google_common_deploy.jar b/lib/google_common_deploy.jar
index 6f07ac630..4181dcde2 100644
Binary files a/lib/google_common_deploy.jar and b/lib/google_common_deploy.jar differ
diff --git a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
index 4e0d0d8b2..baf647d1f 100644
--- a/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/AbstractCommandLineRunner.java
@@ -27,6 +27,7 @@ import com.google.javascript.rhino.Node;
 import com.google.javascript.rhino.TokenStream;
 import com.google.protobuf.CodedOutputStream;
 
+import java.io.BufferedOutputStream;
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
@@ -498,8 +499,9 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
       options.outputCharset = inputCharset;
     }
 
-    if (!options.jsOutputFile.isEmpty()) {
-      out = new PrintStream(options.jsOutputFile, inputCharset.name());
+    boolean writeOutputToFile = !options.jsOutputFile.isEmpty();
+    if (writeOutputToFile) {
+      out = toPrintStream(options.jsOutputFile, inputCharset.name());
     }
 
     List<String> jsFiles = config.js;
@@ -514,7 +516,12 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
       result = compiler.compile(externs, inputs, options);
     }
 
-    return processResults(result, modules, options);
+    int errCode = processResults(result, modules, options);
+    // Close the output if we are writing to a file.
+    if (writeOutputToFile) {
+      out.close();
+    }
+    return errCode;
   }
 
   /**
@@ -585,9 +592,8 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
             mapOut = toPrintStream(expandSourceMapPath(options, m));
           }
 
-          PrintStream ps =
-              new PrintStream(new FileOutputStream(moduleFilePrefix
-                  + m.getName() + ".js"));
+          PrintStream ps = toPrintStream(
+              moduleFilePrefix + m.getName() + ".js");
 
           if (options.sourceMapOutputPath != null) {
             compiler.getSourceMap().reset();
@@ -686,7 +692,7 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
       exPath = outputFile.getParent() + File.separatorChar + exPath;
     }
 
-    return new PrintStream(new FileOutputStream(exPath));
+    return toPrintStream(exPath);
   }
 
   /**
@@ -735,14 +741,30 @@ abstract class AbstractCommandLineRunner<A extends Compiler,
   }
 
   /**
-   * Coverts a file name into a print stream.
+   * Converts a file name into a print stream.
    * Returns null if the file name is null.
    */
   private PrintStream toPrintStream(String fileName) throws IOException {
     if (fileName == null) {
       return null;
     }
-    return new PrintStream(new FileOutputStream(fileName));
+    return new PrintStream(
+        new BufferedOutputStream(
+            new FileOutputStream(fileName)), false);
+  }
+
+  /**
+   * Coverts a file name into a print stream.
+   * Returns null if the file name is null.
+   */
+  private PrintStream toPrintStream(String fileName, String charSet)
+      throws IOException {
+    if (fileName == null) {
+      return null;
+    }
+    return new PrintStream(
+        new BufferedOutputStream(
+            new FileOutputStream(fileName)), false, charSet);
   }
 
   /**
diff --git a/src/com/google/javascript/jscomp/CommandLineRunner.java b/src/com/google/javascript/jscomp/CommandLineRunner.java
index cc541ea3c..859b35768 100644
--- a/src/com/google/javascript/jscomp/CommandLineRunner.java
+++ b/src/com/google/javascript/jscomp/CommandLineRunner.java
@@ -16,7 +16,10 @@
 
 package com.google.javascript.jscomp;
 
+import com.google.common.base.Preconditions;
+import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Lists;
+import com.google.common.collect.Maps;
 import com.google.common.collect.Sets;
 import com.google.common.io.LimitInputStream;
 
@@ -32,6 +35,7 @@ import java.io.IOException;
 import java.io.InputStream;
 import java.io.PrintStream;
 import java.util.List;
+import java.util.Map;
 import java.util.Set;
 import java.util.logging.Level;
 import java.util.regex.Matcher;
@@ -484,6 +488,54 @@ public class CommandLineRunner extends
     }
   }
 
+  // The externs expected in externs.zip, in sorted order.
+  private static final List<String> DEFAULT_EXTERNS_NAMES = ImmutableList.of(
+    // JS externs
+    "es3.js",
+    "es5.js",
+
+    // Event APIs
+    "w3c_event.js",
+    "w3c_event3.js",
+    "gecko_event.js",
+    "ie_event.js",
+    "webkit_event.js",
+
+    // DOM apis
+    "w3c_dom1.js",
+    "w3c_dom2.js",
+    "w3c_dom3.js",
+    "gecko_dom.js",
+    "ie_dom.js",
+    "webkit_dom.js",
+
+    // CSS apis
+    "w3c_css.js",
+    "gecko_css.js",
+    "ie_css.js",
+    "webkit_css.js",
+
+    // Top-level namespaces
+    "google.js",
+
+    "deprecated.js",
+    "fileapi.js",
+    "flash.js",
+    "gears_symbols.js",
+    "gears_types.js",
+    "gecko_xml.js",
+    "html5.js",
+    "ie_vml.js",
+    "iphone.js",
+    "webstorage.js",
+    "w3c_elementtraversal.js",
+    "w3c_geolocation.js",
+    "w3c_range.js",
+    "w3c_selectors.js",
+    "w3c_xml.js",
+    "window.js",
+    "webkit_notifications.js");
+
   /**
    * @return a mutable list
    * @throws IOException
@@ -492,11 +544,28 @@ public class CommandLineRunner extends
     InputStream input = CommandLineRunner.class.getResourceAsStream(
         "/externs.zip");
     ZipInputStream zip = new ZipInputStream(input);
-    List<JSSourceFile> externs = Lists.newLinkedList();
+    Map<String, JSSourceFile> externsMap = Maps.newHashMap();
     for (ZipEntry entry = null; (entry = zip.getNextEntry()) != null; ) {
       LimitInputStream entryStream = new LimitInputStream(zip, entry.getSize());
-      externs.add(JSSourceFile.fromInputStream(entry.getName(), entryStream));
+      externsMap.put(entry.getName(),
+          JSSourceFile.fromInputStream(
+              // Give the files an odd prefix, so that they do not conflict
+              // with the user's files.
+              "externs.zip//" + entry.getName(),
+              entryStream));
     }
+
+    Preconditions.checkState(
+        externsMap.keySet().equals(Sets.newHashSet(DEFAULT_EXTERNS_NAMES)),
+        "Externs zip must match our hard-coded list of externs.");
+
+    // Order matters, so the resources must be added to the result list
+    // in the expected order.
+    List<JSSourceFile> externs = Lists.newArrayList();
+    for (String key : DEFAULT_EXTERNS_NAMES) {
+      externs.add(externsMap.get(key));
+    }
+
     return externs;
   }
 
diff --git a/src/com/google/javascript/jscomp/ant/CompileTask.java b/src/com/google/javascript/jscomp/ant/CompileTask.java
index a509f5f52..88b028275 100644
--- a/src/com/google/javascript/jscomp/ant/CompileTask.java
+++ b/src/com/google/javascript/jscomp/ant/CompileTask.java
@@ -17,7 +17,6 @@
 package com.google.javascript.jscomp.ant;
 
 import com.google.common.collect.Lists;
-import com.google.common.io.LimitInputStream;
 import com.google.javascript.jscomp.CommandLineRunner;
 import com.google.javascript.jscomp.CompilationLevel;
 import com.google.javascript.jscomp.Compiler;
@@ -35,13 +34,10 @@ import org.apache.tools.ant.types.FileList;
 import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
-import java.io.InputStream;
 import java.io.OutputStreamWriter;
 import java.nio.charset.Charset;
 import java.util.List;
 import java.util.logging.Level;
-import java.util.zip.ZipEntry;
-import java.util.zip.ZipInputStream;
 
 /**
  * This class implements a simple Ant task to do almost the same as
@@ -255,19 +251,7 @@ public final class CompileTask
    */
   private List<JSSourceFile> getDefaultExterns() {
     try {
-      InputStream input = Compiler.class.getResourceAsStream(
-          "/externs.zip");
-      ZipInputStream zip = new ZipInputStream(input);
-      List<JSSourceFile> externs = Lists.newLinkedList();
-
-      for (ZipEntry entry; (entry = zip.getNextEntry()) != null; ) {
-        LimitInputStream entryStream =
-            new LimitInputStream(zip, entry.getSize());
-        externs.add(
-            JSSourceFile.fromInputStream(entry.getName(), entryStream));
-      }
-
-      return externs;
+      return CommandLineRunner.getDefaultExterns();
     } catch (IOException e) {
       throw new BuildException(e);
     }
