{"url":"https://api.github.com/repos/electron/electron/issues/39658","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/39658/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/39658/comments","events_url":"https://api.github.com/repos/electron/electron/issues/39658/events","html_url":"https://github.com/electron/electron/issues/39658","id":1867015012,"node_id":"I_kwDOAI8xS85vSGNk","number":39658,"title":"[Bug]: protocol.handle unexpected behavior when request.body is a ReadableStream","user":{"login":"thecodrr","id":7473959,"node_id":"MDQ6VXNlcjc0NzM5NTk=","avatar_url":"https://avatars.githubusercontent.com/u/7473959?v=4","gravatar_id":"","url":"https://api.github.com/users/thecodrr","html_url":"https://github.com/thecodrr","followers_url":"https://api.github.com/users/thecodrr/followers","following_url":"https://api.github.com/users/thecodrr/following{/other_user}","gists_url":"https://api.github.com/users/thecodrr/gists{/gist_id}","starred_url":"https://api.github.com/users/thecodrr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thecodrr/subscriptions","organizations_url":"https://api.github.com/users/thecodrr/orgs","repos_url":"https://api.github.com/users/thecodrr/repos","events_url":"https://api.github.com/users/thecodrr/events{/privacy}","received_events_url":"https://api.github.com/users/thecodrr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":97403549,"node_id":"MDU6TGFiZWw5NzQwMzU0OQ==","url":"https://api.github.com/repos/electron/electron/labels/platform/windows","name":"platform/windows","color":"c7def8","default":false,"description":null},{"id":520323169,"node_id":"MDU6TGFiZWw1MjAzMjMxNjk=","url":"https://api.github.com/repos/electron/electron/labels/bug%20:beetle:","name":"bug :beetle:","color":"fbca04","default":false,"description":""},{"id":901782761,"node_id":"MDU6TGFiZWw5MDE3ODI3NjE=","url":"https://api.github.com/repos/electron/electron/labels/status/confirmed","name":"status/confirmed","color":"c2e0c6","default":false,"description":"A maintainer reproduced the bug or agreed with the feature"},{"id":2285277606,"node_id":"MDU6TGFiZWwyMjg1Mjc3NjA2","url":"https://api.github.com/repos/electron/electron/labels/has-repro-gist","name":"has-repro-gist","color":"c2e0c6","default":false,"description":"Issue can be reproduced with code at https://gist.github.com/"},{"id":5566791445,"node_id":"LA_kwDOAI8xS88AAAABS85_FQ","url":"https://api.github.com/repos/electron/electron/labels/26-x-y","name":"26-x-y","color":"ededed","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2023-08-25T12:58:59Z","updated_at":"2024-02-16T19:29:30Z","closed_at":"2024-02-16T19:29:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n26.1.0\r\n\r\n### What operating system are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nWindows 11 22H2\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nIterating on a `ReadableStream` inside `protocol.handle` should not output anything except what is fed into the stream.\r\n\r\n### Actual Behavior\r\n\r\nCurrently, doing this outputs a bunch of `undefined` entries when it shouldn't\r\n\r\n```ts\r\nprotocol.handle(SCHEME, async (request) => {\r\n  console.log(\"starting stream\");\r\n  for await (const p of request.body) {\r\n    console.log(p);\r\n  }\r\n  console.log(\"ending stream\");\r\n});\r\n```\r\nFor some reason, the first few logs are correct outputting `Uint8Array` as expected but it eventually starts outputting `undefined`:\r\n\r\n```\r\nstarting stream\r\nUint8Array(5) [ 84, 104, 105, 115, 32 ]\r\nUint8Array(3) [ 105, 115, 32 ]\r\nUint8Array(2) [ 97, 32 ]\r\nUint8Array(5) [ 115, 108, 111, 119, 32 ]\r\nUint8Array(8) [\r\n  114, 101, 113,\r\n  117, 101, 115,\r\n  116,  46\r\n]\r\nundefined\r\nundefined\r\nundefined\r\nundefined\r\nundefined\r\nundefined\r\nundefined\r\nundefined\r\nending stream\r\n```\r\n\r\nThe main problem is that such a `ReadableStream` is not accepted by `net.fetch` or `fetch` and they crash with the following error:\r\n\r\n```\r\nnode:52760) UnhandledPromiseRejectionWarning: TypeError [ERR_INVALID_ARG_TYPE]: The \"chunk\" argument must be of type string or an instance of Buffer or Uint8Array. Received undefined\r\n    at new NodeError (node:internal/errors:399:5)\r\n    at _write (node:internal/streams/writable:315:13)\r\n    at ClientRequest.write (node:internal/streams/writable:337:10)\r\n    at Object.write (node:internal/webstreams/adapters:179:63)\r\n    at ensureIsPromise (node:internal/webstreams/util:192:19)\r\n    at writableStreamDefaultControllerProcessWrite (node:internal/webstreams/writablestream:1115:5)\r\n    at writableStreamDefaultControllerAdvanceQueueIfNeeded (node:internal/webstreams/writablestream:1230:5)\r\n    at writableStreamDefaultControllerWrite (node:internal/webstreams/writablestream:1104:3)\r\n    at writableStreamDefaultWriterWrite (node:internal/webstreams/writablestream:994:3)\r\n    at [kChunk] (node:internal/webstreams/readablestream:1399:28)\r\n(Use `Notesnook --trace-warnings ...` to show where the warning was created)\r\n(node:52760) UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async function without a catch block, or by rejecting a promise which was not handled with .catch(). To terminate the node process on unhandled promise rejection, use the CLI flag `--unhandled-rejections=strict` (see https://nodejs.org/api/cli.html#cli_unhandled_rejections_mode). (rejection id: 9)\r\n```\r\n\r\nOn the browser side, I am doing a simple fetch like so:\r\n\r\n```ts\r\n  function wait(milliseconds: number) {\r\n    return new Promise((resolve) => setTimeout(resolve, milliseconds));\r\n  }\r\n\r\n  const stream = new ReadableStream({\r\n    async start(controller) {\r\n      await wait(1000);\r\n      controller.enqueue(\"This \");\r\n      await wait(1000);\r\n      controller.enqueue(\"is \");\r\n      await wait(1000);\r\n      controller.enqueue(\"a \");\r\n      await wait(1000);\r\n      controller.enqueue(\"slow \");\r\n      await wait(1000);\r\n      controller.enqueue(\"request.\");\r\n      controller.close();\r\n    }\r\n  }).pipeThrough(new TextEncoderStream());\r\n\r\nconst response = await fetch(uploadUrl, {\r\n    method: \"PUT\",\r\n    body: stream,\r\n    signal,\r\n    duplex: \"half\"\r\n  });\r\n```\r\n\r\n### Testcase Gist URL\r\n\r\nhttps://gist.github.com/thecodrr/ddabb97be1e93435f9e25dcfab76876e\r\n\r\n### Additional Information\r\n\r\n_No response_","closed_by":{"login":"jkleinsc","id":609052,"node_id":"MDQ6VXNlcjYwOTA1Mg==","avatar_url":"https://avatars.githubusercontent.com/u/609052?v=4","gravatar_id":"","url":"https://api.github.com/users/jkleinsc","html_url":"https://github.com/jkleinsc","followers_url":"https://api.github.com/users/jkleinsc/followers","following_url":"https://api.github.com/users/jkleinsc/following{/other_user}","gists_url":"https://api.github.com/users/jkleinsc/gists{/gist_id}","starred_url":"https://api.github.com/users/jkleinsc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkleinsc/subscriptions","organizations_url":"https://api.github.com/users/jkleinsc/orgs","repos_url":"https://api.github.com/users/jkleinsc/repos","events_url":"https://api.github.com/users/jkleinsc/events{/privacy}","received_events_url":"https://api.github.com/users/jkleinsc/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/39658/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/39658/timeline","performed_via_github_app":null,"state_reason":"completed"}