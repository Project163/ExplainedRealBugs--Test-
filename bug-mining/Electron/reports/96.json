{"url":"https://api.github.com/repos/electron/electron/issues/25628","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/25628/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/25628/comments","events_url":"https://api.github.com/repos/electron/electron/issues/25628/events","html_url":"https://github.com/electron/electron/issues/25628","id":708699611,"node_id":"MDU6SXNzdWU3MDg2OTk2MTE=","number":25628,"title":"data in other charset like GBK in Content-disposition cannot be encoded correctly ","user":{"login":"bigben0123","id":11641180,"node_id":"MDQ6VXNlcjExNjQxMTgw","avatar_url":"https://avatars.githubusercontent.com/u/11641180?v=4","gravatar_id":"","url":"https://api.github.com/users/bigben0123","html_url":"https://github.com/bigben0123","followers_url":"https://api.github.com/users/bigben0123/followers","following_url":"https://api.github.com/users/bigben0123/following{/other_user}","gists_url":"https://api.github.com/users/bigben0123/gists{/gist_id}","starred_url":"https://api.github.com/users/bigben0123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bigben0123/subscriptions","organizations_url":"https://api.github.com/users/bigben0123/orgs","repos_url":"https://api.github.com/users/bigben0123/repos","events_url":"https://api.github.com/users/bigben0123/events{/privacy}","received_events_url":"https://api.github.com/users/bigben0123/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":520323169,"node_id":"MDU6TGFiZWw1MjAzMjMxNjk=","url":"https://api.github.com/repos/electron/electron/labels/bug%20:beetle:","name":"bug :beetle:","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-09-25T07:04:51Z","updated_at":"2022-10-13T15:21:20Z","closed_at":"2020-10-28T07:00:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--  As an open source project with a dedicated but small maintainer team, it can sometimes take a long time for issues to be addressed so please be patient and we will get back to you as soon as we can.\r\n-->\r\n\r\n### Preflight Checklist\r\n<!-- Please ensure you've completed the following steps by replacing [ ] with [x]-->\r\n\r\n* [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/master/CONTRIBUTING.md) for this project.\r\n* [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/master/CODE_OF_CONDUCT.md) that this project adheres to.\r\n* [x] I have searched the issue tracker for an issue that matches the one I want to file, without success.\r\n\r\n### Issue Details\r\n\r\n* **Electron Version:**\r\n  * All\r\n  \r\n* **Operating System:**\r\n  * All\r\n  \r\n* **Last Known Working Electron version:**\r\n  * Unknown\r\n\r\n### Expected Behavior\r\nIf the filename encoded other than UTF-8 in http header, the filename in Content-disposition should be returned correctly after webRequest.onHeadersReceived is called.\r\n\r\n### Actual Behavior\r\nIf the filename in content-disposition encoded in GBK, before passing the http header to js, the head is converted in UTF-8 instead of doing converting code by charset. Therefore, when callback return, the filename become chaos.\r\n\r\n### To Reproduce\r\nWhen visiting a url, server responds a http header:\r\n```\r\n0x0000:  4854 5450 2f31 2e31 2032 3030 0041 6363                HTTP/1.1.200.Acc\r\n0x0010:  6573 732d 436f 6e74 726f 6c2d 416c 6c6f                ess-Control-Allo\r\n0x0020:  772d 4f72 6967 696e 3a20 272a 2700 4163                w-Origin:.'*'.Ac\r\n0x0030:  6365 7373 2d43 6f6e 7472 6f6c 2d41 6c6c                cess-Control-All\r\n0x0040:  6f77 2d4d 6574 686f 6473 3a20 504f 5354                ow-Methods:.POST\r\n0x0050:  2c20 4745 542c 204f 5054 494f 4e53 0041                ,.GET,.OPTIONS.A\r\n0x0060:  6363 6573 732d 436f 6e74 726f 6c2d 416c                ccess-Control-Al\r\n0x0070:  6c6f 772d 4865 6164 6572 733a 206f 7269                low-Headers:.ori\r\n0x0080:  6769 6e2c 2078 2d63 7372 6674 6f6b 656e                gin,.x-csrftoken\r\n0x0090:  2c20 636f 6e74 656e 742d 7479 7065 2c20                ,.content-type,.\r\n0x00a0:  6163 6365 7074 0058 2d41 7070 6c69 6361                accept.X-Applica\r\n0x00b0:  7469 6f6e 2d43 6f6e 7465 7874 3a20 6170                tion-Context:.ap\r\n0x00c0:  706c 6963 6174 696f 6e3a 6465 7665 6c6f                plication:develo\r\n0x00d0:  706d 656e 743a 3830 3837 0043 6f6e 7465                pment:8087.Conte\r\n0x00e0:  6e74 2d64 6973 706f 7369 7469 6f6e 3a20                nt-disposition:.\r\n0x00f0:  6174 7461 6368 6d65 6e74 3b20 6669 6c65                attachment;.file\r\n0x0100:  6e61 6d65 3dcc eccc ecd5 e2d1 f95f 5f32                name=........__2\r\n0x0110:  3032 3030 3932 345f 3034 3232 3533 3200                0200924_0422532.\r\n0x0120:  436f 6e74 656e 742d 5479 7065 3a20 6170                Content-Type:.ap\r\n0x0130:  706c 6963 6174 696f 6e2f 6f63 7465 742d                plication/octet-\r\n0x0140:  7374 7265 616d 0054 7261 6e73 6665 722d                stream.Transfer-\r\n0x0150:  456e 636f 6469 6e67 3a20 6368 756e 6b65                Encoding:.chunke\r\n0x0160:  6400 4461 7465 3a20 5468 752c 2032 3420                d.Date:.Thu,.24.\r\n0x0170:  5365 7020 3230 3230 2030 383a 3232 3a31                Sep.2020.08:22:1\r\n0x0180:  3720 474d 5400 00                                      7.GMT..\r\n```\r\n\r\nWhen the onHeadersReceived is regitered, like the following:\r\n```\r\nsession.defaultSession.webRequest.onHeadersReceived((details, callback) => {\r\n                            callback({\r\n                                cancel: false,\r\n                                responseHeaders: details.responseHeaders,\r\n                                statusLine: details.statusLine,\r\n                            });\r\n});\r\n```\r\nThen, the response header has been change to:\r\n```\r\n0x0000:  4854 5450 2f31 2e31 2032 3030 0041 6363  HTTP/1.1.200.Acc\r\n0x0010:  6573 732d 436f 6e74 726f 6c2d 416c 6c6f  ess-Control-Allo\r\n0x0020:  772d 4865 6164 6572 733a 206f 7269 6769  w-Headers:.origi\r\n0x0030:  6e2c 2078 2d63 7372 6674 6f6b 656e 2c20  n,.x-csrftoken,.\r\n0x0040:  636f 6e74 656e 742d 7479 7065 2c20 6163  content-type,.ac\r\n0x0050:  6365 7074 0041 6363 6573 732d 436f 6e74  cept.Access-Cont\r\n0x0060:  726f 6c2d 416c 6c6f 772d 4d65 7468 6f64  rol-Allow-Method\r\n0x0070:  733a 2050 4f53 542c 2047 4554 2c20 4f50  s:.POST,.GET,.OP\r\n0x0080:  5449 4f4e 5300 4163 6365 7373 2d43 6f6e  TIONS.Access-Con\r\n0x0090:  7472 6f6c 2d41 6c6c 6f77 2d4f 7269 6769  trol-Allow-Origi\r\n0x00a0:  6e3a 2027 2a27 0043 6f6e 7465 6e74 2d54  n:.'*'.Content-T\r\n0x00b0:  7970 653a 2061 7070 6c69 6361 7469 6f6e  ype:.application\r\n0x00c0:  2f6f 6374 6574 2d73 7472 6561 6d00 436f  /octet-stream.Co\r\n0x00d0:  6e74 656e 742d 6469 7370 6f73 6974 696f  ntent-dispositio\r\n0x00e0:  6e3a 2061 7474 6163 686d 656e 743b 2066  n:.attachment;.f\r\n0x00f0:  696c 656e 616d 653d efbf bdef bfbd efbf  ilename=........\r\n0x0100:  bdef bfbd efbf bdef bfbd efbf bdef bfbd  ................\r\n0x0110:  5f5f 3230 3230 3039 3234 5f30 3432 3235  __20200924_04225\r\n0x0120:  3332 0044 6174 653a 2054 6875 2c20 3234  32.Date:.Thu,.24\r\n0x0130:  2053 6570 2032 3032 3020 3038 3a32 323a  .Sep.2020.08:22:\r\n0x0140:  3137 2047 4d54 0054 7261 6e73 6665 722d  17.GMT.Transfer-\r\n0x0150:  456e 636f 6469 6e67 3a20 6368 756e 6b65  Encoding:.chunke\r\n0x0160:  6400 582d 4170 706c 6963 6174 696f 6e2d  d.X-Application-\r\n0x0170:  436f 6e74 6578 743a 2061 7070 6c69 6361  Context:.applica\r\n0x0180:  7469 6f6e 3a64 6576 656c 6f70 6d65 6e74  tion:development\r\n0x0190:  3a38 3038 3700 00                        :8087..\r\n```\r\n\r\nThe original filename in Content-disposition has been lost forever.\r\n\r\n\r\n### Additional Information\r\nI've investigated the reason. It is because the call \r\n  gin::ConvertToV8(v8::Isolate::GetCurrent(), response_headers); \r\non the function HttpResponseHeadersToV8\r\nin the source file electron_api_web_request.cc.\r\n","closed_by":{"login":"zcbenz","id":639601,"node_id":"MDQ6VXNlcjYzOTYwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/639601?v=4","gravatar_id":"","url":"https://api.github.com/users/zcbenz","html_url":"https://github.com/zcbenz","followers_url":"https://api.github.com/users/zcbenz/followers","following_url":"https://api.github.com/users/zcbenz/following{/other_user}","gists_url":"https://api.github.com/users/zcbenz/gists{/gist_id}","starred_url":"https://api.github.com/users/zcbenz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zcbenz/subscriptions","organizations_url":"https://api.github.com/users/zcbenz/orgs","repos_url":"https://api.github.com/users/zcbenz/repos","events_url":"https://api.github.com/users/zcbenz/events{/privacy}","received_events_url":"https://api.github.com/users/zcbenz/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/25628/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/25628/timeline","performed_via_github_app":null,"state_reason":"completed"}