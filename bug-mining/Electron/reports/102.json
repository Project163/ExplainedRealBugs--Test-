{"url":"https://api.github.com/repos/electron/electron/issues/29463","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/29463/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/29463/comments","events_url":"https://api.github.com/repos/electron/electron/issues/29463/events","html_url":"https://github.com/electron/electron/issues/29463","id":908687983,"node_id":"MDU6SXNzdWU5MDg2ODc5ODM=","number":29463,"title":"Microtasks policy incorrect, leading to DCHECK, when calling `window.open` from `setImmediate`","user":{"login":"nornagon","id":172800,"node_id":"MDQ6VXNlcjE3MjgwMA==","avatar_url":"https://avatars.githubusercontent.com/u/172800?v=4","gravatar_id":"","url":"https://api.github.com/users/nornagon","html_url":"https://github.com/nornagon","followers_url":"https://api.github.com/users/nornagon/followers","following_url":"https://api.github.com/users/nornagon/following{/other_user}","gists_url":"https://api.github.com/users/nornagon/gists{/gist_id}","starred_url":"https://api.github.com/users/nornagon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nornagon/subscriptions","organizations_url":"https://api.github.com/users/nornagon/orgs","repos_url":"https://api.github.com/users/nornagon/repos","events_url":"https://api.github.com/users/nornagon/events{/privacy}","received_events_url":"https://api.github.com/users/nornagon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":520323169,"node_id":"MDU6TGFiZWw1MjAzMjMxNjk=","url":"https://api.github.com/repos/electron/electron/labels/bug%20:beetle:","name":"bug :beetle:","color":"fbca04","default":false,"description":""},{"id":565223195,"node_id":"MDU6TGFiZWw1NjUyMjMxOTU=","url":"https://api.github.com/repos/electron/electron/labels/component/node-integration","name":"component/node-integration","color":"f9d0c4","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"codebytere","id":2036040,"node_id":"MDQ6VXNlcjIwMzYwNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2036040?v=4","gravatar_id":"","url":"https://api.github.com/users/codebytere","html_url":"https://github.com/codebytere","followers_url":"https://api.github.com/users/codebytere/followers","following_url":"https://api.github.com/users/codebytere/following{/other_user}","gists_url":"https://api.github.com/users/codebytere/gists{/gist_id}","starred_url":"https://api.github.com/users/codebytere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codebytere/subscriptions","organizations_url":"https://api.github.com/users/codebytere/orgs","repos_url":"https://api.github.com/users/codebytere/repos","events_url":"https://api.github.com/users/codebytere/events{/privacy}","received_events_url":"https://api.github.com/users/codebytere/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"codebytere","id":2036040,"node_id":"MDQ6VXNlcjIwMzYwNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2036040?v=4","gravatar_id":"","url":"https://api.github.com/users/codebytere","html_url":"https://github.com/codebytere","followers_url":"https://api.github.com/users/codebytere/followers","following_url":"https://api.github.com/users/codebytere/following{/other_user}","gists_url":"https://api.github.com/users/codebytere/gists{/gist_id}","starred_url":"https://api.github.com/users/codebytere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codebytere/subscriptions","organizations_url":"https://api.github.com/users/codebytere/orgs","repos_url":"https://api.github.com/users/codebytere/repos","events_url":"https://api.github.com/users/codebytere/events{/privacy}","received_events_url":"https://api.github.com/users/codebytere/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2021-06-01T21:09:01Z","updated_at":"2021-06-21T05:06:17Z","closed_at":"2021-06-21T05:06:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"To repro, run this fiddle under a debug build: https://gist.github.com/b72948eafa5a2f61acf9f4718ff09259\r\n\r\n```\r\n#\r\n# Fatal error in ../../v8/src/api/api-inl.h, line 183\r\n# Debug check failed: microtask_queue->GetMicrotasksScopeDepth() || !microtask_queue->DebugMicrotasksScopeDepthIsZero().\r\n#\r\n#\r\n#\r\n#FailureMessage Object: 0x7ffeebb54620\r\n0   Electron Framework                  0x000000010c472bb9 base::debug::CollectStackTrace(void**, unsigned long) + 9\r\n1   Electron Framework                  0x000000010c38e243 base::debug::StackTrace::StackTrace() + 19\r\n2   Electron Framework                  0x000000010e820ffd gin::(anonymous namespace)::PrintStackTrace() + 45\r\n3   Electron Framework                  0x000000010e1f7136 V8_Fatal(char const*, int, char const*, ...) + 326\r\n4   Electron Framework                  0x000000010e1f6b15 v8::base::(anonymous namespace)::DefaultDcheckHandler(char const*, int, char const*) + 21\r\n5   Electron Framework                  0x0000000109695f11 v8::CallDepthScope<true>::~CallDepthScope() + 865\r\n6   Electron Framework                  0x0000000109653283 v8::Function::Call(v8::Local<v8::Context>, v8::Local<v8::Value>, int, v8::Local<v8::Value>*) + 835\r\n7   Electron Framework                  0x00000001118657e2 node::InternalMakeCallback(node::Environment*, v8::Local<v8::Object>, v8::Local<v8::Object>, v8::Local<v8::Function>, int, v8::Local<v8::Value>*, node::async_context) + 738\r\n8   Electron Framework                  0x0000000111865aab node::MakeCallback(v8::Isolate*, v8::Local<v8::Object>, v8::Local<v8::Function>, int, v8::Local<v8::Value>*, node::async_context) + 187\r\n9   Electron Framework                  0x00000001118aebf5 node::Environment::CheckImmediate(uv_check_s*) + 181\r\n10  Electron Framework                  0x0000000107c458ad uv__run_check + 157\r\n11  Electron Framework                  0x0000000107c3f7e1 uv_run + 369\r\n12  Electron Framework                  0x0000000107e0964c electron::NodeBindings::UvRunOnce() + 348\r\n13  Electron Framework                  0x0000000107e0ae04 base::internal::Invoker<base::internal::BindState<void (electron::NodeBindings::*)(), base::WeakPtr<electron::NodeBindings> >, void ()>::RunOnce(base::internal::BindStateBase*) + 148\r\n14  Electron Framework                  0x000000010c40a190 base::TaskAnnotator::RunTask(char const*, base::PendingTask*) + 400\r\n15  Electron Framework                  0x000000010c42e292 base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWorkImpl(base::sequence_manager::LazyNow*) + 994\r\n16  Electron Framework                  0x000000010c42dab8 base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::DoWork() + 88\r\n17  Electron Framework                  0x000000010c489d71 base::MessagePumpCFRunLoopBase::RunWork() + 65\r\n18  Electron Framework                  0x000000010c4829a2 base::mac::CallWithEHFrame(void () block_pointer) + 10\r\n19  Electron Framework                  0x000000010c48979f base::MessagePumpCFRunLoopBase::RunWorkSource(void*) + 63\r\n20  CoreFoundation                      0x00007fff2f446832 __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17\r\n21  CoreFoundation                      0x00007fff2f4467d1 __CFRunLoopDoSource0 + 103\r\n22  CoreFoundation                      0x00007fff2f4465eb __CFRunLoopDoSources0 + 209\r\n23  CoreFoundation                      0x00007fff2f44531a __CFRunLoopRun + 927\r\n24  CoreFoundation                      0x00007fff2f44491e CFRunLoopRunSpecific + 462\r\n25  Foundation                          0x00007fff31ae01a8 -[NSRunLoop(NSRunLoop) runMode:beforeDate:] + 212\r\n26  Electron Framework                  0x000000010c48a3ae base::MessagePumpNSRunLoop::DoRun(base::MessagePump::Delegate*) + 126\r\n27  Electron Framework                  0x000000010c48914c base::MessagePumpCFRunLoopBase::Run(base::MessagePump::Delegate*) + 140\r\n28  Electron Framework                  0x000000010c42ee5b base::sequence_manager::internal::ThreadControllerWithMessagePumpImpl::Run(bool, base::TimeDelta) + 651\r\n29  Electron Framework                  0x000000010c3e2d6a base::RunLoop::Run(base::Location const&) + 890\r\n30  Electron Framework                  0x00000001115efc1b content::RendererMain(content::MainFunctionParams const&) + 1611\r\n31  Electron Framework                  0x00000001095d3c27 content::ContentMainRunnerImpl::Run(bool) + 503\r\n32  Electron Framework                  0x00000001095d2b32 content::RunContentProcess(content::ContentMainParams const&, content::ContentMainRunner*) + 2658\r\n33  Electron Framework                  0x00000001095d2c1c content::ContentMain(content::ContentMainParams const&) + 44\r\n34  Electron Framework                  0x0000000107c52297 ElectronMain + 135\r\n35  Electron Helper (Renderer)          0x00000001040ad1b7 main + 439\r\n36  libdyld.dylib                       0x00007fff694e6cc9 start + 1\r\n```\r\n\r\nI believe this is due to the hack in `UvRunOnce` being insufficient to swap between `kExplicit` and `kScoped` microtask policies when a new node environment is created during execution of `UvRunOnce`. i.e. this:\r\n\r\nhttps://github.com/electron/electron/blob/fa703016f0fcaebed611b23700558fd0fcf064ff/shell/common/node_bindings.cc#L580-L586\r\n\r\nsets the policy to `kExplicit`, but then `CreateEnvironment` is called during the tick, and subsequently this:\r\n\r\nhttps://github.com/electron/electron/blob/fa703016f0fcaebed611b23700558fd0fcf064ff/shell/common/node_bindings.cc#L518\r\n\r\nis called, which sets the policy back to `kScoped`, due to:\r\n\r\nhttps://github.com/electron/electron/blob/fa703016f0fcaebed611b23700558fd0fcf064ff/shell/common/node_bindings.cc#L490-L492\r\n\r\nSince the policy is now `kScoped`, the DCHECK in question triggers the next time a JS function is called, which is in the `CheckImmediate` code in Node.\r\n\r\ncc @codebytere ","closed_by":{"login":"zcbenz","id":639601,"node_id":"MDQ6VXNlcjYzOTYwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/639601?v=4","gravatar_id":"","url":"https://api.github.com/users/zcbenz","html_url":"https://github.com/zcbenz","followers_url":"https://api.github.com/users/zcbenz/followers","following_url":"https://api.github.com/users/zcbenz/following{/other_user}","gists_url":"https://api.github.com/users/zcbenz/gists{/gist_id}","starred_url":"https://api.github.com/users/zcbenz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zcbenz/subscriptions","organizations_url":"https://api.github.com/users/zcbenz/orgs","repos_url":"https://api.github.com/users/zcbenz/repos","events_url":"https://api.github.com/users/zcbenz/events{/privacy}","received_events_url":"https://api.github.com/users/zcbenz/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/29463/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/29463/timeline","performed_via_github_app":null,"state_reason":"completed"}