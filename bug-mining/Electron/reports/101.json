{"url":"https://api.github.com/repos/electron/electron/issues/27039","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/27039/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/27039/comments","events_url":"https://api.github.com/repos/electron/electron/issues/27039/events","html_url":"https://github.com/electron/electron/issues/27039","id":768407152,"node_id":"MDU6SXNzdWU3Njg0MDcxNTI=","number":27039,"title":"Memory leak when passing IPC events over contextBridge","user":{"login":"PDStig","id":11471458,"node_id":"MDQ6VXNlcjExNDcxNDU4","avatar_url":"https://avatars.githubusercontent.com/u/11471458?v=4","gravatar_id":"","url":"https://api.github.com/users/PDStig","html_url":"https://github.com/PDStig","followers_url":"https://api.github.com/users/PDStig/followers","following_url":"https://api.github.com/users/PDStig/following{/other_user}","gists_url":"https://api.github.com/users/PDStig/gists{/gist_id}","starred_url":"https://api.github.com/users/PDStig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PDStig/subscriptions","organizations_url":"https://api.github.com/users/PDStig/orgs","repos_url":"https://api.github.com/users/PDStig/repos","events_url":"https://api.github.com/users/PDStig/events{/privacy}","received_events_url":"https://api.github.com/users/PDStig/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":112721857,"node_id":"MDU6TGFiZWwxMTI3MjE4NTc=","url":"https://api.github.com/repos/electron/electron/labels/performance%20:checkered_flag:","name":"performance :checkered_flag:","color":"d4c5f9","default":false,"description":""},{"id":520323169,"node_id":"MDU6TGFiZWw1MjAzMjMxNjk=","url":"https://api.github.com/repos/electron/electron/labels/bug%20:beetle:","name":"bug :beetle:","color":"fbca04","default":false,"description":""},{"id":1780693018,"node_id":"MDU6TGFiZWwxNzgwNjkzMDE4","url":"https://api.github.com/repos/electron/electron/labels/9-x-y","name":"9-x-y","color":"ededed","default":false,"description":""},{"id":2285277606,"node_id":"MDU6TGFiZWwyMjg1Mjc3NjA2","url":"https://api.github.com/repos/electron/electron/labels/has-repro-gist","name":"has-repro-gist","color":"c2e0c6","default":false,"description":"Issue can be reproduced with code at https://gist.github.com/"},{"id":2303357178,"node_id":"MDU6TGFiZWwyMzAzMzU3MTc4","url":"https://api.github.com/repos/electron/electron/labels/11-x-y","name":"11-x-y","color":"ededed","default":false,"description":""},{"id":2528261700,"node_id":"MDU6TGFiZWwyNTI4MjYxNzAw","url":"https://api.github.com/repos/electron/electron/labels/component/ipc","name":"component/ipc","color":"f9d0c4","default":false,"description":""},{"id":2591914033,"node_id":"MDU6TGFiZWwyNTkxOTE0MDMz","url":"https://api.github.com/repos/electron/electron/labels/component/context-bridge","name":"component/context-bridge","color":"f9d0c4","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-12-16T03:09:51Z","updated_at":"2021-02-05T20:39:06Z","closed_at":"2021-02-05T20:39:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--  As an open source project with a dedicated but small maintainer team, it can sometimes take a long time for issues to be addressed so please be patient and we will get back to you as soon as we can.\r\n-->\r\n\r\n### Preflight Checklist\r\n<!-- Please ensure you've completed the following steps by replacing [ ] with [x]-->\r\n\r\n* [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/master/CONTRIBUTING.md) for this project.\r\n* [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/master/CODE_OF_CONDUCT.md) that this project adheres to.\r\n* [X] I have searched the issue tracker for an issue that matches the one I want to file, without success.\r\n\r\n### Issue Details\r\n\r\n* **Electron Version:**\r\n  * 11.1.0 and 9.3.5\r\n* **Operating System:**\r\n  * Windows 10 2004\r\n* **Last Known Working Electron version:**\r\n  * NA\r\n\r\n### Expected Behavior\r\nuse of webContents.send + ipcRenderer.on cleans up memory after use\r\n\r\n### Actual Behavior\r\n\r\nIn a real-world case, I have a renderer for the UI and a separate browserWindow for an audio process. The audio process monitors audio devices and reports the current volume of all devices via ipcRenderer.send (through preload contextBridge to the main process). The main process then sends this volume data over to the main UI renderer via webContents.send whereas the UI renderer listens via ipcRenderer.on (via preload contextBridge). This happens about once every 100 milliseconds. Memory use of the electron app, especially the renderer, slowly climbs to theoretical Infinitum. The starting memory is about 350MB. Within about a day, it's up to 1,500MB.\r\n\r\nIt does not matter what kind of content is passed through as arguments, nor its size (garbage collector seems to work on arguments). What matters is how often / frequently webContents.send is called and if there is an ipcRenderer.on listener for it (memory leak still exists even if there is nothing in the listener function so long as the listener exists).\r\n\r\n### To Reproduce\r\n\r\nElectron fiddle with a very simple example calling webContents.send every millisecond (to make the test quick... but the issue exists if you do every 100 milliseconds too but is much slower) and sending a Math.random() random number to the renderer. Memory use will increase over the course of a few minutes. I tested with a 10,000-item map as an argument as well, which made memory spike very quickly and get garbage-collected repeatedly, resulting in an average memory growth of about the same as Math.random(). This leads me to believe the problem is not the data being sent but the IPC execution itself.\r\n\r\n[https://gist.github.com/37cde4adc11b3aa3f435e5d2698d9e05](https://gist.github.com/37cde4adc11b3aa3f435e5d2698d9e05)\r\n\r\n### Additional Information\r\n\r\nAdditional info: Using handle/invoke seems to bypass this memory leak. However this is not ideal because renderer UI has to query main every 100 milliseconds for audio volume, and main has to locally store volume information (via another invoke / handle between main and the audio process). This creates additional VU meter lag.","closed_by":{"login":"MarshallOfSound","id":6634592,"node_id":"MDQ6VXNlcjY2MzQ1OTI=","avatar_url":"https://avatars.githubusercontent.com/u/6634592?v=4","gravatar_id":"","url":"https://api.github.com/users/MarshallOfSound","html_url":"https://github.com/MarshallOfSound","followers_url":"https://api.github.com/users/MarshallOfSound/followers","following_url":"https://api.github.com/users/MarshallOfSound/following{/other_user}","gists_url":"https://api.github.com/users/MarshallOfSound/gists{/gist_id}","starred_url":"https://api.github.com/users/MarshallOfSound/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MarshallOfSound/subscriptions","organizations_url":"https://api.github.com/users/MarshallOfSound/orgs","repos_url":"https://api.github.com/users/MarshallOfSound/repos","events_url":"https://api.github.com/users/MarshallOfSound/events{/privacy}","received_events_url":"https://api.github.com/users/MarshallOfSound/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/27039/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/27039/timeline","performed_via_github_app":null,"state_reason":"completed"}