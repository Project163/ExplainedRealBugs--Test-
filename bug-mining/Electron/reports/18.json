{"url":"https://api.github.com/repos/electron/electron/issues/3380","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/3380/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/3380/comments","events_url":"https://api.github.com/repos/electron/electron/issues/3380/events","html_url":"https://github.com/electron/electron/issues/3380","id":116026760,"node_id":"MDU6SXNzdWUxMTYwMjY3NjA=","number":3380,"title":"Calling BrowserWindow.close in page-title-updated handler crashes electron","user":{"login":"rprichard","id":1572855,"node_id":"MDQ6VXNlcjE1NzI4NTU=","avatar_url":"https://avatars.githubusercontent.com/u/1572855?v=4","gravatar_id":"","url":"https://api.github.com/users/rprichard","html_url":"https://github.com/rprichard","followers_url":"https://api.github.com/users/rprichard/followers","following_url":"https://api.github.com/users/rprichard/following{/other_user}","gists_url":"https://api.github.com/users/rprichard/gists{/gist_id}","starred_url":"https://api.github.com/users/rprichard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rprichard/subscriptions","organizations_url":"https://api.github.com/users/rprichard/orgs","repos_url":"https://api.github.com/users/rprichard/repos","events_url":"https://api.github.com/users/rprichard/events{/privacy}","received_events_url":"https://api.github.com/users/rprichard/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":144752898,"node_id":"MDU6TGFiZWwxNDQ3NTI4OTg=","url":"https://api.github.com/repos/electron/electron/labels/crash%20:boom:","name":"crash :boom:","color":"A88EB9","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2015-11-10T04:56:38Z","updated_at":"2015-12-01T11:12:34Z","closed_at":"2015-12-01T11:12:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Test program:\n\npackage.json:\n\n``` json\n{\n    \"name\": \"CloseHandlingCrash\",\n    \"productName\": \"CloseHandlingCrash\",\n    \"version\": \"0.1.0\",\n    \"main\": \"main.js\"\n}\n```\n\nmain.js:\n\n``` javascript\nvar BrowserWindow = require(\"browser-window\");\nvar app = require(\"app\");\n\napp.on(\"ready\", function() {\n    var dummyWindow = new BrowserWindow({\n        title: \"Parent\",\n        show: true,\n    });\n    var w = new BrowserWindow({\n        title: \"Child\",\n        show: true,\n    });\n    w.on(\"page-title-updated\", function(event) {\n        var newTitle = w.webContents.getTitle();\n        console.log(\"page-title-updated: title=\" + newTitle);\n        w.close();\n        console.log(\"page-title-updated: returning\");\n    });\n    w.on(\"close\", function() {\n        console.log(\"close\");\n    });\n    w.on(\"closed\", function() {\n        console.log(\"closed\");\n    });\n    w.loadUrl(\"file://\" + __dirname + \"/main1.html\");\n});\n```\n\nmain1.html:\n\n``` html\n<html><head><script>window.location = \"main2.html\";</script></head></html>\n```\n\nmain2.html:\n\n``` html\n<html><head><title>main2</title></head></html>\n```\n\nCalling the `BrowserWindow.close()` method in the `page-title-updated` handler crashes Electron.  I noticed that both the `close` and the `closed` handlers are called before the `close()` method returns.  e.g. This test program outputs:\n\n```\npage-title-updated: title=main2\nclose\nclosed\npage-title-updated: returning\n```\n\nIf I understand correctly, once `atom::NativeWindow::TitleWasSet()` has called the `page-title-updated` handlers, it then calls `atom::NativeWindowViews::SetTitle()`, but the window has been destroyed already (deallocated too?).\n\nI have a stack trace from a version of electron compiled with debug info:\n\n```\nProgram received signal SIGSEGV, Segmentation fault.\n0x00007ffff1fa841b in views::Widget::UpdateWindowTitle() () from /home/rprichard/XXX/electron/out/D/libviews.so\n(gdb) bt\n#0  0x00007ffff1fa841b in views::Widget::UpdateWindowTitle() () from /home/rprichard/XXX/electron/out/D/libviews.so\n#1  0x00000000008cee7d in atom::NativeWindowViews::SetTitle (this=0x2efe5e583800, title=...) at ../../atom/browser/native_window_views.cc:475\n#2  0x00000000008c94c5 in atom::NativeWindow::TitleWasSet (this=0x2efe5e583800, entry=0x2efe5e3da500, explicit_set=true) at ../../atom/browser/native_window.cc:516\n#3  0x00007ffff11f5809 in content::WebContentsImpl::UpdateTitleForEntry(content::NavigationEntryImpl*, std::basic_string<unsigned short, base::string16_char_traits, std::allocator<unsigned short> > const&) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#4  0x00007ffff11f84f2 in content::WebContentsImpl::UpdateTitle(content::RenderFrameHost*, int, std::basic_string<unsigned short, base::string16_char_traits, std::allocator<unsigned short> > const&, base::i18n::TextDirection) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#5  0x00007ffff0feed42 in content::RenderFrameHostImpl::OnMessageReceived(IPC::Message const&) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#6  0x00007ffff1120fce in content::RenderProcessHostImpl::OnMessageReceived(IPC::Message const&) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#7  0x00007ffff6007a72 in IPC::ChannelProxy::Context::OnDispatchMessage(IPC::Message const&) () from /home/rprichard/XXX/electron/out/D/libipc.so\n#8  0x00007ffff5edb018 in base::debug::TaskAnnotator::RunTask(char const*, char const*, base::PendingTask const&) () from /home/rprichard/XXX/electron/out/D/libbase.so\n#9  0x00007ffff5efa081 in base::MessageLoop::RunTask(base::PendingTask const&) () from /home/rprichard/XXX/electron/out/D/libbase.so\n#10 0x00007ffff5efa239 in base::MessageLoop::DeferOrRunPendingTask(base::PendingTask const&) () from /home/rprichard/XXX/electron/out/D/libbase.so\n#11 0x00007ffff5efa4ad in base::MessageLoop::DoWork() () from /home/rprichard/XXX/electron/out/D/libbase.so\n#12 0x00007ffff5ecd49a in ?? () from /home/rprichard/XXX/electron/out/D/libbase.so\n#13 0x00007fffed1a5e04 in g_main_context_dispatch () from /lib/x86_64-linux-gnu/libglib-2.0.so.0\n#14 0x00007fffed1a6048 in ?? () from /lib/x86_64-linux-gnu/libglib-2.0.so.0\n#15 0x00007fffed1a60ec in g_main_context_iteration () from /lib/x86_64-linux-gnu/libglib-2.0.so.0\n#16 0x00007ffff5ecd2c7 in base::MessagePumpGlib::Run(base::MessagePump::Delegate*) () from /home/rprichard/XXX/electron/out/D/libbase.so\n#17 0x00007ffff5f11e40 in base::RunLoop::Run() () from /home/rprichard/XXX/electron/out/D/libbase.so\n#18 0x00007ffff0f4d8eb in content::BrowserMainLoop::MainMessageLoopRun() () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#19 0x00007ffff0f4d830 in content::BrowserMainLoop::RunMainMessageLoopParts() () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#20 0x00007ffff0f505fd in ?? () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#21 0x00007ffff0f48f43 in content::BrowserMain(content::MainFunctionParams const&) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#22 0x00007ffff0ed9d31 in ?? () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#23 0x00007ffff0ed8cb0 in content::ContentMain(content::ContentMainParams const&) () from /home/rprichard/XXX/electron/out/D/libcontent.so\n#24 0x000000000076ee4a in main (argc=2, argv=0x7fffffffdcd8) at ../../atom/app/atom_main.cc:179\n```\n\nInterestingly, sometimes `NativeWindow::RequestToClosePage()` decides to close the window immediately and sometimes it decides to defer the decision, based upon the result of `web_contents()->NeedToFireBeforeUnload()`.  I had another test case that assigned to `document.title` instead of changing the window location, but for some reason, that test case deferred window closing.\n\n``` c++\n  if (web_contents()->NeedToFireBeforeUnload())\n    web_contents()->DispatchBeforeUnload(false);\n  else\n    web_contents()->Close();\n```\n\nI've seen this test case crash on Windows, Linux, and OS X.  It didn't always crash on OS X, and on Windows, the only evidence of a crash was that the `Parent` and `Child` windows were both closed.  I've tested both with the current `master` version and with `0.34.3`.\n","closed_by":{"login":"zcbenz","id":639601,"node_id":"MDQ6VXNlcjYzOTYwMQ==","avatar_url":"https://avatars.githubusercontent.com/u/639601?v=4","gravatar_id":"","url":"https://api.github.com/users/zcbenz","html_url":"https://github.com/zcbenz","followers_url":"https://api.github.com/users/zcbenz/followers","following_url":"https://api.github.com/users/zcbenz/following{/other_user}","gists_url":"https://api.github.com/users/zcbenz/gists{/gist_id}","starred_url":"https://api.github.com/users/zcbenz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zcbenz/subscriptions","organizations_url":"https://api.github.com/users/zcbenz/orgs","repos_url":"https://api.github.com/users/zcbenz/repos","events_url":"https://api.github.com/users/zcbenz/events{/privacy}","received_events_url":"https://api.github.com/users/zcbenz/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/3380/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/3380/timeline","performed_via_github_app":null,"state_reason":"completed"}