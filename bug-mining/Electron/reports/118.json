{"url":"https://api.github.com/repos/electron/electron/issues/40461","repository_url":"https://api.github.com/repos/electron/electron","labels_url":"https://api.github.com/repos/electron/electron/issues/40461/labels{/name}","comments_url":"https://api.github.com/repos/electron/electron/issues/40461/comments","events_url":"https://api.github.com/repos/electron/electron/issues/40461/events","html_url":"https://github.com/electron/electron/issues/40461","id":1980021763,"node_id":"I_kwDOAI8xS852BLwD","number":40461,"title":"[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification","user":{"login":"taoky","id":2109893,"node_id":"MDQ6VXNlcjIxMDk4OTM=","avatar_url":"https://avatars.githubusercontent.com/u/2109893?v=4","gravatar_id":"","url":"https://api.github.com/users/taoky","html_url":"https://github.com/taoky","followers_url":"https://api.github.com/users/taoky/followers","following_url":"https://api.github.com/users/taoky/following{/other_user}","gists_url":"https://api.github.com/users/taoky/gists{/gist_id}","starred_url":"https://api.github.com/users/taoky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/taoky/subscriptions","organizations_url":"https://api.github.com/users/taoky/orgs","repos_url":"https://api.github.com/users/taoky/repos","events_url":"https://api.github.com/users/taoky/events{/privacy}","received_events_url":"https://api.github.com/users/taoky/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":97403642,"node_id":"MDU6TGFiZWw5NzQwMzY0Mg==","url":"https://api.github.com/repos/electron/electron/labels/platform/linux","name":"platform/linux","color":"c7def8","default":false,"description":null},{"id":520323169,"node_id":"MDU6TGFiZWw1MjAzMjMxNjk=","url":"https://api.github.com/repos/electron/electron/labels/bug%20:beetle:","name":"bug :beetle:","color":"fbca04","default":false,"description":""},{"id":544279309,"node_id":"MDU6TGFiZWw1NDQyNzkzMDk=","url":"https://api.github.com/repos/electron/electron/labels/component/notifications","name":"component/notifications","color":"f9d0c4","default":false,"description":null},{"id":5853006986,"node_id":"LA_kwDOAI8xS88AAAABXN3Mig","url":"https://api.github.com/repos/electron/electron/labels/27-x-y","name":"27-x-y","color":"ededed","default":false,"description":""},{"id":6072115998,"node_id":"LA_kwDOAI8xS88AAAABae0jHg","url":"https://api.github.com/repos/electron/electron/labels/28-x-y","name":"28-x-y","color":"ededed","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2023-11-06T20:39:53Z","updated_at":"2024-04-07T12:10:31Z","closed_at":"2024-03-27T09:53:24Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227","closed_by":{"login":"codebytere","id":2036040,"node_id":"MDQ6VXNlcjIwMzYwNDA=","avatar_url":"https://avatars.githubusercontent.com/u/2036040?v=4","gravatar_id":"","url":"https://api.github.com/users/codebytere","html_url":"https://github.com/codebytere","followers_url":"https://api.github.com/users/codebytere/followers","following_url":"https://api.github.com/users/codebytere/following{/other_user}","gists_url":"https://api.github.com/users/codebytere/gists{/gist_id}","starred_url":"https://api.github.com/users/codebytere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/codebytere/subscriptions","organizations_url":"https://api.github.com/users/codebytere/orgs","repos_url":"https://api.github.com/users/codebytere/repos","events_url":"https://api.github.com/users/codebytere/events{/privacy}","received_events_url":"https://api.github.com/users/codebytere/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/electron/electron/issues/40461/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/electron/electron/issues/40461/timeline","performed_via_github_app":null,"state_reason":"completed"}